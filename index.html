<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UC4 SysEx Editor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Orbitron:wght@400;500;700&display=swap');
        
        :root {
            --bg-dark: #0a0a0c;
            --bg-panel: #111114;
            --bg-control: #18181c;
            --bg-input: #1e1e24;
            --border: #2a2a32;
            --border-light: #3a3a44;
            --text: #e0e0e8;
            --text-dim: #888898;
            --text-muted: #555560;
            --accent: #00d4aa;
            --accent-dim: #00a888;
            --warning: #ffaa00;
            --error: #ff4466;
            --encoder: #00aaff;
            --push: #aa66ff;
            --green-btn: #44dd66;
            --fader: #ff8844;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.4;
        }
        
        /* Header */
        .header {
            background: linear-gradient(180deg, var(--bg-panel) 0%, var(--bg-dark) 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        
        .logo span {
            color: var(--text-dim);
            font-weight: 400;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-control);
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--bg-dark);
            border-color: var(--accent);
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: var(--accent-dim);
            border-color: var(--accent-dim);
            color: var(--bg-dark);
        }
        
        /* Navigation */
        .nav-bar {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .nav-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .select-wrapper {
            position: relative;
        }
        
        select {
            font-family: inherit;
            font-size: 0.8rem;
            padding: 0.4rem 2rem 0.4rem 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text);
            cursor: pointer;
            appearance: none;
            min-width: 100px;
        }
        
        select:hover, select:focus {
            border-color: var(--accent);
            outline: none;
        }
        
        .select-wrapper::after {
            content: 'â–¾';
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            pointer-events: none;
            font-size: 0.7rem;
        }
        
        .group-tabs {
            display: flex;
            gap: 2px;
        }
        
        .group-tab {
            font-family: inherit;
            font-size: 0.75rem;
            width: 2rem;
            height: 2rem;
            border: 1px solid var(--border);
            background: var(--bg-control);
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .group-tab:hover {
            border-color: var(--accent);
            color: var(--text);
        }
        
        .group-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-dark);
            font-weight: 600;
        }
        
        .group-name-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--accent);
            padding: 0.4rem 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            min-width: 4rem;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            padding: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .no-data {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .no-data h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--text-dim);
            margin-bottom: 1rem;
        }
        
        .no-data p {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        /* Control Sections */
        .control-section {
            margin-bottom: 2rem;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .section-title.encoders { color: var(--encoder); }
        .section-title.push { color: var(--push); }
        .section-title.green { color: var(--green-btn); }
        .section-title.faders { color: var(--fader); }
        
        .section-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-control);
            border: 1px solid var(--border);
            color: var(--text-dim);
        }
        
        /* Control Grid */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .control-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 0.75rem;
            transition: border-color 0.15s;
        }
        
        .control-card:hover {
            border-color: var(--border-light);
        }
        
        .control-card.encoder { border-left: 3px solid var(--encoder); }
        .control-card.push { border-left: 3px solid var(--push); }
        .control-card.green { border-left: 3px solid var(--green-btn); }
        .control-card.fader { border-left: 3px solid var(--fader); }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .control-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .control-index {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        
        .param-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.4rem;
            gap: 0.5rem;
        }
        
        .param-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            width: 3.5rem;
            flex-shrink: 0;
            text-transform: uppercase;
        }
        
        .param-input {
            flex: 1;
        }
        
        .param-input input,
        .param-input select {
            width: 100%;
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.3rem 0.5rem;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text);
        }
        
        .param-input input:focus,
        .param-input select:focus {
            border-color: var(--accent);
            outline: none;
        }
        
        .param-input input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .param-input input::-webkit-outer-spin-button,
        .param-input input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Fader 9 Special */
        .fader9-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-left: 3px solid var(--fader);
            padding: 0.75rem;
            margin-top: 1rem;
        }
        
        .fader9-card .control-header {
            background: linear-gradient(90deg, rgba(255,136,68,0.1) 0%, transparent 100%);
            margin: -0.75rem -0.75rem 0.75rem -0.75rem;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        
        .status-dot.loaded {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }
        
        .status-dot.modified {
            background: var(--warning);
            box-shadow: 0 0 8px var(--warning);
        }
        
        /* Warnings */
        .warning-badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            background: rgba(255, 170, 0, 0.2);
            border: 1px solid var(--warning);
            color: var(--warning);
            margin-left: 0.5rem;
        }
        
        /* Hidden file input */
        .hidden-input {
            display: none;
        }
        
        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 2px;
        }
        
        .view-btn {
            font-family: inherit;
            font-size: 0.7rem;
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg-control);
            color: var(--text-dim);
            cursor: pointer;
        }
        
        .view-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }
        
        .view-btn.active {
            background: var(--bg-input);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-bar {
                flex-direction: column;
                gap: 1rem;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }
        
        /* Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">UC4 <span>SysEx Editor</span></div>
        <div class="file-actions">
            <input type="file" id="sysexInput" accept=".syx" class="hidden-input">
            <button class="btn" onclick="document.getElementById('sysexInput').click()">Import SysEx</button>
            <button class="btn" id="exportBtn" onclick="exportSysEx()" disabled>Export SysEx</button>
            <input type="file" id="jsonInput" accept=".json" class="hidden-input">
            <button class="btn" onclick="document.getElementById('jsonInput').click()">Import JSON</button>
            <button class="btn" id="exportJsonBtn" onclick="exportJSON()" disabled>Export JSON</button>
        </div>
    </header>
    
    <nav class="nav-bar">
        <div class="nav-section">
            <span class="nav-label">Setup</span>
            <div class="select-wrapper">
                <select id="setupSelect" onchange="selectSetup(this.value)" disabled>
                    <option value="">--</option>
                </select>
            </div>
        </div>
        
        <div class="nav-section">
            <span class="nav-label">Encoder Grp</span>
            <div class="group-tabs" id="encoderGroupTabs">
                <!-- Generated by JS -->
            </div>
            <div class="group-name-display" id="encoderGroupName">----</div>
        </div>
        
        <div class="nav-section">
            <span class="nav-label">Fader/Btn Grp</span>
            <div class="group-tabs" id="faderGroupTabs">
                <!-- Generated by JS -->
            </div>
            <div class="group-name-display" id="faderGroupName">----</div>
        </div>
        
        <div class="nav-section" style="margin-left: auto;">
            <div class="view-toggle">
                <button class="view-btn active" id="focusedViewBtn" onclick="setView('focused')">Focused</button>
                <button class="view-btn" id="overviewBtn" onclick="setView('overview')">Overview</button>
            </div>
        </div>
    </nav>
    
    <main class="main-content" id="mainContent">
        <div class="no-data">
            <h2>No SysEx Data Loaded</h2>
            <p>Import a UC4 SysEx dump to begin editing.</p>
            <p>Expected file size: 100,640 bytes (all 18 setups)</p>
        </div>
    </main>
    
    <footer class="status-bar">
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">No data loaded</span>
        </div>
        <div>
            <span id="fileInfo">--</span>
        </div>
    </footer>

    <script>
        // ============================================================
        // UC4 SysEx Editor - Core Logic
        // ============================================================
        
        // State
        let rawBuffer = null;
        let sectionIndex = null;
        let currentSetup = 0;
        let encoderGroup = 0;
        let faderGroup = 0;
        let currentView = 'focused';
        let isModified = false;
        let dirtyBanks = new Set();
        
        // Constants
        const EXPECTED_SIZE = 100640;
        const NUM_SETUPS = 18;
        const NUM_GROUPS = 8;
        
        // Section IDs
        const SECTIONS = {
            ENCODER_CHAN_TYPE: 0x1C,
            ENCODER_ACC_DISP: 0x1D,
            PUSH_CHAN_TYPE: 0x1D,
            PUSH_CC: 0x1D,
            PUSH_LOWER: 0x1D,
            PUSH_UPPER: 0x1E,
            PUSH_MODE: 0x1E,
            GREEN_CHAN_TYPE: 0x1E,
            GREEN_CC: 0x1E,
            GREEN_LOWER: 0x1F,
            GREEN_UPPER: 0x1F,
            GREEN_MODE: 0x1F,
            FADER_CHAN_TYPE: 0x1F,
            FADER_CC: 0x20,
            FADER_MIN: 0x20,
            FADER_MAX: 0x20,
            FADER_MODE: 0x20,
            FADER9: 0x17,
            GROUP_NAMES: 0x14
        };
        
        const BANKS = {
            ENC_CHAN_TYPE: 0x00,
            ENC_CC: 0x40,
            ENC_MIN: 0x80,
            ENC_MAX: 0xC0,
            ENC_ACC_DISP: 0x00,
            PUSH_CHAN_TYPE: 0x40,
            PUSH_CC: 0x80,
            PUSH_LOWER: 0xC0,
            PUSH_UPPER: 0x00,
            PUSH_MODE: 0x40,
            GREEN_CHAN_TYPE: 0x80,
            GREEN_CC: 0xC0,
            GREEN_LOWER: 0x00,
            GREEN_UPPER: 0x40,
            GREEN_MODE: 0x80,
            FADER_CHAN_TYPE: 0xC0,
            FADER_CC: 0x00,
            FADER_MIN: 0x40,
            FADER_MAX: 0x80,
            FADER_MODE: 0xC0,
            FADER9: 0x00,
            GROUP_NAMES: 0x80
        };
        
        // Type definitions
        const ENCODER_TYPES = ['CCr1', 'CCr2', 'CCAb', 'PrGC', 'CCAh', 'Pbnd', 'AFtt'];
        const FADER_TYPES = ['CCAb', 'PrGC', 'Pbnd', 'AFtt'];
        const BUTTON_TYPES = {0x00: 'OFF', 0x10: 'Note', 0x20: 'CC', 0x30: 'PrGC', 0x40: 'AFtt'};
        const BUTTON_TYPE_VALUES = [0x00, 0x10, 0x20, 0x30, 0x40];
        const ACC_MODES = ['Acc0', 'Acc1', 'Acc2', 'Acc3'];
        const DISPLAY_MODES = ['OFF', 'Std', 'bPoL'];
        const BUTTON_DISPLAY_MODES = ['OFF', 'Std'];
        const GREEN_DISPLAY_MODES = ['OFF', 'Std', 'EXt'];
        const BUTTON_MODES = ['Momentary', 'Toggle'];
        const FADER_MODES = ['Jump', 'Snap'];
        
        // ============================================================
        // SysEx Parsing
        // ============================================================
        
        function decodeValue(buf, offset, idx) {
            const pos = offset + idx * 3;
            if (pos + 2 >= buf.length || buf[pos] !== 0x4D) return null;
            return ((buf[pos + 1] & 0x0F) << 4) | (buf[pos + 2] & 0x0F);
        }
        
        function encodeValue(buf, offset, idx, value) {
            const pos = offset + idx * 3;
            buf[pos] = 0x4D;
            buf[pos + 1] = 0x20 | ((value >> 4) & 0x0F);
            buf[pos + 2] = 0x10 | (value & 0x0F);
        }
        
        function buildIndex(buf) {
            const occ = {};
            
            for (let i = 0; i < buf.length - 10; i++) {
                if (buf[i] === 0x49 && (i === 0 || buf[i-1] !== 0x4D) && buf[i+3] === 0x4A) {
                    const secId = ((buf[i+1] & 0x0F) << 4) | (buf[i+2] & 0x0F);
                    const bank = ((buf[i+4] & 0x0F) << 4) | (buf[i+5] & 0x0F);
                    const dataOffset = i + 6;
                    
                    let pos = dataOffset;
                    while (pos < buf.length && buf[pos] === 0x4D) pos += 3;
                    const valueCount = (pos - dataOffset) / 3;
                    const checksumOffset = pos;
                    
                    if (!occ[secId]) occ[secId] = {};
                    if (!occ[secId][bank]) occ[secId][bank] = [];
                    occ[secId][bank].push({ dataOffset, valueCount, checksumOffset });
                }
            }
            
            const index = [];
            for (let setupIdx = 0; setupIdx < NUM_SETUPS; setupIdx++) {
                index[setupIdx] = {};
                for (const secId in occ) {
                    index[setupIdx][secId] = {};
                    for (const bank in occ[secId]) {
                        if (occ[secId][bank][setupIdx]) {
                            index[setupIdx][secId][bank] = occ[secId][bank][setupIdx];
                        }
                    }
                }
            }
            
            return index;
        }
        
        function recalcBankChecksum(buf, dataStart) {
            let sum = 0;
            let pos = dataStart;
            
            while (pos < buf.length && buf[pos] === 0x4D) {
                sum += ((buf[pos + 1] & 0x0F) << 4) | (buf[pos + 2] & 0x0F);
                pos += 3;
            }
            
            sum = sum & 0xFFFF;
            
            if (pos + 5 < buf.length && buf[pos] === 0x4B && buf[pos + 3] === 0x4C) {
                buf[pos + 1] = 0x20 | ((sum >> 12) & 0x0F);
                buf[pos + 2] = 0x10 | ((sum >> 8) & 0x0F);
                buf[pos + 4] = 0x20 | ((sum >> 4) & 0x0F);
                buf[pos + 5] = 0x10 | (sum & 0x0F);
            }
        }
        
        function getValue(setupIdx, secId, bank, valueIdx) {
            if (!sectionIndex || !sectionIndex[setupIdx]) return null;
            const sec = sectionIndex[setupIdx][secId];
            if (!sec) return null;
            const bnk = sec[bank];
            if (!bnk) return null;
            return decodeValue(rawBuffer, bnk.dataOffset, valueIdx);
        }
        
        function setValue(setupIdx, secId, bank, valueIdx, value) {
            if (!sectionIndex || !sectionIndex[setupIdx]) return;
            const sec = sectionIndex[setupIdx][secId];
            if (!sec) return;
            const bnk = sec[bank];
            if (!bnk) return;
            
            encodeValue(rawBuffer, bnk.dataOffset, valueIdx, value);
            dirtyBanks.add(`${setupIdx}-${secId}-${bank}`);
            markModified();
        }
        
        // ============================================================
        // Control Value Helpers
        // ============================================================
        
        function getEncoderData(setupIdx, group, enc) {
            const idx = group * 8 + enc;
            const chanType = getValue(setupIdx, 0x1C, 0x00, idx) || 0x20;
            const accDisp = getValue(setupIdx, 0x1D, 0x00, idx) || 0x31;
            
            return {
                channel: (chanType & 0x0F) + 1,
                type: (chanType >> 4) & 0x0F,
                cc: getValue(setupIdx, 0x1C, 0x40, idx) || 0,
                min: getValue(setupIdx, 0x1C, 0x80, idx) || 0,
                max: getValue(setupIdx, 0x1C, 0xC0, idx) || 127,
                acc: (accDisp >> 4) & 0x0F,
                display: accDisp & 0x0F
            };
        }
        
        function setEncoderData(setupIdx, group, enc, data) {
            const idx = group * 8 + enc;
            const chanType = ((data.type & 0x0F) << 4) | ((data.channel - 1) & 0x0F);
            const accDisp = ((data.acc & 0x0F) << 4) | (data.display & 0x0F);
            
            setValue(setupIdx, 0x1C, 0x00, idx, chanType);
            setValue(setupIdx, 0x1C, 0x40, idx, data.cc);
            setValue(setupIdx, 0x1C, 0x80, idx, data.min);
            setValue(setupIdx, 0x1C, 0xC0, idx, data.max);
            setValue(setupIdx, 0x1D, 0x00, idx, accDisp);
        }
        
        function getPushData(setupIdx, group, btn) {
            const idx = group * 8 + btn;
            const chanType = getValue(setupIdx, 0x1D, 0x40, idx) || 0x10;
            const modeDisp = getValue(setupIdx, 0x1E, 0x40, idx) || 0x00;
            
            return {
                channel: (chanType & 0x0F) + 1,
                typeNibble: chanType & 0xF0,
                cc: getValue(setupIdx, 0x1D, 0x80, idx) || 0,
                lower: getValue(setupIdx, 0x1D, 0xC0, idx) || 0,
                upper: getValue(setupIdx, 0x1E, 0x00, idx) || 127,
                mode: (modeDisp & 0x10) ? 1 : 0,
                display: modeDisp & 0x0F
            };
        }
        
        function setPushData(setupIdx, group, btn, data) {
            const idx = group * 8 + btn;
            const chanType = (data.typeNibble & 0xF0) | ((data.channel - 1) & 0x0F);
            const modeDisp = (data.mode ? 0x10 : 0x00) | (data.display & 0x0F);
            
            setValue(setupIdx, 0x1D, 0x40, idx, chanType);
            setValue(setupIdx, 0x1D, 0x80, idx, data.cc);
            setValue(setupIdx, 0x1D, 0xC0, idx, data.lower);
            setValue(setupIdx, 0x1E, 0x00, idx, data.upper);
            setValue(setupIdx, 0x1E, 0x40, idx, modeDisp);
        }
        
        function getGreenData(setupIdx, group, btn) {
            const idx = group * 8 + btn;
            const chanType = getValue(setupIdx, 0x1E, 0x80, idx) || 0x10;
            const modeDisp = getValue(setupIdx, 0x1F, 0x80, idx) || 0x01;
            
            return {
                channel: (chanType & 0x0F) + 1,
                typeNibble: chanType & 0xF0,
                cc: getValue(setupIdx, 0x1E, 0xC0, idx) || 64,
                lower: getValue(setupIdx, 0x1F, 0x00, idx) || 0,
                upper: getValue(setupIdx, 0x1F, 0x40, idx) || 127,
                mode: (modeDisp & 0x10) ? 1 : 0,
                display: modeDisp & 0x0F
            };
        }
        
        function setGreenData(setupIdx, group, btn, data) {
            const idx = group * 8 + btn;
            const chanType = (data.typeNibble & 0xF0) | ((data.channel - 1) & 0x0F);
            const modeDisp = (data.mode ? 0x10 : 0x00) | (data.display & 0x0F);
            
            setValue(setupIdx, 0x1E, 0x80, idx, chanType);
            setValue(setupIdx, 0x1E, 0xC0, idx, data.cc);
            setValue(setupIdx, 0x1F, 0x00, idx, data.lower);
            setValue(setupIdx, 0x1F, 0x40, idx, data.upper);
            setValue(setupIdx, 0x1F, 0x80, idx, modeDisp);
        }
        
        function getFaderData(setupIdx, group, fader) {
            const idx = group * 8 + fader;
            const chanType = getValue(setupIdx, 0x1F, 0xC0, idx) || 0x00;
            const modeDisp = getValue(setupIdx, 0x20, 0xC0, idx) || 0x01;
            
            return {
                channel: (chanType & 0x0F) + 1,
                type: (chanType >> 4) & 0x0F,
                cc: getValue(setupIdx, 0x20, 0x00, idx) || 32,
                min: getValue(setupIdx, 0x20, 0x40, idx) || 0,
                max: getValue(setupIdx, 0x20, 0x80, idx) || 127,
                mode: (modeDisp & 0x10) ? 1 : 0,
                display: modeDisp & 0x0F
            };
        }
        
        function setFaderData(setupIdx, group, fader, data) {
            const idx = group * 8 + fader;
            const chanType = ((data.type & 0x0F) << 4) | ((data.channel - 1) & 0x0F);
            const modeDisp = (data.mode ? 0x10 : 0x00) | (data.display & 0x0F);
            
            setValue(setupIdx, 0x1F, 0xC0, idx, chanType);
            setValue(setupIdx, 0x20, 0x00, idx, data.cc);
            setValue(setupIdx, 0x20, 0x40, idx, data.min);
            setValue(setupIdx, 0x20, 0x80, idx, data.max);
            setValue(setupIdx, 0x20, 0xC0, idx, modeDisp);
        }
        
        function getFader9Data(setupIdx, group) {
            // Fader 9: 5 values per group in section 0x17 bank 0x00
            const baseIdx = group * 5;
            const modeVal = getValue(setupIdx, 0x17, 0x00, baseIdx + 4) || 1;
            
            return {
                channel: (getValue(setupIdx, 0x17, 0x00, baseIdx) || 0) + 1,
                cc: getValue(setupIdx, 0x17, 0x00, baseIdx + 1) || 112,
                min: getValue(setupIdx, 0x17, 0x00, baseIdx + 2) || 0,
                max: getValue(setupIdx, 0x17, 0x00, baseIdx + 3) || 127,
                mode: (modeVal & 0x10) ? 1 : 0
            };
        }
        
        function setFader9Data(setupIdx, group, data) {
            const baseIdx = group * 5;
            const modeVal = data.mode ? 0x11 : 0x01;
            
            setValue(setupIdx, 0x17, 0x00, baseIdx, (data.channel - 1) & 0x0F);
            setValue(setupIdx, 0x17, 0x00, baseIdx + 1, data.cc);
            setValue(setupIdx, 0x17, 0x00, baseIdx + 2, data.min);
            setValue(setupIdx, 0x17, 0x00, baseIdx + 3, data.max);
            setValue(setupIdx, 0x17, 0x00, baseIdx + 4, modeVal);
        }
        
        function getGroupName(setupIdx, group) {
            // 4 characters per group, 32 total values
            const baseIdx = group * 4;
            let name = '';
            for (let i = 0; i < 4; i++) {
                const val = getValue(setupIdx, 0x14, 0x80, baseIdx + i);
                if (val !== null) {
                    // Simple 7-seg decode (approximate)
                    name += decode7Seg(val);
                } else {
                    name += '?';
                }
            }
            return name;
        }
        
        function decode7Seg(val) {
            // Approximate 7-segment character mapping
            const map = {
                0: '0', 1: '1', 2: '2', 3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 8: '8', 9: '9',
                10: 'A', 11: 'b', 12: 'C', 13: 'd', 14: 'E', 15: 'F', 16: 'G', 17: 'H',
                18: 'I', 19: 'J', 20: 'L', 21: 'n', 22: 'O', 23: 'P', 24: 'r', 25: 'S',
                26: 't', 27: 'U', 28: 'Y', 29: '-', 30: '_', 31: ' '
            };
            return map[val] || String.fromCharCode(val > 31 && val < 127 ? val : 63);
        }
        
        // ============================================================
        // UI Rendering
        // ============================================================
        
        function initUI() {
            // Generate group tabs
            for (let i = 0; i < NUM_GROUPS; i++) {
                const encTab = document.createElement('button');
                encTab.className = 'group-tab' + (i === 0 ? ' active' : '');
                encTab.textContent = i + 1;
                encTab.onclick = () => selectEncoderGroup(i);
                document.getElementById('encoderGroupTabs').appendChild(encTab);
                
                const fadTab = document.createElement('button');
                fadTab.className = 'group-tab' + (i === 0 ? ' active' : '');
                fadTab.textContent = i + 1;
                fadTab.onclick = () => selectFaderGroup(i);
                document.getElementById('faderGroupTabs').appendChild(fadTab);
            }
            
            // Populate setup dropdown
            const setupSelect = document.getElementById('setupSelect');
            for (let i = 0; i < NUM_SETUPS; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                if (i < 16) {
                    opt.textContent = `Setup ${i + 1}`;
                } else if (i === 16) {
                    opt.textContent = 'Setup 17 (Ableton 1-8)';
                } else {
                    opt.textContent = 'Setup 18 (Ableton 9-16)';
                }
                setupSelect.appendChild(opt);
            }
        }
        
        function renderFocusedView() {
            const main = document.getElementById('mainContent');
            main.innerHTML = '';
            
            // Encoders section (uses encoder group)
            const encSection = createSection('Encoders', 'encoders', `Group ${encoderGroup + 1}`);
            const encGrid = document.createElement('div');
            encGrid.className = 'control-grid';
            
            for (let i = 0; i < 8; i++) {
                encGrid.appendChild(createEncoderCard(i));
            }
            encSection.appendChild(encGrid);
            main.appendChild(encSection);
            
            // Push Buttons section (uses encoder group - they're on the encoders)
            const pushSection = createSection('Push Buttons', 'push', `Group ${encoderGroup + 1}`);
            const pushGrid = document.createElement('div');
            pushGrid.className = 'control-grid';
            
            for (let i = 0; i < 8; i++) {
                pushGrid.appendChild(createPushCard(i));
            }
            pushSection.appendChild(pushGrid);
            main.appendChild(pushSection);
            
            // Green Buttons section (uses fader group)
            const greenSection = createSection('Green Buttons', 'green', `Group ${faderGroup + 1}`);
            const greenGrid = document.createElement('div');
            greenGrid.className = 'control-grid';
            
            for (let i = 0; i < 8; i++) {
                greenGrid.appendChild(createGreenCard(i));
            }
            greenSection.appendChild(greenGrid);
            main.appendChild(greenSection);
            
            // Faders section (uses fader group)
            const faderSection = createSection('Faders', 'faders', `Group ${faderGroup + 1}`);
            const faderGrid = document.createElement('div');
            faderGrid.className = 'control-grid';
            
            for (let i = 0; i < 8; i++) {
                faderGrid.appendChild(createFaderCard(i));
            }
            faderSection.appendChild(faderGrid);
            
            // Fader 9
            faderSection.appendChild(createFader9Card());
            
            main.appendChild(faderSection);
        }
        
        function createSection(title, className, badge) {
            const section = document.createElement('section');
            section.className = 'control-section';
            
            const header = document.createElement('div');
            header.className = 'section-header';
            
            const h2 = document.createElement('h2');
            h2.className = 'section-title ' + className;
            h2.textContent = title;
            header.appendChild(h2);
            
            const span = document.createElement('span');
            span.className = 'section-badge';
            span.textContent = badge;
            header.appendChild(span);
            
            section.appendChild(header);
            return section;
        }
        
        function createEncoderCard(idx) {
            const data = getEncoderData(currentSetup, encoderGroup, idx);
            const card = document.createElement('div');
            card.className = 'control-card encoder';
            
            card.innerHTML = `
                <div class="control-header">
                    <span class="control-name">Encoder ${idx + 1}</span>
                    <span class="control-index">E${encoderGroup + 1}.${idx + 1}</span>
                </div>
                <div class="param-row">
                    <span class="param-label">Chan</span>
                    <div class="param-input">
                        <select data-param="channel" onchange="updateEncoder(${idx}, 'channel', this.value)">
                            ${Array.from({length: 16}, (_, i) => 
                                `<option value="${i + 1}" ${data.channel === i + 1 ? 'selected' : ''}>${i + 1}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">CC</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.cc}" 
                            onchange="updateEncoder(${idx}, 'cc', this.value)">
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Type</span>
                    <div class="param-input">
                        <select onchange="updateEncoder(${idx}, 'type', this.value)">
                            ${ENCODER_TYPES.map((t, i) => 
                                `<option value="${i}" ${data.type === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Acc</span>
                    <div class="param-input">
                        <select onchange="updateEncoder(${idx}, 'acc', this.value)">
                            ${ACC_MODES.map((t, i) => 
                                `<option value="${i}" ${data.acc === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Disp</span>
                    <div class="param-input">
                        <select onchange="updateEncoder(${idx}, 'display', this.value)">
                            ${DISPLAY_MODES.map((t, i) => 
                                `<option value="${i}" ${data.display === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Min</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.min}" 
                            onchange="updateEncoder(${idx}, 'min', this.value)">
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Max</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.max}" 
                            onchange="updateEncoder(${idx}, 'max', this.value)">
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function createPushCard(idx) {
            const data = getPushData(currentSetup, encoderGroup, idx);
            const card = document.createElement('div');
            card.className = 'control-card push';
            
            card.innerHTML = `
                <div class="control-header">
                    <span class="control-name">Push ${idx + 1}</span>
                    <span class="control-index">P${encoderGroup + 1}.${idx + 1}</span>
                </div>
                <div class="param-row">
                    <span class="param-label">Chan</span>
                    <div class="param-input">
                        <select onchange="updatePush(${idx}, 'channel', this.value)">
                            ${Array.from({length: 16}, (_, i) => 
                                `<option value="${i + 1}" ${data.channel === i + 1 ? 'selected' : ''}>${i + 1}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Note</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.cc}" 
                            onchange="updatePush(${idx}, 'cc', this.value)">
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Type</span>
                    <div class="param-input">
                        <select onchange="updatePush(${idx}, 'typeNibble', this.value)">
                            ${BUTTON_TYPE_VALUES.map(v => 
                                `<option value="${v}" ${data.typeNibble === v ? 'selected' : ''}>${BUTTON_TYPES[v]}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Mode</span>
                    <div class="param-input">
                        <select onchange="updatePush(${idx}, 'mode', this.value)">
                            ${BUTTON_MODES.map((t, i) => 
                                `<option value="${i}" ${data.mode === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Lo</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.lower}" 
                            onchange="updatePush(${idx}, 'lower', this.value)">
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Hi</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.upper}" 
                            onchange="updatePush(${idx}, 'upper', this.value)">
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function createGreenCard(idx) {
            const data = getGreenData(currentSetup, faderGroup, idx);
            const card = document.createElement('div');
            card.className = 'control-card green';
            
            card.innerHTML = `
                <div class="control-header">
                    <span class="control-name">Button ${idx + 1}</span>
                    <span class="control-index">B${faderGroup + 1}.${idx + 1}</span>
                </div>
                <div class="param-row">
                    <span class="param-label">Chan</span>
                    <div class="param-input">
                        <select onchange="updateGreen(${idx}, 'channel', this.value)">
                            ${Array.from({length: 16}, (_, i) => 
                                `<option value="${i + 1}" ${data.channel === i + 1 ? 'selected' : ''}>${i + 1}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Note</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.cc}" 
                            onchange="updateGreen(${idx}, 'cc', this.value)">
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Type</span>
                    <div class="param-input">
                        <select onchange="updateGreen(${idx}, 'typeNibble', this.value)">
                            ${BUTTON_TYPE_VALUES.map(v => 
                                `<option value="${v}" ${data.typeNibble === v ? 'selected' : ''}>${BUTTON_TYPES[v]}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Mode</span>
                    <div class="param-input">
                        <select onchange="updateGreen(${idx}, 'mode', this.value)">
                            ${BUTTON_MODES.map((t, i) => 
                                `<option value="${i}" ${data.mode === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">LED</span>
                    <div class="param-input">
                        <select onchange="updateGreen(${idx}, 'display', this.value)">
                            ${GREEN_DISPLAY_MODES.map((t, i) => 
                                `<option value="${i}" ${data.display === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Lo</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.lower}" 
                            onchange="updateGreen(${idx}, 'lower', this.value)">
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Hi</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.upper}" 
                            onchange="updateGreen(${idx}, 'upper', this.value)">
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function createFaderCard(idx) {
            const data = getFaderData(currentSetup, faderGroup, idx);
            const card = document.createElement('div');
            card.className = 'control-card fader';
            
            card.innerHTML = `
                <div class="control-header">
                    <span class="control-name">Fader ${idx + 1}</span>
                    <span class="control-index">F${faderGroup + 1}.${idx + 1}</span>
                </div>
                <div class="param-row">
                    <span class="param-label">Chan</span>
                    <div class="param-input">
                        <select onchange="updateFader(${idx}, 'channel', this.value)">
                            ${Array.from({length: 16}, (_, i) => 
                                `<option value="${i + 1}" ${data.channel === i + 1 ? 'selected' : ''}>${i + 1}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">CC</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.cc}" 
                            onchange="updateFader(${idx}, 'cc', this.value)">
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Type</span>
                    <div class="param-input">
                        <select onchange="updateFader(${idx}, 'type', this.value)">
                            ${FADER_TYPES.map((t, i) => 
                                `<option value="${i}" ${data.type === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Mode</span>
                    <div class="param-input">
                        <select onchange="updateFader(${idx}, 'mode', this.value)">
                            ${FADER_MODES.map((t, i) => 
                                `<option value="${i}" ${data.mode === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Disp</span>
                    <div class="param-input">
                        <select onchange="updateFader(${idx}, 'display', this.value)">
                            ${DISPLAY_MODES.map((t, i) => 
                                `<option value="${i}" ${data.display === i ? 'selected' : ''}>${t}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Min</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.min}" 
                            onchange="updateFader(${idx}, 'min', this.value)">
                    </div>
                </div>
                <div class="param-row">
                    <span class="param-label">Max</span>
                    <div class="param-input">
                        <input type="number" min="0" max="127" value="${data.max}" 
                            onchange="updateFader(${idx}, 'max', this.value)">
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function createFader9Card() {
            const data = getFader9Data(currentSetup, faderGroup);
            const card = document.createElement('div');
            card.className = 'fader9-card';
            
            card.innerHTML = `
                <div class="control-header">
                    <span class="control-name">Fader 9</span>
                    <span class="control-index">F${faderGroup + 1}.9</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem;">
                    <div class="param-row">
                        <span class="param-label">Chan</span>
                        <div class="param-input">
                            <select onchange="updateFader9('channel', this.value)">
                                ${Array.from({length: 16}, (_, i) => 
                                    `<option value="${i + 1}" ${data.channel === i + 1 ? 'selected' : ''}>${i + 1}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="param-row">
                        <span class="param-label">CC</span>
                        <div class="param-input">
                            <input type="number" min="0" max="127" value="${data.cc}" 
                                onchange="updateFader9('cc', this.value)">
                        </div>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Mode</span>
                        <div class="param-input">
                            <select onchange="updateFader9('mode', this.value)">
                                ${FADER_MODES.map((t, i) => 
                                    `<option value="${i}" ${data.mode === i ? 'selected' : ''}>${t}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Min</span>
                        <div class="param-input">
                            <input type="number" min="0" max="127" value="${data.min}" 
                                onchange="updateFader9('min', this.value)">
                        </div>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Max</span>
                        <div class="param-input">
                            <input type="number" min="0" max="127" value="${data.max}" 
                                onchange="updateFader9('max', this.value)">
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function renderOverview() {
            const main = document.getElementById('mainContent');
            main.innerHTML = '<div class="no-data"><h2>Overview Mode</h2><p>Coming soon - shows all 8 groups at once for comparison</p></div>';
        }
        
        // ============================================================
        // Update Functions
        // ============================================================
        
        function updateEncoder(idx, param, value) {
            const data = getEncoderData(currentSetup, encoderGroup, idx);
            data[param] = parseInt(value);
            setEncoderData(currentSetup, encoderGroup, idx, data);
        }
        
        function updatePush(idx, param, value) {
            const data = getPushData(currentSetup, encoderGroup, idx);
            data[param] = parseInt(value);
            setPushData(currentSetup, encoderGroup, idx, data);
        }
        
        function updateGreen(idx, param, value) {
            const data = getGreenData(currentSetup, faderGroup, idx);
            data[param] = parseInt(value);
            setGreenData(currentSetup, faderGroup, idx, data);
        }
        
        function updateFader(idx, param, value) {
            const data = getFaderData(currentSetup, faderGroup, idx);
            data[param] = parseInt(value);
            setFaderData(currentSetup, faderGroup, idx, data);
        }
        
        function updateFader9(param, value) {
            const data = getFader9Data(currentSetup, faderGroup);
            data[param] = parseInt(value);
            setFader9Data(currentSetup, faderGroup, data);
        }
        
        // ============================================================
        // Navigation
        // ============================================================
        
        function selectSetup(idx) {
            currentSetup = parseInt(idx);
            updateGroupNames();
            renderCurrentView();
        }
        
        function selectEncoderGroup(idx) {
            encoderGroup = idx;
            updateGroupTabs('encoderGroupTabs', idx);
            document.getElementById('encoderGroupName').textContent = getGroupName(currentSetup, idx);
            renderCurrentView();
        }
        
        function selectFaderGroup(idx) {
            faderGroup = idx;
            updateGroupTabs('faderGroupTabs', idx);
            document.getElementById('faderGroupName').textContent = getGroupName(currentSetup, idx);
            renderCurrentView();
        }
        
        function updateGroupTabs(containerId, activeIdx) {
            const tabs = document.getElementById(containerId).querySelectorAll('.group-tab');
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === activeIdx);
            });
        }
        
        function updateGroupNames() {
            document.getElementById('encoderGroupName').textContent = getGroupName(currentSetup, encoderGroup);
            document.getElementById('faderGroupName').textContent = getGroupName(currentSetup, faderGroup);
        }
        
        function setView(view) {
            currentView = view;
            document.getElementById('focusedViewBtn').classList.toggle('active', view === 'focused');
            document.getElementById('overviewBtn').classList.toggle('active', view === 'overview');
            renderCurrentView();
        }
        
        function renderCurrentView() {
            if (!rawBuffer) return;
            if (currentView === 'focused') {
                renderFocusedView();
            } else {
                renderOverview();
            }
        }
        
        // ============================================================
        // File Operations
        // ============================================================
        
        document.getElementById('sysexInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const buffer = await file.arrayBuffer();
                rawBuffer = new Uint8Array(buffer);
                
                if (rawBuffer.length !== EXPECTED_SIZE) {
                    alert(`Invalid file size: ${rawBuffer.length} bytes. Expected ${EXPECTED_SIZE} bytes.`);
                    rawBuffer = null;
                    return;
                }
                
                // Validate SysEx framing
                if (rawBuffer[0] !== 0xF0 || rawBuffer[rawBuffer.length - 1] !== 0xF7) {
                    alert('Invalid SysEx file: Missing F0/F7 framing bytes.');
                    rawBuffer = null;
                    return;
                }
                
                sectionIndex = buildIndex(rawBuffer);
                
                // Enable UI
                document.getElementById('setupSelect').disabled = false;
                document.getElementById('setupSelect').value = '0';
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('exportJsonBtn').disabled = false;
                
                currentSetup = 0;
                encoderGroup = 0;
                faderGroup = 0;
                isModified = false;
                dirtyBanks.clear();
                
                updateGroupTabs('encoderGroupTabs', 0);
                updateGroupTabs('faderGroupTabs', 0);
                updateGroupNames();
                updateStatus('loaded', `Loaded: ${file.name}`);
                document.getElementById('fileInfo').textContent = `${file.name} (${rawBuffer.length.toLocaleString()} bytes)`;
                
                renderFocusedView();
            } catch (err) {
                alert('Error loading file: ' + err.message);
                console.error(err);
            }
            
            e.target.value = '';
        });
        
        function exportSysEx() {
            if (!rawBuffer) return;
            
            // Recalculate all dirty checksums
            for (const key of dirtyBanks) {
                const [setupIdx, secId, bank] = key.split('-').map(Number);
                const sec = sectionIndex[setupIdx][secId];
                if (sec && sec[bank]) {
                    recalcBankChecksum(rawBuffer, sec[bank].dataOffset);
                }
            }
            dirtyBanks.clear();
            
            const blob = new Blob([rawBuffer], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'uc4_edited.syx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            isModified = false;
            updateStatus('loaded', 'Exported successfully');
        }
        
        function exportJSON() {
            if (!rawBuffer) return;
            
            const data = {
                format: 'uc4-editor',
                version: '1.0',
                exported: new Date().toISOString(),
                setups: []
            };
            
            for (let s = 0; s < NUM_SETUPS; s++) {
                const setup = {
                    index: s,
                    groups: []
                };
                
                for (let g = 0; g < NUM_GROUPS; g++) {
                    const group = {
                        index: g,
                        name: getGroupName(s, g),
                        encoders: [],
                        pushButtons: [],
                        greenButtons: [],
                        faders: [],
                        fader9: getFader9Data(s, g)
                    };
                    
                    for (let i = 0; i < 8; i++) {
                        group.encoders.push(getEncoderData(s, g, i));
                        group.pushButtons.push(getPushData(s, g, i));
                        group.greenButtons.push(getGreenData(s, g, i));
                        group.faders.push(getFaderData(s, g, i));
                    }
                    
                    setup.groups.push(group);
                }
                
                data.setups.push(setup);
            }
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'uc4_config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        document.getElementById('jsonInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!rawBuffer) {
                alert('Please import a SysEx file first to use as a base.');
                e.target.value = '';
                return;
            }
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (data.format !== 'uc4-editor') {
                    alert('Invalid JSON format. Expected UC4 Editor export.');
                    return;
                }
                
                // Apply JSON data to buffer
                for (const setup of data.setups) {
                    for (const group of setup.groups) {
                        for (let i = 0; i < 8; i++) {
                            if (group.encoders[i]) setEncoderData(setup.index, group.index, i, group.encoders[i]);
                            if (group.pushButtons[i]) setPushData(setup.index, group.index, i, group.pushButtons[i]);
                            if (group.greenButtons[i]) setGreenData(setup.index, group.index, i, group.greenButtons[i]);
                            if (group.faders[i]) setFaderData(setup.index, group.index, i, group.faders[i]);
                        }
                        if (group.fader9) setFader9Data(setup.index, group.index, group.fader9);
                    }
                }
                
                updateStatus('modified', 'JSON imported - changes pending');
                renderCurrentView();
            } catch (err) {
                alert('Error loading JSON: ' + err.message);
                console.error(err);
            }
            
            e.target.value = '';
        });
        
        // ============================================================
        // Status
        // ============================================================
        
        function markModified() {
            isModified = true;
            updateStatus('modified', 'Modified - remember to export');
        }
        
        function updateStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            
            dot.className = 'status-dot ' + state;
            txt.textContent = text;
        }
        
        // ============================================================
        // Init
        // ============================================================
        
        async function loadDefaultSysEx() {
            try {
                updateStatus('', 'Loading factory_default.syx...');
                const response = await fetch('factory_default.syx');
                if (!response.ok) {
                    console.log('No factory_default.syx found, waiting for manual import');
                    updateStatus('', 'No data loaded');
                    return;
                }
                
                const buffer = await response.arrayBuffer();
                rawBuffer = new Uint8Array(buffer);
                
                if (rawBuffer.length !== EXPECTED_SIZE) {
                    console.error(`Invalid file size: ${rawBuffer.length} bytes. Expected ${EXPECTED_SIZE} bytes.`);
                    rawBuffer = null;
                    updateStatus('', 'No data loaded');
                    return;
                }
                
                if (rawBuffer[0] !== 0xF0 || rawBuffer[rawBuffer.length - 1] !== 0xF7) {
                    console.error('Invalid SysEx file: Missing F0/F7 framing bytes.');
                    rawBuffer = null;
                    updateStatus('', 'No data loaded');
                    return;
                }
                
                sectionIndex = buildIndex(rawBuffer);
                
                // Enable UI
                document.getElementById('setupSelect').disabled = false;
                document.getElementById('setupSelect').value = '0';
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('exportJsonBtn').disabled = false;
                
                currentSetup = 0;
                encoderGroup = 0;
                faderGroup = 0;
                isModified = false;
                dirtyBanks.clear();
                
                updateGroupTabs('encoderGroupTabs', 0);
                updateGroupTabs('faderGroupTabs', 0);
                updateGroupNames();
                updateStatus('loaded', 'Loaded: factory_default.syx');
                document.getElementById('fileInfo').textContent = `factory_default.syx (${rawBuffer.length.toLocaleString()} bytes)`;
                
                renderFocusedView();
            } catch (err) {
                console.log('Could not auto-load factory_default.syx:', err.message);
                updateStatus('', 'No data loaded');
            }
        }
        
        initUI();
        loadDefaultSysEx();
    </script>
</body>
</html>
