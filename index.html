<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faderfox UC4 Editor v3</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --accent-primary: #58a6ff;
            --accent-green: #3fb950;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #484f58;
            --border-color: #30363d;
            --border-highlight: #388bfd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .logo h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .logo span {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn:hover {
            background: var(--border-color);
            border-color: var(--text-muted);
        }

        .btn-primary {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #000;
        }

        .btn-primary:hover {
            background: #2ea043;
            border-color: #2ea043;
        }

        .btn-danger {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .btn-danger:hover {
            background: var(--accent-red);
            color: #fff;
        }

        .main {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .toolbar-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-right: 0.5rem;
            border-right: 1px solid var(--border-color);
            margin-right: 0.25rem;
        }

        select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .validation-bar {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
        }

        .validation-item.ok { color: var(--accent-green); }
        .validation-item.warning { color: var(--accent-orange); }
        .validation-item.error { color: var(--accent-red); }

        .section-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .section-tab {
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px 6px 0 0;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .section-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .section-tab.active {
            color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .grid-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .grid-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .grid-table th,
        .grid-table td {
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-color);
            text-align: center;
            min-width: 50px;
        }

        .grid-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .grid-table th.group-header {
            background: var(--bg-primary);
            color: var(--accent-primary);
        }

        .grid-table th.control-header {
            font-size: 0.7rem;
            padding: 0.3rem;
        }

        .grid-table td.group-cell {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--accent-purple);
        }

        .grid-table td.channel-cell {
            background: var(--bg-card);
            color: var(--accent-orange);
        }

        .grid-table input {
            width: 100%;
            min-width: 40px;
            padding: 0.3rem;
            border: 1px solid transparent;
            border-radius: 3px;
            background: transparent;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            text-align: center;
        }

        .grid-table input:hover {
            background: var(--bg-tertiary);
        }

        .grid-table input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-primary);
        }

        .grid-table td.conflict {
            background: rgba(248, 81, 73, 0.2) !important;
            position: relative;
        }

        .grid-table td.conflict::after {
            content: '‚ö†';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6rem;
            color: var(--accent-red);
        }

        .grid-table td.conflict input {
            color: var(--accent-red);
        }

        .conflict-details {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
        }

        .conflict-details h3 {
            color: var(--accent-red);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .conflict-list {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .conflict-list li {
            margin: 0.3rem 0;
            padding-left: 1rem;
        }

        /* Card View Styles */
        .card-view-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .card-view-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
        }

        .card-tab {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .card-tab:hover {
            color: var(--text-primary);
            background: var(--border-color);
        }

        .card-tab.active {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
        }

        .card-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .group-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .group-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-right: 0.25rem;
        }

        .group-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .group-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .group-btn.active {
            background: var(--accent-purple);
            color: #fff;
            border-color: var(--accent-purple);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .control-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
        }

        .control-card.conflict {
            border-color: var(--accent-red);
            background: rgba(248, 81, 73, 0.1);
        }

        .control-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .control-card-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .control-card-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .control-card-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .control-card-row:last-child {
            margin-bottom: 0;
        }

        .control-card-field {
            flex: 1;
        }

        .control-card-field label {
            display: block;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 0.2rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control-card-field input,
        .control-card-field select {
            width: 100%;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .control-card-field input:focus,
        .control-card-field select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .template-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .template-card:hover {
            border-color: var(--accent-primary);
            background: var(--bg-card);
        }

        .template-card h4 {
            color: var(--accent-primary);
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .template-card p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .preview-table {
            width: 100%;
            font-size: 0.75rem;
            margin-top: 1rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 0.3rem 0.5rem;
            border: 1px solid var(--border-color);
        }

        .preview-table th {
            background: var(--bg-tertiary);
        }

        .preview-change {
            color: var(--accent-orange);
        }

        .json-textarea {
            width: 100%;
            height: 300px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            resize: vertical;
        }

        .json-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .hidden { display: none !important; }

        .status-toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.85rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.2s;
            z-index: 300;
        }

        .status-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .status-toast.error {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">UC4</div>
                <h1>Faderfox UC4 SysEx Editor <span>v3</span></h1>
            </div>
            <div class="header-actions">
                <button class="btn" onclick="showTemplates()">üìã Templates</button>
                <button class="btn" onclick="showImportJSON()">üì• Import JSON</button>
                <button class="btn" onclick="exportJSON()">üì§ Export JSON</button>
                <button class="btn" onclick="showValidation()">‚úì Validate</button>
                <button class="btn btn-primary" onclick="downloadSysEx()">‚¨á Download .syx</button>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="toolbar">
            <div class="toolbar-group">
                <span class="toolbar-label">Setup</span>
                <select id="setupSelect" onchange="changeSetup()">
                    <option value="1">Setup 1</option>
                    <option value="2">Setup 2</option>
                    <option value="3">Setup 3</option>
                    <option value="4">Setup 4</option>
                    <option value="5">Setup 5</option>
                    <option value="6">Setup 6</option>
                    <option value="7">Setup 7</option>
                    <option value="8">Setup 8</option>
                    <option value="9">Setup 9</option>
                    <option value="10">Setup 10</option>
                    <option value="11">Setup 11</option>
                    <option value="12">Setup 12</option>
                    <option value="13">Setup 13</option>
                    <option value="14">Setup 14</option>
                    <option value="15">Setup 15</option>
                    <option value="16">Setup 16</option>
                </select>
            </div>
            <div class="toolbar-group">
                <span class="toolbar-label">Quick Actions</span>
                <button class="btn" onclick="showCopyPreview()">Copy CCs ‚Üí</button>
                <button class="btn" onclick="loadFactoryDefaults()">Factory Reset</button>
                <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
            </div>
            <div class="toolbar-group">
                <span class="toolbar-label">View</span>
                <select id="viewMode" onchange="changeView()">
                    <option value="cards" selected>Card View</option>
                    <option value="grid">All Grid</option>
                    <option value="faders">Fader Grid</option>
                    <option value="encoders">Encoder Grid</option>
                    <option value="buttons">Button Grid</option>
                </select>
            </div>
        </div>

        <div class="validation-bar" id="validationBar">
            <!-- Populated by JS -->
        </div>

        <div class="grid-container" id="gridContainer">
            <table class="grid-table" id="mainGrid">
                <!-- Populated by JS -->
            </table>
        </div>

        <!-- Card View Section -->
        <div class="card-view-container hidden" id="cardViewContainer">
            <div class="card-view-tabs">
                <button class="card-tab active" onclick="switchCardSection('encoders')">Encoders</button>
                <button class="card-tab" onclick="switchCardSection('faders')">Faders</button>
                <button class="card-tab" onclick="switchCardSection('buttons')">Green Buttons</button>
                <button class="card-tab" onclick="switchCardSection('pushbuttons')">Push Buttons</button>
            </div>
            <div class="card-view-header">
                <div class="group-selector">
                    <span class="group-label">Group:</span>
                    <button class="group-btn active" onclick="switchCardGroup(1)">1</button>
                    <button class="group-btn" onclick="switchCardGroup(2)">2</button>
                    <button class="group-btn" onclick="switchCardGroup(3)">3</button>
                    <button class="group-btn" onclick="switchCardGroup(4)">4</button>
                    <button class="group-btn" onclick="switchCardGroup(5)">5</button>
                    <button class="group-btn" onclick="switchCardGroup(6)">6</button>
                    <button class="group-btn" onclick="switchCardGroup(7)">7</button>
                    <button class="group-btn" onclick="switchCardGroup(8)">8</button>
                </div>
            </div>
            <div class="cards-grid" id="cardsGrid">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="conflict-details hidden" id="conflictDetails">
            <h3>‚ö†Ô∏è CC Conflicts Detected</h3>
            <ul class="conflict-list" id="conflictList"></ul>
        </div>
    </main>

    <!-- Templates Modal -->
    <div class="modal-overlay" id="templatesModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Load Template</h2>
                <button class="modal-close" onclick="closeModal('templatesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="template-grid">
                    <div class="template-card" onclick="loadTemplate('factory')">
                        <h4>Factory Defaults</h4>
                        <p>Original Faderfox settings. Note: has known CC conflicts.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('channelPerGroup')">
                        <h4>Channel Per Group</h4>
                        <p>Each group on separate MIDI channel. No conflicts possible.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('dawMixer')">
                        <h4>DAW Mixer</h4>
                        <p>All Ch 1, sequential CCs. Faders 1-8, Encoders 9-16 per group.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('multiSynth')">
                        <h4>Multi-Synth</h4>
                        <p>8 synths on channels 1-8. Same CCs, different channels.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('noiseEngineering')">
                        <h4>Noise Engineering</h4>
                        <p>Optimized for modular/Eurorack. CC 1-8 per group.</p>
                    </div>
                    <div class="template-card" onclick="loadNoiseEngine()">
                        <h4>üéõÔ∏è Noise Engine</h4>
                        <p>8-slot texture synth. Channel per group, standardized CCs.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('blank')">
                        <h4>Blank Slate</h4>
                        <p>All controls set to CC 0, Channel 1. Start fresh.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Preview Modal -->
    <div class="modal-overlay" id="copyModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Copy Settings</h2>
                <button class="modal-close" onclick="closeModal('copyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Copy from:</label>
                    <select id="copyFromGroup" onchange="updateCopyPreview()" style="width: 100%;">
                        <option value="1">Group 1</option>
                        <option value="2">Group 2</option>
                        <option value="3">Group 3</option>
                        <option value="4">Group 4</option>
                        <option value="5">Group 5</option>
                        <option value="6">Group 6</option>
                        <option value="7">Group 7</option>
                        <option value="8">Group 8</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">What to copy:</label>
                    <select id="copyWhat" onchange="updateCopyPreview()" style="width: 100%;">
                        <option value="cc">CC Numbers Only (keep channels)</option>
                        <option value="channel">Channels Only (keep CCs)</option>
                        <option value="both">Both CC and Channel</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Apply to:</label>
                    <select id="copyTarget" style="width: 100%;">
                        <option value="faders">Faders</option>
                        <option value="encoders">Encoders</option>
                        <option value="buttons">Green Buttons</option>
                        <option value="pushbuttons">Push Buttons</option>
                        <option value="all">All Controls</option>
                    </select>
                </div>
                <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">Preview:</h4>
                <div id="copyPreviewContent" style="max-height: 200px; overflow-y: auto;">
                    <!-- Preview table populated by JS -->
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn" onclick="closeModal('copyModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="applyCopy()">Apply to All Groups</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import JSON Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Import JSON</h2>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem;">
                    Paste a previously exported JSON configuration:
                </p>
                <textarea class="json-textarea" id="importTextarea" placeholder='{"setup": 1, "faders": {...}, "encoders": {...}}'></textarea>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn" onclick="closeModal('importModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="importJSON()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Validation Modal -->
    <div class="modal-overlay" id="validationModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Validation Report</h2>
                <button class="modal-close" onclick="closeModal('validationModal')">&times;</button>
            </div>
            <div class="modal-body" id="validationReport">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <div class="status-toast" id="statusToast"></div>

    <script>
        // ============================================
        // CONFIGURATION STATE
        // ============================================
        
        const config = {
            setup: 1,
            faders: {},
            encoders: {},
            buttons: {},
            pushbuttons: {},
            // Card view state
            cardSection: 'encoders',
            cardGroup: 1
        };

        // Control type options
        const ENCODER_TYPES = ['ccabs', 'ccr1', 'ccr2', 'ccah', 'prgc', 'pbnd', 'aftt'];
        const ENCODER_TYPE_LABELS = {
            'ccabs': 'CC Absolute',
            'ccr1': 'CC Relative 1',
            'ccr2': 'CC Relative 2',
            'ccah': 'CC 14-bit',
            'prgc': 'Program Change',
            'pbnd': 'Pitch Bend',
            'aftt': 'Aftertouch'
        };
        const ACCEL_OPTIONS = ['acc0', 'acc1', 'acc2', 'acc3'];
        const ACCEL_LABELS = { 'acc0': 'None', 'acc1': 'Low', 'acc2': 'Medium', 'acc3': 'Maximum' };
        const DISPLAY_OPTIONS = ['std', 'bpol', 'off'];
        const DISPLAY_LABELS = { 'std': 'Standard', 'bpol': 'Bipolar', 'off': 'Off' };
        const BUTTON_TYPES = ['note', 'cc', 'prgc', 'aftt', 'off'];
        const BUTTON_TYPE_LABELS = { 'note': 'Note', 'cc': 'CC', 'prgc': 'Program Change', 'aftt': 'Aftertouch', 'off': 'Off' };
        const BUTTON_MODES = ['momentary', 'toggle'];
        const FADER_TYPES = ['ccabs', 'prgc', 'pbnd', 'aftt'];
        const FADER_MODES = ['jump', 'snap'];

        // ============================================
        // FACTORY DEFAULTS (from manual)
        // ============================================
        
        const FACTORY_ENCODERS = [
            [8, 9, 10, 11, 12, 13, 14, 15],
            [16, 17, 18, 19, 20, 21, 22, 23],
            [24, 25, 26, 27, 28, 29, 30, 31],
            [32, 33, 34, 35, 36, 37, 38, 39],
            [72, 73, 74, 75, 76, 77, 78, 79],
            [80, 81, 82, 83, 84, 85, 86, 87],
            [88, 89, 90, 91, 92, 93, 94, 95],
            [96, 97, 98, 99, 100, 101, 102, 103]
        ];
        
        const FACTORY_FADERS = [
            [32, 33, 34, 35, 36, 37, 38, 39, 112],
            [40, 41, 42, 43, 44, 45, 46, 47, 112],
            [48, 49, 50, 51, 52, 53, 54, 55, 112],
            [56, 57, 58, 59, 60, 61, 62, 63, 112],
            [104, 105, 106, 107, 108, 109, 110, 111, 112],
            [104, 105, 106, 107, 108, 109, 110, 111, 112],
            [104, 105, 106, 107, 108, 109, 110, 111, 112],
            [104, 105, 106, 107, 108, 109, 110, 111, 112]
        ];
        
        const FACTORY_BUTTONS = [
            [64, 65, 66, 67, 68, 69, 70, 71],
            [72, 73, 74, 75, 76, 77, 78, 79],
            [80, 81, 82, 83, 84, 85, 86, 87],
            [88, 89, 90, 91, 92, 93, 94, 95],
            [96, 97, 98, 99, 100, 101, 102, 103],
            [104, 105, 106, 107, 108, 109, 110, 111],
            [112, 113, 114, 115, 116, 117, 118, 119],
            [120, 121, 122, 123, 124, 125, 126, 127]
        ];
        
        const FACTORY_PUSHBUTTONS = [
            [0, 1, 2, 3, 4, 5, 6, 7],
            [8, 9, 10, 11, 12, 13, 14, 15],
            [16, 17, 18, 19, 20, 21, 22, 23],
            [24, 25, 26, 27, 28, 29, 30, 31],
            [32, 33, 34, 35, 36, 37, 38, 39],
            [40, 41, 42, 43, 44, 45, 46, 47],
            [48, 49, 50, 51, 52, 53, 54, 55],
            [56, 57, 58, 59, 60, 61, 62, 63]
        ];

        // ============================================
        // INITIALIZATION
        // ============================================
        
        function initConfig() {
            for (let g = 1; g <= 8; g++) {
                config.faders[g] = {};
                config.encoders[g] = {};
                config.buttons[g] = {};
                config.pushbuttons[g] = {};
                
                for (let i = 1; i <= 9; i++) {
                    config.faders[g][i] = {
                        cc: FACTORY_FADERS[g-1][i-1],
                        channel: config.setup,
                        type: 'ccabs',
                        mode: 'jump',
                        lower: 0,
                        upper: 127
                    };
                }
                
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = {
                        cc: FACTORY_ENCODERS[g-1][i-1],
                        channel: config.setup,
                        type: 'ccabs',
                        accel: 'acc3',
                        display: 'std',
                        lower: 0,
                        upper: 127
                    };
                    config.buttons[g][i] = {
                        cc: FACTORY_BUTTONS[g-1][i-1],
                        channel: config.setup,
                        type: 'note',
                        mode: 'momentary',
                        lower: 0,
                        upper: 127
                    };
                    config.pushbuttons[g][i] = {
                        cc: FACTORY_PUSHBUTTONS[g-1][i-1],
                        channel: config.setup,
                        type: 'note',
                        mode: 'momentary',
                        lower: 0,
                        upper: 127
                    };
                }
            }
        }

        // ============================================
        // CONFLICT DETECTION
        // ============================================
        
        function detectConflicts() {
            const conflicts = [];
            const ccMap = new Map(); // key: "cc:channel" -> array of locations
            
            // Collect all CC/channel combinations
            for (let g = 1; g <= 8; g++) {
                // Faders
                for (let i = 1; i <= 9; i++) {
                    const f = config.faders[g][i];
                    const key = `${f.cc}:${f.channel}`;
                    if (!ccMap.has(key)) ccMap.set(key, []);
                    ccMap.get(key).push({ type: 'fader', group: g, num: i, cc: f.cc, channel: f.channel });
                }
                
                // Encoders
                for (let i = 1; i <= 8; i++) {
                    const e = config.encoders[g][i];
                    const key = `${e.cc}:${e.channel}`;
                    if (!ccMap.has(key)) ccMap.set(key, []);
                    ccMap.get(key).push({ type: 'encoder', group: g, num: i, cc: e.cc, channel: e.channel });
                }
            }
            
            // Find duplicates
            for (const [key, locations] of ccMap) {
                if (locations.length > 1) {
                    conflicts.push({
                        cc: locations[0].cc,
                        channel: locations[0].channel,
                        locations: locations
                    });
                }
            }
            
            return conflicts;
        }
        
        function getConflictSet() {
            const conflicts = detectConflicts();
            const conflictSet = new Set();
            
            for (const c of conflicts) {
                for (const loc of c.locations) {
                    conflictSet.add(`${loc.type}:${loc.group}:${loc.num}`);
                }
            }
            
            return conflictSet;
        }

        // ============================================
        // VALIDATION
        // ============================================
        
        function runValidation() {
            const results = [];
            const conflicts = detectConflicts();
            
            // Check for conflicts
            if (conflicts.length === 0) {
                results.push({ status: 'ok', message: 'No CC conflicts' });
            } else {
                results.push({ 
                    status: 'error', 
                    message: `${conflicts.length} CC conflict${conflicts.length > 1 ? 's' : ''} detected` 
                });
            }
            
            // Check for identical groups (factory default issue)
            const faderGroups5to8Same = 
                JSON.stringify(config.faders[5]) === JSON.stringify(config.faders[6]) &&
                JSON.stringify(config.faders[6]) === JSON.stringify(config.faders[7]) &&
                JSON.stringify(config.faders[7]) === JSON.stringify(config.faders[8]);
            
            if (faderGroups5to8Same) {
                results.push({ 
                    status: 'warning', 
                    message: 'Fader groups 5-8 are identical' 
                });
            }
            
            // Check for unassigned controls (CC 0 might be intentional, skip)
            let allConfigured = true;
            results.push({ status: 'ok', message: 'All groups configured' });
            
            return { results, conflicts };
        }
        
        function updateValidationBar() {
            const { results, conflicts } = runValidation();
            const bar = document.getElementById('validationBar');
            
            bar.innerHTML = results.map(r => `
                <div class="validation-item ${r.status}">
                    ${r.status === 'ok' ? '‚úì' : r.status === 'warning' ? '‚ö†' : '‚úó'} ${r.message}
                </div>
            `).join('');
            
            // Update conflict details panel
            const detailsPanel = document.getElementById('conflictDetails');
            const conflictList = document.getElementById('conflictList');
            
            if (conflicts.length > 0) {
                detailsPanel.classList.remove('hidden');
                conflictList.innerHTML = conflicts.map(c => {
                    const locs = c.locations.map(l => 
                        `${l.type.charAt(0).toUpperCase() + l.type.slice(1)} ${l.num} (Group ${l.group})`
                    ).join(', ');
                    return `<li>CC ${c.cc} Ch ${c.channel}: ${locs}</li>`;
                }).join('');
            } else {
                detailsPanel.classList.add('hidden');
            }
        }

        // ============================================
        // GRID RENDERING
        // ============================================
        
        function renderGrid() {
            const grid = document.getElementById('mainGrid');
            const viewMode = document.getElementById('viewMode').value;
            const conflictSet = getConflictSet();
            
            let html = '<thead><tr>';
            html += '<th class="group-header">Grp</th>';
            html += '<th>Ch</th>';
            
            // Headers based on view
            if (viewMode === 'grid' || viewMode === 'faders') {
                for (let i = 1; i <= 9; i++) {
                    html += `<th class="control-header">F${i}</th>`;
                }
            }
            if (viewMode === 'grid' || viewMode === 'encoders') {
                for (let i = 1; i <= 8; i++) {
                    html += `<th class="control-header">E${i}</th>`;
                }
            }
            if (viewMode === 'grid' || viewMode === 'buttons') {
                for (let i = 1; i <= 8; i++) {
                    html += `<th class="control-header">B${i}</th>`;
                }
                for (let i = 1; i <= 8; i++) {
                    html += `<th class="control-header">P${i}</th>`;
                }
            }
            
            html += '</tr></thead><tbody>';
            
            // Rows for each group
            for (let g = 1; g <= 8; g++) {
                html += '<tr>';
                html += `<td class="group-cell">${g}</td>`;
                
                // Channel (use first fader's channel as representative)
                const ch = config.faders[g][1].channel;
                html += `<td class="channel-cell">
                    <input type="number" min="1" max="16" value="${ch}" 
                           onchange="updateGroupChannel(${g}, this.value)">
                </td>`;
                
                // Faders
                if (viewMode === 'grid' || viewMode === 'faders') {
                    for (let i = 1; i <= 9; i++) {
                        const f = config.faders[g][i];
                        const isConflict = conflictSet.has(`fader:${g}:${i}`);
                        html += `<td${isConflict ? ' class="conflict"' : ''}>
                            <input type="number" min="0" max="127" value="${f.cc}" 
                                   onchange="updateCC('faders', ${g}, ${i}, this.value)">
                        </td>`;
                    }
                }
                
                // Encoders
                if (viewMode === 'grid' || viewMode === 'encoders') {
                    for (let i = 1; i <= 8; i++) {
                        const e = config.encoders[g][i];
                        const isConflict = conflictSet.has(`encoder:${g}:${i}`);
                        html += `<td${isConflict ? ' class="conflict"' : ''}>
                            <input type="number" min="0" max="127" value="${e.cc}" 
                                   onchange="updateCC('encoders', ${g}, ${i}, this.value)">
                        </td>`;
                    }
                }
                
                // Buttons
                if (viewMode === 'grid' || viewMode === 'buttons') {
                    for (let i = 1; i <= 8; i++) {
                        const b = config.buttons[g][i];
                        html += `<td>
                            <input type="number" min="0" max="127" value="${b.cc}" 
                                   onchange="updateCC('buttons', ${g}, ${i}, this.value)">
                        </td>`;
                    }
                    for (let i = 1; i <= 8; i++) {
                        const p = config.pushbuttons[g][i];
                        html += `<td>
                            <input type="number" min="0" max="127" value="${p.cc}" 
                                   onchange="updateCC('pushbuttons', ${g}, ${i}, this.value)">
                        </td>`;
                    }
                }
                
                html += '</tr>';
            }
            
            html += '</tbody>';
            grid.innerHTML = html;
            
            updateValidationBar();
        }
        
        function updateCC(type, group, num, value) {
            config[type][group][num].cc = parseInt(value) || 0;
            renderGrid();
        }
        
        function updateGroupChannel(group, value) {
            const ch = parseInt(value) || 1;
            for (let i = 1; i <= 9; i++) {
                config.faders[group][i].channel = ch;
            }
            for (let i = 1; i <= 8; i++) {
                config.encoders[group][i].channel = ch;
                config.buttons[group][i].channel = ch;
                config.pushbuttons[group][i].channel = ch;
            }
            renderGrid();
        }

        // ============================================
        // TEMPLATES
        // ============================================
        
        function loadTemplate(name) {
            switch(name) {
                case 'factory':
                    loadFactoryDefaults();
                    break;
                    
                case 'channelPerGroup':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 9; i++) {
                            config.faders[g][i] = { cc: i - 1, channel: g, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: 10 + i - 1, channel: g, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: 20 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: 30 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
                    
                case 'dawMixer':
                    for (let g = 1; g <= 8; g++) {
                        const offset = (g - 1) * 17;
                        for (let i = 1; i <= 9; i++) {
                            config.faders[g][i] = { cc: offset + i - 1, channel: 1, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: offset + 9 + i - 1, channel: 1, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: offset + i - 1, channel: 2, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: offset + 9 + i - 1, channel: 2, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
                    
                case 'multiSynth':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 9; i++) {
                            config.faders[g][i] = { cc: i - 1, channel: g, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: 10 + i - 1, channel: g, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: 20 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: 30 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
                    
                case 'noiseEngineering':
                    // Generic modular layout
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 8; i++) {
                            config.faders[g][i] = { cc: i, channel: g, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        config.faders[g][9] = { cc: 7, channel: g, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 }; // Volume
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: 70 + i - 1, channel: g, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: 80 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: 90 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
                    
                case 'blank':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 9; i++) {
                            config.faders[g][i] = { cc: 0, channel: 1, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: 0, channel: 1, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: 0, channel: 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: 0, channel: 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
            }
            
            closeModal('templatesModal');
            renderGrid();
            renderCards();
            showStatus(`Loaded template: ${name}`);
        }
        
        // Hidden template - type 'ne' to load
        function loadNoiseEngine() {
            // Noise Engine: 8-slot texture synth. Channel per group, standardized CCs.
            const encoderDef = [
                { cc: 10, type: 'ccabs', accel: 'acc2' },  // 1: Pan
                { cc: 72, type: 'ccabs', accel: 'acc2' },  // 2: Resonance
                { cc: 75, type: 'ccabs', accel: 'acc2' },  // 3: Portamento
                { cc: 80, type: 'ccabs', accel: 'acc2' },  // 4: P5
                { cc: 20, type: 'ccabs', accel: 'acc2' },  // 5: EQ Hi
                { cc: 21, type: 'ccabs', accel: 'acc2' },  // 6: EQ Mid
                { cc: 22, type: 'ccabs', accel: 'acc2' },  // 7: EQ Lo
                { cc: 23, type: 'ccabs', accel: 'acc2' },  // 8: Echo Send
            ];
            const faderDef = [
                { cc: 7, type: 'ccabs', mode: 'snap' },    // 1: Volume
                { cc: 71, type: 'ccabs', mode: 'snap' },   // 2: Cutoff
                { cc: 73, type: 'ccabs', mode: 'snap' },   // 3: Attack
                { cc: 74, type: 'ccabs', mode: 'snap' },   // 4: Decay
                { cc: 76, type: 'ccabs', mode: 'snap' },   // 5: P1
                { cc: 77, type: 'ccabs', mode: 'snap' },   // 6: P2
                { cc: 78, type: 'ccabs', mode: 'snap' },   // 7: P3
                { cc: 79, type: 'ccabs', mode: 'snap' },   // 8: P4
                { cc: 11, type: 'ccabs', mode: 'snap' },   // 9: Expression/spare
            ];
            const buttonDef = [
                { cc: 32, type: 'cc', mode: 'toggle' },    // 1: Mute
                { cc: 33, type: 'cc', mode: 'toggle' },    // 2: Solo
                { cc: 34, type: 'cc', mode: 'momentary' }, // 3: Filter -
                { cc: 35, type: 'cc', mode: 'momentary' }, // 4: Filter +
                { cc: 36, type: 'cc', mode: 'momentary' }, // 5: Env Source -
                { cc: 37, type: 'cc', mode: 'momentary' }, // 6: Env Source +
                { cc: 38, type: 'cc', mode: 'momentary' }, // 7: Clock Rate -
                { cc: 39, type: 'cc', mode: 'momentary' }, // 8: Clock Rate +
            ];
            const pushDef = [
                { cc: 24, type: 'cc', mode: 'momentary' }, // 1: Verb Send
                { cc: 25, type: 'cc', mode: 'momentary' }, // 2: Filter Type
                { cc: 26, type: 'cc', mode: 'momentary' }, // 3: Env Source
                { cc: 27, type: 'cc', mode: 'momentary' }, // 4: Clock Rate
                { cc: 28, type: 'cc', mode: 'toggle' },    // 5: Lo Cut
                { cc: 29, type: 'cc', mode: 'toggle' },    // 6: Hi Cut
                { cc: 30, type: 'cc', mode: 'momentary' }, // 7: Gain cycle
                { cc: 31, type: 'cc', mode: 'momentary' }, // 8: Transpose reset
            ];
            
            for (let g = 1; g <= 8; g++) {
                for (let i = 1; i <= 8; i++) {
                    const enc = encoderDef[i-1];
                    config.encoders[g][i] = { 
                        cc: enc.cc, channel: g, type: enc.type, 
                        accel: enc.accel, display: 'std', lower: 0, upper: 127 
                    };
                }
                for (let i = 1; i <= 9; i++) {
                    const fad = faderDef[i-1];
                    config.faders[g][i] = { 
                        cc: fad.cc, channel: g, type: fad.type, 
                        mode: fad.mode, lower: 0, upper: 127 
                    };
                }
                for (let i = 1; i <= 8; i++) {
                    const btn = buttonDef[i-1];
                    config.buttons[g][i] = { 
                        cc: btn.cc, channel: g, type: btn.type, 
                        mode: btn.mode, lower: 0, upper: 127 
                    };
                }
                for (let i = 1; i <= 8; i++) {
                    const pb = pushDef[i-1];
                    config.pushbuttons[g][i] = { 
                        cc: pb.cc, channel: g, type: pb.type, 
                        mode: pb.mode, lower: 0, upper: 127 
                    };
                }
            }
            
            closeModal('templatesModal');
            renderGrid();
            renderCards();
            showStatus('üéõÔ∏è Noise Engine template loaded');
        }
        
        // Secret key sequence detector
        let keyBuffer = '';
        document.addEventListener('keydown', (e) => {
            // Don't trigger when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            
            keyBuffer += e.key.toLowerCase();
            keyBuffer = keyBuffer.slice(-10); // Keep last 10 chars
            
            if (keyBuffer.endsWith('ne')) {
                loadNoiseEngine();
                keyBuffer = '';
            }
        });
        
        function loadFactoryDefaults() {
            for (let g = 1; g <= 8; g++) {
                for (let i = 1; i <= 9; i++) {
                    config.faders[g][i] = {
                        cc: FACTORY_FADERS[g-1][i-1],
                        channel: config.setup,
                        type: 'ccabs',
                        mode: 'jump',
                        lower: 0,
                        upper: 127
                    };
                }
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = {
                        cc: FACTORY_ENCODERS[g-1][i-1],
                        channel: config.setup,
                        type: 'ccabs',
                        accel: 'acc3',
                        display: 'std',
                        lower: 0,
                        upper: 127
                    };
                    config.buttons[g][i] = {
                        cc: FACTORY_BUTTONS[g-1][i-1],
                        channel: config.setup,
                        type: 'note',
                        mode: 'momentary',
                        lower: 0,
                        upper: 127
                    };
                    config.pushbuttons[g][i] = {
                        cc: FACTORY_PUSHBUTTONS[g-1][i-1],
                        channel: config.setup,
                        type: 'note',
                        mode: 'momentary',
                        lower: 0,
                        upper: 127
                    };
                }
            }
            renderGrid();
            renderCards();
            showStatus('Factory defaults loaded');
        }
        
        function clearAll() {
            if (!confirm('Clear all CC assignments from the grid?')) {
                return;
            }
            
            for (let g = 1; g <= 8; g++) {
                for (let i = 1; i <= 9; i++) {
                    config.faders[g][i] = { cc: '', channel: 1, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                }
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = { cc: '', channel: 1, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                    config.buttons[g][i] = { cc: '', channel: 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                    config.pushbuttons[g][i] = { cc: '', channel: 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                }
            }
            renderGrid();
            renderCards();
            showStatus('All CCs cleared');
        }

        // ============================================
        // COPY FUNCTIONALITY
        // ============================================
        
        function updateCopyPreview() {
            const fromGroup = parseInt(document.getElementById('copyFromGroup').value);
            const what = document.getElementById('copyWhat').value;
            const target = document.getElementById('copyTarget').value;
            
            let html = '<table class="preview-table"><thead><tr><th>Group</th>';
            
            // Show preview for faders as example
            if (target === 'faders' || target === 'all') {
                for (let i = 1; i <= 9; i++) html += `<th>F${i}</th>`;
            }
            if (target === 'encoders' || target === 'all') {
                for (let i = 1; i <= 8; i++) html += `<th>E${i}</th>`;
            }
            
            html += '</tr></thead><tbody>';
            
            for (let g = 1; g <= 8; g++) {
                html += `<tr><td>${g}</td>`;
                
                if (target === 'faders' || target === 'all') {
                    for (let i = 1; i <= 9; i++) {
                        const current = config.faders[g][i].cc;
                        const source = config.faders[fromGroup][i].cc;
                        const willChange = g !== fromGroup && (what === 'cc' || what === 'both');
                        const newVal = willChange ? source : current;
                        html += `<td${willChange && current !== newVal ? ' class="preview-change"' : ''}>${newVal}</td>`;
                    }
                }
                
                if (target === 'encoders' || target === 'all') {
                    for (let i = 1; i <= 8; i++) {
                        const current = config.encoders[g][i].cc;
                        const source = config.encoders[fromGroup][i].cc;
                        const willChange = g !== fromGroup && (what === 'cc' || what === 'both');
                        const newVal = willChange ? source : current;
                        html += `<td${willChange && current !== newVal ? ' class="preview-change"' : ''}>${newVal}</td>`;
                    }
                }
                
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            html += '<p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">Orange = will change</p>';
            
            document.getElementById('copyPreviewContent').innerHTML = html;
        }
        
        function applyCopy() {
            const fromGroup = parseInt(document.getElementById('copyFromGroup').value);
            const what = document.getElementById('copyWhat').value;
            const target = document.getElementById('copyTarget').value;
            
            for (let g = 1; g <= 8; g++) {
                if (g === fromGroup) continue;
                
                if (target === 'faders' || target === 'all') {
                    for (let i = 1; i <= 9; i++) {
                        if (what === 'cc' || what === 'both') {
                            config.faders[g][i].cc = config.faders[fromGroup][i].cc;
                        }
                        if (what === 'channel' || what === 'both') {
                            config.faders[g][i].channel = config.faders[fromGroup][i].channel;
                        }
                    }
                }
                
                if (target === 'encoders' || target === 'all') {
                    for (let i = 1; i <= 8; i++) {
                        if (what === 'cc' || what === 'both') {
                            config.encoders[g][i].cc = config.encoders[fromGroup][i].cc;
                        }
                        if (what === 'channel' || what === 'both') {
                            config.encoders[g][i].channel = config.encoders[fromGroup][i].channel;
                        }
                    }
                }
                
                if (target === 'buttons' || target === 'all') {
                    for (let i = 1; i <= 8; i++) {
                        if (what === 'cc' || what === 'both') {
                            config.buttons[g][i].cc = config.buttons[fromGroup][i].cc;
                        }
                        if (what === 'channel' || what === 'both') {
                            config.buttons[g][i].channel = config.buttons[fromGroup][i].channel;
                        }
                    }
                }
                
                if (target === 'pushbuttons' || target === 'all') {
                    for (let i = 1; i <= 8; i++) {
                        if (what === 'cc' || what === 'both') {
                            config.pushbuttons[g][i].cc = config.pushbuttons[fromGroup][i].cc;
                        }
                        if (what === 'channel' || what === 'both') {
                            config.pushbuttons[g][i].channel = config.pushbuttons[fromGroup][i].channel;
                        }
                    }
                }
            }
            
            closeModal('copyModal');
            renderGrid();
            showStatus('Settings copied to all groups');
        }

        // ============================================
        // JSON IMPORT/EXPORT
        // ============================================
        
        function exportJSON() {
            const data = {
                version: 3,
                setup: config.setup,
                exported: new Date().toISOString(),
                faders: config.faders,
                encoders: config.encoders,
                buttons: config.buttons,
                pushbuttons: config.pushbuttons
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `UC4_Setup${config.setup}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('JSON exported');
        }
        
        function importJSON() {
            const textarea = document.getElementById('importTextarea');
            
            try {
                const data = JSON.parse(textarea.value);
                
                if (data.faders) config.faders = data.faders;
                if (data.encoders) config.encoders = data.encoders;
                if (data.buttons) config.buttons = data.buttons;
                if (data.pushbuttons) config.pushbuttons = data.pushbuttons;
                if (data.setup) {
                    config.setup = data.setup;
                    document.getElementById('setupSelect').value = data.setup;
                }
                
                closeModal('importModal');
                renderGrid();
                showStatus('JSON imported successfully');
            } catch (e) {
                showStatus('Invalid JSON: ' + e.message, true);
            }
        }

        // ============================================
        // UC4 SYSEX ENCODING (Reverse-engineered)
        // ============================================
        
        // Encode CC number and channel into triplet bytes
        function encodeCC(cc, channel) {
            const xx = 0x20 + (cc >> 4);
            const yy = ((channel - 1) << 4) | (cc & 0x0F);
            return [0x4D, xx, yy];
        }
        
        // Encode type with channel
        function encodeType(type, channel, displayOrMode) {
            const typeValues = {
                // Encoder types
                'ccr1': 0, 'ccr2': 1, 'ccabs': 2, 'prgc': 3, 'ccah': 4, 'pbnd': 5, 'aftt': 6,
                // Button types  
                'off': 0, 'note': 1, 'cc': 2
            };
            const typeVal = typeValues[type] || 2;
            const xx = 0x20 + typeVal;
            const yy = ((channel - 1) << 4) | (displayOrMode & 0x0F);
            return [0x4D, xx, yy];
        }
        
        // Encode acceleration
        function encodeAccel(accel, channel) {
            const accelValues = { 'acc0': 0, 'acc1': 1, 'acc2': 2, 'acc3': 3 };
            const val = accelValues[accel] || 3;
            const xx = 0x20 + val;
            const yy = ((channel - 1) << 4) | 0x0A; // 0x0A seems to be accel marker
            return [0x4D, xx, yy];
        }
        
        // Encode display scale
        function encodeDisplay(display, channel) {
            const displayValues = { 'off': 0, 'std': 1, 'bpol': 2 };
            const val = displayValues[display] || 1;
            const xx = 0x20 + val;
            const yy = ((channel - 1) << 4) | 0x08; // 0x08 seems to be display marker
            return [0x4D, xx, yy];
        }
        
        // Encode button mode
        function encodeMode(mode, channel) {
            const modeVal = mode === 'toggle' ? 1 : 0;
            const xx = 0x20 + modeVal;
            const yy = ((channel - 1) << 4);
            return [0x4D, xx, yy];
        }
        
        function generateSysEx() {
            const sysex = [];
            const setup = config.setup;
            
            // SysEx start + Manufacturer ID (Faderfox)
            sysex.push(0xF0, 0x00, 0x00, 0x00);
            
            // Header - group name encoding (default "GrP1" style)
            sysex.push(0x41, 0x20, 0x16); // G
            sysex.push(0x42, 0x20, 0x13); // r
            sysex.push(0x43, 0x20, 0x12); // P
            sysex.push(0x44, 0x20, 0x10 + setup); // Setup number
            
            // Generate data for each group (1-8)
            for (let g = 1; g <= 8; g++) {
                const groupBase = 0x14 + g; // Group identifier
                
                // ========== GREEN BUTTONS SECTION (4A 28) ==========
                sysex.push(0x49, 0x21, groupBase);
                sysex.push(0x4A, 0x28, 0x10);
                
                // 8 buttons √ó 4 triplets √ó 2 halves = 64 triplets
                for (let half = 0; half < 2; half++) {
                    for (let b = 1; b <= 8; b++) {
                        const btn = config.buttons[g][b];
                        const ch = btn.channel || 1;
                        const cc = btn.cc || 0;
                        
                        // T0: Type
                        sysex.push(...encodeType(btn.type, ch, 0));
                        // T1: Mode (upper value related)
                        sysex.push(...encodeMode(btn.mode, ch));
                        // T2: Display/feedback
                        sysex.push(0x4D, 0x21, ((ch - 1) << 4) | 0x08);
                        // T3: CC/Note number
                        sysex.push(...encodeCC(cc, ch));
                    }
                }
                
                // Section end markers
                sysex.push(0x4B, 0x20, 0x14);
                sysex.push(0x4C, 0x26, 0x18);
                // Padding
                for (let p = 0; p < 30; p++) sysex.push(0x00);
                
                // ========== PUSH BUTTONS SECTION (4A 2C) ==========
                sysex.push(0x49, 0x21, groupBase);
                sysex.push(0x4A, 0x2C, 0x10);
                
                for (let half = 0; half < 2; half++) {
                    for (let p = 1; p <= 8; p++) {
                        const pb = config.pushbuttons[g][p];
                        const ch = pb.channel || 1;
                        const cc = pb.cc || 0;
                        
                        sysex.push(...encodeType(pb.type, ch, 0));
                        sysex.push(...encodeMode(pb.mode, ch));
                        sysex.push(0x4D, 0x21, ((ch - 1) << 4) | 0x08);
                        sysex.push(...encodeCC(cc, ch));
                    }
                }
                
                sysex.push(0x4B, 0x20, 0x14);
                sysex.push(0x4C, 0x26, 0x18);
                for (let p = 0; p < 30; p++) sysex.push(0x00);
                
                // ========== ENCODERS SECTION (4A 20) ==========
                sysex.push(0x49, 0x21, groupBase + 1);
                sysex.push(0x4A, 0x20, 0x10);
                
                for (let half = 0; half < 2; half++) {
                    for (let e = 1; e <= 8; e++) {
                        const enc = config.encoders[g][e];
                        const ch = enc.channel || 1;
                        const cc = enc.cc || 0;
                        
                        // T0: Type
                        sysex.push(...encodeType(enc.type, ch, 0));
                        // T1: Acceleration
                        sysex.push(...encodeAccel(enc.accel, ch));
                        // T2: Display
                        sysex.push(...encodeDisplay(enc.display, ch));
                        // T3: CC number
                        sysex.push(...encodeCC(cc, ch));
                    }
                }
                
                sysex.push(0x4B, 0x20, 0x14);
                sysex.push(0x4C, 0x26, 0x18);
                for (let p = 0; p < 30; p++) sysex.push(0x00);
                
                // ========== FADERS SECTION (4A 24) ==========
                sysex.push(0x49, 0x21, groupBase + 1);
                sysex.push(0x4A, 0x24, 0x10);
                
                for (let half = 0; half < 2; half++) {
                    for (let f = 1; f <= 8; f++) {
                        const fad = config.faders[g][f];
                        const ch = fad.channel || 1;
                        const cc = fad.cc || 0;
                        
                        // T0: Type
                        sysex.push(...encodeType(fad.type, ch, 0));
                        // T1: Mode (snap/jump)
                        const modeVal = fad.mode === 'snap' ? 1 : 0;
                        sysex.push(0x4D, 0x20 + modeVal, ((ch - 1) << 4));
                        // T2: Lower value
                        sysex.push(...encodeCC(fad.lower || 0, ch));
                        // T3: CC number
                        sysex.push(...encodeCC(cc, ch));
                    }
                }
                
                // Fader 9 special
                const f9 = config.faders[g][9];
                sysex.push(0x4B, 0x20, (f9.cc || 112) & 0x1F);
                sysex.push(0x4C, 0x26, 0x18);
                for (let p = 0; p < 30; p++) sysex.push(0x00);
            }
            
            // Footer
            sysex.push(0x4F, 0x20, 0x16);
            sysex.push(0xF7);
            
            return new Uint8Array(sysex);
        }
        
        function downloadSysEx() {
            const { conflicts } = runValidation();
            
            if (conflicts.length > 0) {
                if (!confirm(`Warning: ${conflicts.length} CC conflict(s) detected.\n\nDownload anyway?`)) {
                    return;
                }
            }
            
            const sysex = generateSysEx();
            const blob = new Blob([sysex], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `UC4_Setup${config.setup}.syx`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus(`Downloaded UC4_Setup${config.setup}.syx (${sysex.length} bytes)`);
        }

        // ============================================
        // UI HELPERS
        // ============================================
        
        function showTemplates() {
            document.getElementById('templatesModal').classList.add('show');
        }
        
        function showCopyPreview() {
            updateCopyPreview();
            document.getElementById('copyModal').classList.add('show');
        }
        
        function showImportJSON() {
            document.getElementById('importTextarea').value = '';
            document.getElementById('importModal').classList.add('show');
        }
        
        function showValidation() {
            const { results, conflicts } = runValidation();
            
            let html = '<div style="space-y: 1rem;">';
            
            results.forEach(r => {
                const icon = r.status === 'ok' ? '‚úÖ' : r.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
                const color = r.status === 'ok' ? 'var(--accent-green)' : 
                              r.status === 'warning' ? 'var(--accent-orange)' : 'var(--accent-red)';
                html += `<div style="padding: 0.5rem; color: ${color}; display: flex; align-items: center; gap: 0.5rem;">
                    ${icon} ${r.message}
                </div>`;
            });
            
            if (conflicts.length > 0) {
                html += '<hr style="border-color: var(--border-color); margin: 1rem 0;">';
                html += '<h4 style="color: var(--accent-red); margin-bottom: 0.5rem;">Conflict Details:</h4>';
                html += '<ul style="font-size: 0.85rem; color: var(--text-secondary); padding-left: 1.5rem;">';
                conflicts.forEach(c => {
                    const locs = c.locations.map(l => 
                        `${l.type} ${l.num} (G${l.group})`
                    ).join(', ');
                    html += `<li style="margin: 0.3rem 0;">CC ${c.cc} Ch ${c.channel}: ${locs}</li>`;
                });
                html += '</ul>';
            }
            
            html += '</div>';
            
            document.getElementById('validationReport').innerHTML = html;
            document.getElementById('validationModal').classList.add('show');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        function changeSetup() {
            config.setup = parseInt(document.getElementById('setupSelect').value);
            showStatus(`Setup ${config.setup} selected`);
        }
        
        function changeView() {
            const viewMode = document.getElementById('viewMode').value;
            const gridContainer = document.getElementById('gridContainer');
            const cardContainer = document.getElementById('cardViewContainer');
            
            if (viewMode === 'cards') {
                gridContainer.classList.add('hidden');
                cardContainer.classList.remove('hidden');
                renderCards();
            } else {
                gridContainer.classList.remove('hidden');
                cardContainer.classList.add('hidden');
                renderGrid();
            }
        }
        
        // ============================================
        // CARD VIEW RENDERING
        // ============================================
        
        function switchCardSection(section) {
            config.cardSection = section;
            document.querySelectorAll('.card-tab').forEach((tab, i) => {
                const sections = ['encoders', 'faders', 'buttons', 'pushbuttons'];
                tab.classList.toggle('active', sections[i] === section);
            });
            renderCards();
        }
        
        function switchCardGroup(group) {
            config.cardGroup = group;
            document.querySelectorAll('.group-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === group);
            });
            renderCards();
        }
        
        function renderCards() {
            const grid = document.getElementById('cardsGrid');
            const section = config.cardSection;
            const group = config.cardGroup;
            const conflictSet = getConflictSet();
            
            let html = '';
            const count = section === 'faders' ? 9 : 8;
            
            for (let i = 1; i <= count; i++) {
                const ctrl = config[section][group][i];
                const isConflict = conflictSet.has(`${section.slice(0, -1)}:${group}:${i}`) || 
                                   conflictSet.has(`${section === 'faders' ? 'fader' : section.slice(0, -1)}:${group}:${i}`);
                
                if (section === 'encoders') {
                    html += renderEncoderCard(i, ctrl, isConflict);
                } else if (section === 'faders') {
                    html += renderFaderCard(i, ctrl, isConflict);
                } else {
                    html += renderButtonCard(section, i, ctrl, isConflict);
                }
            }
            
            grid.innerHTML = html;
            updateValidationBar();
        }
        
        function renderEncoderCard(num, ctrl, isConflict) {
            return `
                <div class="control-card${isConflict ? ' conflict' : ''}">
                    <div class="control-card-header">
                        <span class="control-card-name">Encoder ${num}</span>
                        <span class="control-card-badge">${ENCODER_TYPE_LABELS[ctrl.type] || ctrl.type}</span>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>CC/Note</label>
                            <input type="number" min="0" max="127" value="${ctrl.cc}" 
                                   onchange="updateCardControl('encoders', ${num}, 'cc', this.value)">
                        </div>
                        <div class="control-card-field">
                            <label>Channel</label>
                            <input type="number" min="1" max="16" value="${ctrl.channel}" 
                                   onchange="updateCardControl('encoders', ${num}, 'channel', this.value)">
                        </div>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>Type</label>
                            <select onchange="updateCardControl('encoders', ${num}, 'type', this.value)">
                                ${ENCODER_TYPES.map(t => `<option value="${t}"${ctrl.type === t ? ' selected' : ''}>${ENCODER_TYPE_LABELS[t]}</option>`).join('')}
                            </select>
                        </div>
                        <div class="control-card-field">
                            <label>Acceleration</label>
                            <select onchange="updateCardControl('encoders', ${num}, 'accel', this.value)">
                                ${ACCEL_OPTIONS.map(a => `<option value="${a}"${ctrl.accel === a ? ' selected' : ''}>${ACCEL_LABELS[a]}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>Display</label>
                            <select onchange="updateCardControl('encoders', ${num}, 'display', this.value)">
                                ${DISPLAY_OPTIONS.map(d => `<option value="${d}"${ctrl.display === d ? ' selected' : ''}>${DISPLAY_LABELS[d]}</option>`).join('')}
                            </select>
                        </div>
                        <div class="control-card-field">
                            <label>Lower</label>
                            <input type="number" min="0" max="127" value="${ctrl.lower}" 
                                   onchange="updateCardControl('encoders', ${num}, 'lower', this.value)">
                        </div>
                        <div class="control-card-field">
                            <label>Upper</label>
                            <input type="number" min="0" max="127" value="${ctrl.upper}" 
                                   onchange="updateCardControl('encoders', ${num}, 'upper', this.value)">
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderFaderCard(num, ctrl, isConflict) {
            return `
                <div class="control-card${isConflict ? ' conflict' : ''}">
                    <div class="control-card-header">
                        <span class="control-card-name">Fader ${num}</span>
                        <span class="control-card-badge">${ctrl.mode}</span>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>CC</label>
                            <input type="number" min="0" max="127" value="${ctrl.cc}" 
                                   onchange="updateCardControl('faders', ${num}, 'cc', this.value)">
                        </div>
                        <div class="control-card-field">
                            <label>Channel</label>
                            <input type="number" min="1" max="16" value="${ctrl.channel}" 
                                   onchange="updateCardControl('faders', ${num}, 'channel', this.value)">
                        </div>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>Type</label>
                            <select onchange="updateCardControl('faders', ${num}, 'type', this.value)">
                                ${FADER_TYPES.map(t => `<option value="${t}"${ctrl.type === t ? ' selected' : ''}>${ENCODER_TYPE_LABELS[t] || t}</option>`).join('')}
                            </select>
                        </div>
                        <div class="control-card-field">
                            <label>Mode</label>
                            <select onchange="updateCardControl('faders', ${num}, 'mode', this.value)">
                                ${FADER_MODES.map(m => `<option value="${m}"${ctrl.mode === m ? ' selected' : ''}>${m.charAt(0).toUpperCase() + m.slice(1)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>Lower</label>
                            <input type="number" min="0" max="127" value="${ctrl.lower}" 
                                   onchange="updateCardControl('faders', ${num}, 'lower', this.value)">
                        </div>
                        <div class="control-card-field">
                            <label>Upper</label>
                            <input type="number" min="0" max="127" value="${ctrl.upper}" 
                                   onchange="updateCardControl('faders', ${num}, 'upper', this.value)">
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderButtonCard(section, num, ctrl, isConflict) {
            const label = section === 'buttons' ? 'Button' : 'Push Btn';
            return `
                <div class="control-card${isConflict ? ' conflict' : ''}">
                    <div class="control-card-header">
                        <span class="control-card-name">${label} ${num}</span>
                        <span class="control-card-badge">${BUTTON_TYPE_LABELS[ctrl.type] || ctrl.type}</span>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>Note/CC</label>
                            <input type="number" min="0" max="127" value="${ctrl.cc}" 
                                   onchange="updateCardControl('${section}', ${num}, 'cc', this.value)">
                        </div>
                        <div class="control-card-field">
                            <label>Channel</label>
                            <input type="number" min="1" max="16" value="${ctrl.channel}" 
                                   onchange="updateCardControl('${section}', ${num}, 'channel', this.value)">
                        </div>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>Type</label>
                            <select onchange="updateCardControl('${section}', ${num}, 'type', this.value)">
                                ${BUTTON_TYPES.map(t => `<option value="${t}"${ctrl.type === t ? ' selected' : ''}>${BUTTON_TYPE_LABELS[t]}</option>`).join('')}
                            </select>
                        </div>
                        <div class="control-card-field">
                            <label>Mode</label>
                            <select onchange="updateCardControl('${section}', ${num}, 'mode', this.value)">
                                ${BUTTON_MODES.map(m => `<option value="${m}"${ctrl.mode === m ? ' selected' : ''}>${m.charAt(0).toUpperCase() + m.slice(1)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="control-card-row">
                        <div class="control-card-field">
                            <label>Lower</label>
                            <input type="number" min="0" max="127" value="${ctrl.lower}" 
                                   onchange="updateCardControl('${section}', ${num}, 'lower', this.value)">
                        </div>
                        <div class="control-card-field">
                            <label>Upper</label>
                            <input type="number" min="0" max="127" value="${ctrl.upper}" 
                                   onchange="updateCardControl('${section}', ${num}, 'upper', this.value)">
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateCardControl(section, num, prop, value) {
            const group = config.cardGroup;
            if (prop === 'cc' || prop === 'channel' || prop === 'lower' || prop === 'upper') {
                config[section][group][num][prop] = value === '' ? '' : parseInt(value);
            } else {
                config[section][group][num][prop] = value;
            }
            renderCards();
            // Also update grid in background
            renderGrid();
        }
        
        function showStatus(message, isError = false) {
            const toast = document.getElementById('statusToast');
            toast.textContent = message;
            toast.className = 'status-toast show' + (isError ? ' error' : '');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                }
            });
        });

        // ============================================
        // INIT
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initConfig();
            // Default to card view
            document.getElementById('gridContainer').classList.add('hidden');
            document.getElementById('cardViewContainer').classList.remove('hidden');
            renderCards();
            updateValidationBar();
        });
    </script>
</body>
</html>
