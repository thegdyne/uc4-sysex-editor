<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faderfox UC4 SysEx Editor v4</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #13161c;
            --bg-tertiary: #1c2028;
            --bg-card: #171b22;
            --accent-primary: #00d4aa;
            --accent-blue: #4dabf7;
            --accent-orange: #ff922b;
            --accent-red: #ff6b6b;
            --accent-purple: #9775fa;
            --accent-yellow: #ffd43b;
            --text-primary: #e9ecef;
            --text-secondary: #868e96;
            --text-muted: #495057;
            --border-color: #2c3038;
            --border-highlight: #00d4aa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.85rem;
            color: #000;
        }

        .logo h1 {
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .logo .version {
            font-size: 0.65rem;
            color: var(--accent-primary);
            background: rgba(0, 212, 170, 0.15);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.5rem 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn:hover {
            background: var(--border-color);
            border-color: var(--text-muted);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #000;
        }

        .btn-primary:hover {
            background: #00c49a;
            border-color: #00c49a;
        }

        .btn-danger {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .btn-danger:hover {
            background: var(--accent-red);
            color: #fff;
        }

        /* Main content */
        .main {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Protocol Reference Panel */
        .protocol-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .protocol-header {
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .protocol-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .protocol-toggle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .protocol-content {
            padding: 1rem;
            display: none;
        }

        .protocol-content.show {
            display: block;
        }

        .protocol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .protocol-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .protocol-card h4 {
            font-size: 0.75rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .protocol-card code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            background: var(--bg-primary);
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
            color: var(--accent-orange);
        }

        .protocol-card p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
        }

        .protocol-table {
            width: 100%;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }

        .protocol-table th, .protocol-table td {
            padding: 0.25rem 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .protocol-table th {
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .toolbar-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-right: 0.5rem;
            border-right: 1px solid var(--border-color);
            margin-right: 0.25rem;
        }

        select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Validation Bar */
        .validation-bar {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .validation-item.ok { color: var(--accent-primary); }
        .validation-item.warning { color: var(--accent-orange); }
        .validation-item.error { color: var(--accent-red); }

        /* SysEx Status */
        .sysex-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .sysex-status .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .sysex-status .indicator.loaded {
            background: var(--accent-primary);
            box-shadow: 0 0 8px var(--accent-primary);
        }

        .sysex-status .info {
            flex: 1;
            font-size: 0.8rem;
        }

        .sysex-status .info strong {
            color: var(--accent-primary);
        }

        .sysex-status .details {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Card View */
        .card-view-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
        }

        .card-view-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
        }

        .card-tab {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .card-tab:hover {
            color: var(--text-primary);
            background: var(--border-color);
        }

        .card-tab.active {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
        }

        .card-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .group-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .group-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: 0.25rem;
        }

        .group-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .group-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .group-btn.active {
            background: var(--accent-purple);
            color: #fff;
            border-color: var(--accent-purple);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .control-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.15s;
        }

        .control-card:hover {
            border-color: var(--text-muted);
        }

        .control-card.conflict {
            border-color: var(--accent-red);
            background: rgba(255, 107, 107, 0.05);
        }

        .control-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .control-card-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .control-card-badge {
            font-size: 0.6rem;
            padding: 0.2rem 0.4rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        .control-card-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .control-card-row:last-child {
            margin-bottom: 0;
        }

        .control-card-field {
            flex: 1;
        }

        .control-card-field label {
            display: block;
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-bottom: 0.2rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control-card-field input,
        .control-card-field select {
            width: 100%;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .control-card-field input:focus,
        .control-card-field select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Grid View */
        .grid-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
        }

        .grid-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .grid-table th,
        .grid-table td {
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-color);
            text-align: center;
            min-width: 50px;
        }

        .grid-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .grid-table th.group-header {
            background: var(--bg-primary);
            color: var(--accent-blue);
        }

        .grid-table td.group-cell {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--accent-purple);
        }

        .grid-table td.channel-cell {
            background: var(--bg-card);
            color: var(--accent-orange);
        }

        .grid-table input {
            width: 100%;
            min-width: 40px;
            padding: 0.3rem;
            border: 1px solid transparent;
            border-radius: 3px;
            background: transparent;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-align: center;
        }

        .grid-table input:hover {
            background: var(--bg-tertiary);
        }

        .grid-table input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-primary);
        }

        .grid-table td.conflict {
            background: rgba(255, 107, 107, 0.15) !important;
        }

        .grid-table td.conflict input {
            color: var(--accent-red);
        }

        /* Conflict Details */
        .conflict-details {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
        }

        .conflict-details h3 {
            color: var(--accent-red);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .conflict-list {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding-left: 1.5rem;
        }

        .conflict-list li {
            margin: 0.3rem 0;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 650px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
        }

        .modal-header h2 {
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .template-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .template-card:hover {
            border-color: var(--accent-primary);
            background: var(--bg-card);
            transform: translateY(-2px);
        }

        .template-card h4 {
            color: var(--accent-primary);
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .template-card p {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .json-textarea {
            width: 100%;
            height: 300px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            resize: vertical;
        }

        .json-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Status Toast */
        .status-toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.25s ease;
            z-index: 300;
        }

        .status-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .status-toast.error {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .hidden { display: none !important; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">UC4</div>
                <h1>Faderfox UC4 SysEx Editor <span class="version">v4</span></h1>
            </div>
            <div class="header-actions">
                <button class="btn" onclick="showTemplates()">üìã Templates</button>
                <button class="btn" onclick="importSysExTemplate()">üìÇ Load .syx Backup</button>
                <button class="btn" onclick="showImportJSON()">üì• Import JSON</button>
                <button class="btn" onclick="exportJSON()">üì§ Export JSON</button>
                <button class="btn" onclick="showValidation()">‚úì Validate</button>
                <button class="btn btn-primary" onclick="downloadSysEx()">‚¨á Download .syx</button>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Protocol Reference Panel -->
        <div class="protocol-panel">
            <div class="protocol-header" onclick="toggleProtocol()">
                <h3>üîß Faderfox SysEx Protocol Reference</h3>
                <span class="protocol-toggle" id="protocolToggle">‚ñ∂ Show</span>
            </div>
            <div class="protocol-content" id="protocolContent">
                <div class="protocol-grid">
                    <div class="protocol-card">
                        <h4>Device Identification</h4>
                        <p>Faderfox ID: <code>0x4E 0x2C 0x1B</code></p>
                        <p>From EC4/UC4 Remote Scripts</p>
                    </div>
                    <div class="protocol-card">
                        <h4>CC/Channel Encoding</h4>
                        <p>Format: <code>4D XX YY</code></p>
                        <p>XX = <code>0x20 | (cc >> 4)</code></p>
                        <p>YY = <code>((ch-1) << 4) | (cc & 0xF)</code></p>
                    </div>
                    <div class="protocol-card">
                        <h4>Section Markers</h4>
                        <table class="protocol-table">
                            <tr><th>Marker</th><th>Section</th></tr>
                            <tr><td><code>4A 20</code></td><td>Encoders</td></tr>
                            <tr><td><code>4A 24</code></td><td>Faders</td></tr>
                            <tr><td><code>4A 28</code></td><td>Green Buttons</td></tr>
                            <tr><td><code>4A 2C</code></td><td>Push Buttons</td></tr>
                        </table>
                    </div>
                    <div class="protocol-card">
                        <h4>Encoder Types (Verified)</h4>
                        <table class="protocol-table">
                            <tr><th>Value</th><th>Type</th></tr>
                            <tr><td>0</td><td>CCr1 (Relative 1)</td></tr>
                            <tr><td>1</td><td>CCr2 (Relative 2)</td></tr>
                            <tr><td>2</td><td>CCAb (Absolute)</td></tr>
                            <tr><td>3</td><td>PrGC (Program Change)</td></tr>
                            <tr><td>4</td><td>CCAh (14-bit)</td></tr>
                            <tr><td>5</td><td>Pbnd (Pitch Bend)</td></tr>
                            <tr><td>6</td><td>AFtt (Aftertouch)</td></tr>
                        </table>
                    </div>
                    <div class="protocol-card">
                        <h4>Button Types (Verified)</h4>
                        <table class="protocol-table">
                            <tr><th>Value</th><th>Type</th></tr>
                            <tr><td>0</td><td>OFF</td></tr>
                            <tr><td>1</td><td>Note</td></tr>
                            <tr><td>2</td><td>CC</td></tr>
                            <tr><td>3</td><td>Program Change</td></tr>
                            <tr><td>4</td><td>Aftertouch</td></tr>
                        </table>
                    </div>
                    <div class="protocol-card">
                        <h4>Critical: Dual-Half Structure</h4>
                        <p>Each section has <strong>16 entries</strong> (8 controls √ó 2 halves)</p>
                        <p>‚ö†Ô∏è <strong>BOTH halves must be synchronized</strong></p>
                        <p>Mismatched halves = UC4 rejection</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SysEx Status -->
        <div class="sysex-status">
            <div class="indicator" id="sysexIndicator"></div>
            <div class="info" id="sysexInfo">
                <strong>No SysEx template loaded</strong><br>
                <span class="details">Load your UC4 backup .syx file to enable editing</span>
            </div>
            <button class="btn" onclick="importSysExTemplate()">Load .syx</button>
        </div>

        <div class="toolbar">
            <div class="toolbar-group">
                <span class="toolbar-label">Setup</span>
                <select id="setupSelect" onchange="changeSetup()">
                    <option value="1">Setup 1</option>
                    <option value="2">Setup 2</option>
                    <option value="3">Setup 3</option>
                    <option value="4">Setup 4</option>
                    <option value="5">Setup 5</option>
                    <option value="6">Setup 6</option>
                    <option value="7">Setup 7</option>
                    <option value="8">Setup 8</option>
                    <option value="9">Setup 9</option>
                    <option value="10">Setup 10</option>
                    <option value="11">Setup 11</option>
                    <option value="12">Setup 12</option>
                    <option value="13">Setup 13</option>
                    <option value="14">Setup 14</option>
                    <option value="15">Setup 15</option>
                    <option value="16">Setup 16</option>
                </select>
            </div>
            <div class="toolbar-group">
                <span class="toolbar-label">Quick Actions</span>
                <button class="btn" onclick="showCopyPreview()">Copy CCs ‚Üí</button>
                <button class="btn" onclick="loadFactoryDefaults()">Factory Reset</button>
                <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
            </div>
            <div class="toolbar-group">
                <span class="toolbar-label">View</span>
                <select id="viewMode" onchange="changeView()">
                    <option value="cards" selected>Card View</option>
                    <option value="grid">All Grid</option>
                    <option value="faders">Fader Grid</option>
                    <option value="encoders">Encoder Grid</option>
                    <option value="buttons">Button Grid</option>
                </select>
            </div>
        </div>

        <div class="validation-bar" id="validationBar">
            <!-- Populated by JS -->
        </div>

        <div class="grid-container hidden" id="gridContainer">
            <table class="grid-table" id="mainGrid">
                <!-- Populated by JS -->
            </table>
        </div>

        <!-- Card View Section -->
        <div class="card-view-container" id="cardViewContainer">
            <div class="card-view-tabs">
                <button class="card-tab active" onclick="switchCardSection('encoders')">Encoders</button>
                <button class="card-tab" onclick="switchCardSection('faders')">Faders</button>
                <button class="card-tab" onclick="switchCardSection('buttons')">Green Buttons</button>
                <button class="card-tab" onclick="switchCardSection('pushbuttons')">Push Buttons</button>
            </div>
            <div class="card-view-header">
                <div class="group-selector">
                    <span class="group-label">Group:</span>
                    <button class="group-btn active" onclick="switchCardGroup(1)">1</button>
                    <button class="group-btn" onclick="switchCardGroup(2)">2</button>
                    <button class="group-btn" onclick="switchCardGroup(3)">3</button>
                    <button class="group-btn" onclick="switchCardGroup(4)">4</button>
                    <button class="group-btn" onclick="switchCardGroup(5)">5</button>
                    <button class="group-btn" onclick="switchCardGroup(6)">6</button>
                    <button class="group-btn" onclick="switchCardGroup(7)">7</button>
                    <button class="group-btn" onclick="switchCardGroup(8)">8</button>
                </div>
            </div>
            <div class="cards-grid" id="cardsGrid">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="conflict-details hidden" id="conflictDetails">
            <h3>‚ö†Ô∏è CC Conflicts Detected</h3>
            <ul class="conflict-list" id="conflictList"></ul>
        </div>
    </main>

    <!-- Templates Modal -->
    <div class="modal-overlay" id="templatesModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Load Template</h2>
                <button class="modal-close" onclick="closeModal('templatesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="template-grid">
                    <div class="template-card" onclick="loadTemplate('factory')">
                        <h4>Factory Defaults</h4>
                        <p>Original Faderfox settings. Note: has known CC conflicts.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('channelPerGroup')">
                        <h4>Channel Per Group</h4>
                        <p>Each group on separate MIDI channel. No conflicts possible.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('dawMixer')">
                        <h4>DAW Mixer</h4>
                        <p>All Ch 1, sequential CCs. Faders 1-8, Encoders 9-16 per group.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('multiSynth')">
                        <h4>Multi-Synth</h4>
                        <p>8 synths on channels 1-8. Same CCs, different channels.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('noiseEngineering')">
                        <h4>Noise Engineering</h4>
                        <p>Optimized for modular/Eurorack. CC 1-8 per group.</p>
                    </div>
                    <div class="template-card" onclick="loadNoiseEngine()">
                        <h4>üéõÔ∏è Noise Engine</h4>
                        <p>8-slot texture synth. Channel per group, standardized CCs.</p>
                    </div>
                    <div class="template-card" onclick="loadTemplate('blank')">
                        <h4>Blank Slate</h4>
                        <p>All controls set to CC 0, Channel 1. Start fresh.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Preview Modal -->
    <div class="modal-overlay" id="copyModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Copy Settings</h2>
                <button class="modal-close" onclick="closeModal('copyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Copy from:</label>
                    <select id="copyFromGroup" onchange="updateCopyPreview()" style="width: 100%;">
                        <option value="1">Group 1</option>
                        <option value="2">Group 2</option>
                        <option value="3">Group 3</option>
                        <option value="4">Group 4</option>
                        <option value="5">Group 5</option>
                        <option value="6">Group 6</option>
                        <option value="7">Group 7</option>
                        <option value="8">Group 8</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">What to copy:</label>
                    <select id="copyWhat" onchange="updateCopyPreview()" style="width: 100%;">
                        <option value="cc">CC Numbers Only (keep channels)</option>
                        <option value="channel">Channels Only (keep CCs)</option>
                        <option value="both">Both CC and Channel</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Apply to:</label>
                    <select id="copyTarget" style="width: 100%;">
                        <option value="faders">Faders</option>
                        <option value="encoders">Encoders</option>
                        <option value="buttons">Green Buttons</option>
                        <option value="pushbuttons">Push Buttons</option>
                        <option value="all">All Controls</option>
                    </select>
                </div>
                <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">Preview:</h4>
                <div id="copyPreviewContent" style="max-height: 200px; overflow-y: auto;">
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn" onclick="closeModal('copyModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="applyCopy()">Apply to All Groups</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import JSON Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Import JSON</h2>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem;">
                    Paste a previously exported JSON configuration:
                </p>
                <textarea class="json-textarea" id="importTextarea" placeholder='{"setup": 1, "faders": {...}, "encoders": {...}}'></textarea>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn" onclick="closeModal('importModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="importJSON()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Validation Modal -->
    <div class="modal-overlay" id="validationModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Validation Report</h2>
                <button class="modal-close" onclick="closeModal('validationModal')">&times;</button>
            </div>
            <div class="modal-body" id="validationReport">
            </div>
        </div>
    </div>

    <div class="status-toast" id="statusToast"></div>

    <script>
        // ============================================
        // FADERFOX SYSEX PROTOCOL CONSTANTS
        // From Faderfox EC4/UC4 Remote Scripts
        // ============================================
        
        const FADERFOX = {
            // Device identification from consts.py
            DEVICE_ID: [0x4E, 0x2C, 0x1B],
            SYSEX_START: [0xF0, 0x00, 0x00, 0x00],
            SYSEX_END: 0xF7,
            
            // Section markers (verified through testing)
            SECTIONS: {
                ENCODERS: 0x20,    // 4A 20 10
                FADERS: 0x24,      // 4A 24 10
                BUTTONS: 0x28,     // 4A 28 10
                PUSHBUTTONS: 0x2C // 4A 2C 10
            },
            
            // Encoder types (test05-06 verified)
            ENCODER_TYPES: {
                CCR1: 0,    // Relative mode 1
                CCR2: 1,    // Relative mode 2
                CCAB: 2,    // Absolute (default)
                PRGC: 3,    // Program Change
                CCAH: 4,    // 14-bit high res
                PBND: 5,    // Pitch Bend
                AFTT: 6     // Aftertouch
            },
            
            // Button types (test11-13 verified)
            BUTTON_TYPES: {
                OFF: 0,
                NOTE: 1,    // Default
                CC: 2,
                PRGC: 3,
                AFTT: 4
            },
            
            // Fader types (test24-28 verified)
            FADER_TYPES: {
                CCAB: 0,    // Absolute (default)
                PRGC: 1,
                PBND: 2,
                AFTT: 3
            },
            
            // Acceleration modes (test07-09 verified)
            ACCEL_MODES: {
                ACC0: 0,
                ACC1: 1,
                ACC2: 2,
                ACC3: 3     // Default (max)
            },
            
            // Display scales (test17-18 verified)
            DISPLAY_SCALES: {
                OFF: 0,
                STD: 1,     // Standard (default)
                BPOL: 2     // Bipolar
            },
            
            // Button modes (test14 verified)
            BUTTON_MODES: {
                MOMENTARY: 0,
                TOGGLE: 1
            }
        };

        // ============================================
        // ENCODING FUNCTIONS
        // Based on get_display_msg() from faderfox_parameter_display.py
        // ============================================
        
        /**
         * Encode CC number and channel into XX, YY bytes
         * Formula from Faderfox Remote Scripts:
         *   XX = 0x20 | (value >> 4)
         *   YY = 0x10 | (value & 0xF) for display
         * For CC/Channel encoding:
         *   XX = 0x20 + (cc >> 4)
         *   YY = ((channel - 1) << 4) | (cc & 0x0F)
         */
        function encodeCC(cc, channel) {
            const xx = 0x20 + ((cc >> 4) & 0x0F);
            const yy = ((channel - 1) << 4) | (cc & 0x0F);
            return { xx, yy };
        }
        
        /**
         * Decode CC and channel from XX, YY bytes
         */
        function decodeCC(xx, yy) {
            const cc = ((xx - 0x20) << 4) | (yy & 0x0F);
            const channel = ((yy >> 4) & 0x0F) + 1;
            return { cc, channel };
        }
        
        /**
         * Validate UC4 SysEx dump file
         * UC4 bulk dumps have different structure than real-time messages
         */
        function validateFaderfoxDevice(data) {
            // Check minimum size
            if (data.length < 1000) return false;
            
            // Check SysEx boundaries
            if (data[0] !== 0xF0) return false;
            if (data[data.length - 1] !== 0xF7) return false;
            
            // Valid UC4 dump sizes:
            // - All 18 setups: ~100,640 bytes
            // - Single setup: ~5,590 bytes
            const validSizes = [100640, 5591, 5590, 5592]; // Allow some tolerance
            const sizeOk = validSizes.some(s => Math.abs(data.length - s) < 100) || data.length > 50000;
            
            // Look for UC4 section markers anywhere in file
            let foundSections = 0;
            for (let i = 0; i < Math.min(data.length - 3, 10000); i++) {
                if (data[i] === 0x4A && data[i + 2] === 0x10) {
                    const marker = data[i + 1];
                    if (marker === 0x20 || marker === 0x24 || marker === 0x28 || marker === 0x2C) {
                        foundSections++;
                    }
                }
            }
            
            // Valid if we found section markers OR size matches known UC4 dump
            return foundSections >= 2 || sizeOk;
        }

        // ============================================
        // CONFIGURATION STATE
        // ============================================
        
        const config = {
            setup: 1,
            faders: {},
            encoders: {},
            buttons: {},
            pushbuttons: {},
            cardSection: 'encoders',
            cardGroup: 1
        };

        // Control type labels
        const ENCODER_TYPE_LABELS = {
            'ccabs': 'CC Absolute', 'ccr1': 'CC Relative 1', 'ccr2': 'CC Relative 2',
            'ccah': 'CC 14-bit', 'prgc': 'Program Change', 'pbnd': 'Pitch Bend', 'aftt': 'Aftertouch'
        };
        const ACCEL_LABELS = { 'acc0': 'None', 'acc1': 'Low', 'acc2': 'Medium', 'acc3': 'Maximum' };
        const DISPLAY_LABELS = { 'std': 'Standard', 'bpol': 'Bipolar', 'off': 'Off' };
        const BUTTON_TYPE_LABELS = { 'note': 'Note', 'cc': 'CC', 'prgc': 'Program Change', 'aftt': 'Aftertouch', 'off': 'Off' };

        // ============================================
        // FACTORY DEFAULTS (from UC4 manual page 13)
        // ============================================
        
        const FACTORY_ENCODERS = [
            [8, 9, 10, 11, 12, 13, 14, 15],
            [16, 17, 18, 19, 20, 21, 22, 23],
            [24, 25, 26, 27, 28, 29, 30, 31],
            [32, 33, 34, 35, 36, 37, 38, 39],
            [72, 73, 74, 75, 76, 77, 78, 79],
            [80, 81, 82, 83, 84, 85, 86, 87],
            [88, 89, 90, 91, 92, 93, 94, 95],
            [96, 97, 98, 99, 100, 101, 102, 103]
        ];
        
        const FACTORY_FADERS = [
            [32, 33, 34, 35, 36, 37, 38, 39, 112],
            [40, 41, 42, 43, 44, 45, 46, 47, 112],
            [48, 49, 50, 51, 52, 53, 54, 55, 112],
            [56, 57, 58, 59, 60, 61, 62, 63, 112],
            [104, 105, 106, 107, 108, 109, 110, 111, 112],
            [104, 105, 106, 107, 108, 109, 110, 111, 112],
            [104, 105, 106, 107, 108, 109, 110, 111, 112],
            [104, 105, 106, 107, 108, 109, 110, 111, 112]
        ];
        
        const FACTORY_BUTTONS = [
            [64, 65, 66, 67, 68, 69, 70, 71],
            [72, 73, 74, 75, 76, 77, 78, 79],
            [80, 81, 82, 83, 84, 85, 86, 87],
            [88, 89, 90, 91, 92, 93, 94, 95],
            [96, 97, 98, 99, 100, 101, 102, 103],
            [104, 105, 106, 107, 108, 109, 110, 111],
            [112, 113, 114, 115, 116, 117, 118, 119],
            [120, 121, 122, 123, 124, 125, 126, 127]
        ];
        
        const FACTORY_PUSHBUTTONS = [
            [0, 1, 2, 3, 4, 5, 6, 7],
            [8, 9, 10, 11, 12, 13, 14, 15],
            [16, 17, 18, 19, 20, 21, 22, 23],
            [24, 25, 26, 27, 28, 29, 30, 31],
            [32, 33, 34, 35, 36, 37, 38, 39],
            [40, 41, 42, 43, 44, 45, 46, 47],
            [48, 49, 50, 51, 52, 53, 54, 55],
            [56, 57, 58, 59, 60, 61, 62, 63]
        ];

        // ============================================
        // SYSEX TEMPLATE MANAGEMENT
        // ============================================
        
        let sysexTemplate = null;
        let sysexInfo = { filename: '', size: 0, valid: false };
        
        // ============================================
        // EMBEDDED UC4 FACTORY SYSEX (BASE64)
        // Original UC4 backup for auto-load
        // ============================================
        const EMBEDDED_SYSEX_BASE64 = `8AAAAEEgFkIgE0MgEkQgFUkhFEooEE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGEsgFEwmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFEosEE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGEsgFEwmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFUogEE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGEsgFEwmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFUokEE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGEsgFEwmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFUooEE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGEsgFEwmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFUosEE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGEsgFEwmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFkogEE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGEsgFEwmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFkokEE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGE0hEE0hGk0hGE0gEU0hEE0hGk0hGE0gEk0hEE0hGk0hGE0gE00hEE0hGk0hGE0gFE0hEE0hGk0hGE0gFU0hEE0hGk0hGE0gFk0hEE0hGk0hGE0gF00hEE0hGk0hGE0gGEsgFEwmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFkooEE0hG00hFk0gHU0gEU0hG00hFk0gHU0gEk0hG00hFk0gHU0gE00hG00hFk0gHU0gFE0hHE0hGk0gGk0gHE0hGk0gGk0gHE0iFk0hGE0gGk0hFk0iFk0hEE0hFE0hF00gG00hG00hFk0gHU0gEU0hG00hFk0gHU0gEk0hG00hFk0gHU0gE00hG00hFk0gHU0gFE0hHE0hGk0gGk0gHE0hGk0gGk0gHE0iFk0hGE0gGk0hFk0iFk0hEE0hFE0hF00gG0sgFEwpEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhFkosEE0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0sjH0wsEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhF0ogEE0gEE0nEE0gEE0nH00gEU0gEE0nEE0gEE0nH00gEU0gEE0nEE0gEE0nH00gEU0gEE0nEE0gEE0nH00gEU0gEE0nEE0gEE0nH00gEU0gEE0nEE0gEE0nH00gEU0gEE0nEE0gEE0nH00gEU0gEE0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wmGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhF0okEE0gEU0nEE0gEE0nH00gEU0gEU0nEE0gEE0nH00gEU0gEU0nEE0gEE0nH00gEU0gEU0nEE0gEE0nH00gEU0gEU0nEE0gEE0nH00gEU0gEU0nEE0gEE0nH00gEU0gEU0nEE0gEE0nH00gEU0gEU0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wnEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhF0ooEE0gEk0nEE0gEE0nH00gEU0gEk0nEE0gEE0nH00gEU0gEk0nEE0gEE0nH00gEU0gEk0nEE0gEE0nH00gEU0gEk0nEE0gEE0nH00gEU0gEk0nEE0gEE0nH00gEU0gEk0nEE0gEE0nH00gEU0gEk0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wnGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhF0osEE0gE00nEE0gEE0nH00gEU0gE00nEE0gEE0nH00gEU0gE00nEE0gEE0nH00gEU0gE00nEE0gEE0nH00gEU0gE00nEE0gEE0nH00gEU0gE00nEE0gEE0nH00gEU0gE00nEE0gEE0nH00gEU0gE00nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0woEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGEogEE0gFE0nEE0gEE0nH00gEU0gFE0nEE0gEE0nH00gEU0gFE0nEE0gEE0nH00gEU0gFE0nEE0gEE0nH00gEU0gFE0nEE0gEE0nH00gEU0gFE0nEE0gEE0nH00gEU0gFE0nEE0gEE0nH00gEU0gFE0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0woGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGEokEE0gFU0nEE0gEE0nH00gEU0gFU0nEE0gEE0nH00gEU0gFU0nEE0gEE0nH00gEU0gFU0nEE0gEE0nH00gEU0gFU0nEE0gEE0nH00gEU0gFU0nEE0gEE0nH00gEU0gFU0nEE0gEE0nH00gEU0gFU0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wpEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGEooEE0gFk0nEE0gEE0nH00gEU0gFk0nEE0gEE0nH00gEU0gFk0nEE0gEE0nH00gEU0gFk0nEE0gEE0nH00gEU0gFk0nEE0gEE0nH00gEU0gFk0nEE0gEE0nH00gEU0gFk0nEE0gEE0nH00gEU0gFk0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wpGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGEosEE0gF00nEE0gEE0nH00gEU0gF00nEE0gEE0nH00gEU0gF00nEE0gEE0nH00gEU0gF00nEE0gEE0nH00gEU0gF00nEE0gEE0nH00gEU0gF00nEE0gEE0nH00gEU0gF00nEE0gEE0nH00gEU0gF00nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wqEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGUogEE0gGE0nEE0gEE0nH00gEU0gGE0nEE0gEE0nH00gEU0gGE0nEE0gEE0nH00gEU0gGE0nEE0gEE0nH00gEU0gGE0nEE0gEE0nH00gEU0gGE0nEE0gEE0nH00gEU0gGE0nEE0gEE0nH00gEU0gGE0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wqGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGUokEE0gGU0nEE0gEE0nH00gEU0gGU0nEE0gEE0nH00gEU0gGU0nEE0gEE0nH00gEU0gGU0nEE0gEE0nH00gEU0gGU0nEE0gEE0nH00gEU0gGU0nEE0gEE0nH00gEU0gGU0nEE0gEE0nH00gEU0gGU0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wrEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGUooEE0gGk0nEE0gEE0nH00gEU0gGk0nEE0gEE0nH00gEU0gGk0nEE0gEE0nH00gEU0gGk0nEE0gEE0nH00gEU0gGk0nEE0gEE0nH00gEU0gGk0nEE0gEE0nH00gEU0gGk0nEE0gEE0nH00gEU0gGk0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wrGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGUosEE0gG00nEE0gEE0nH00gEU0gG00nEE0gEE0nH00gEU0gG00nEE0gEE0nH00gEU0gG00nEE0gEE0nH00gEU0gG00nEE0gEE0nH00gEU0gG00nEE0gEE0nH00gEU0gG00nEE0gEE0nH00gEU0gG00nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wsEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGkogEE0gHE0nEE0gEE0nH00gEU0gHE0nEE0gEE0nH00gEU0gHE0nEE0gEE0nH00gEU0gHE0nEE0gEE0nH00gEU0gHE0nEE0gEE0nH00gEU0gHE0nEE0gEE0nH00gEU0gHE0nEE0gEE0nH00gEU0gHE0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wsGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGkokEE0gHU0nEE0gEE0nH00gEU0gHU0nEE0gEE0nH00gEU0gHU0nEE0gEE0nH00gEU0gHU0nEE0gEE0nH00gEU0gHU0nEE0gEE0nH00gEU0gHU0nEE0gEE0nH00gEU0gHU0nEE0gEE0nH00gEU0gHU0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wtEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGkooEE0gHk0nEE0gEE0nH00gEU0gHk0nEE0gEE0nH00gEU0gHk0nEE0gEE0nH00gEU0gHk0nEE0gEE0nH00gEU0gHk0nEE0gEE0nH00gEU0gHk0nEE0gEE0nH00gEU0gHk0nEE0gEE0nH00gEU0gHk0nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wtGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhGkosEE0gH00nEE0gEE0nH00gEU0gH00nEE0gEE0nH00gEU0gH00nEE0gEE0nH00gEU0gH00nEE0gEE0nH00gEU0gH00nEE0gEE0nH00gEU0gH00nEE0gEE0nH00gEU0gH00nEE0gEE0nH00gEU0gH00nEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shH0wuEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhG0ogEE0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shHUwtEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhG0okEE0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0gHU0jEE0gEE0nH00gEU0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0shHUwtEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhG0ooEE0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0sjH0wsEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhG0osEE0vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH00vH0sjH0wsEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhHEogEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEE0iEEsgGEwgEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhHEokEE0gGE0gGU0gGk0gG00gHE0gHU0gHk0gH00hEE0hEU0hEk0hE00hFE0hFU0hFk0hF00hGE0hGU0hGk0hG00hHE0hHU0hHk0hH00iEE0iEU0iEk0iE00iFE0iFU0iFk0iF00kGE0kGU0kGk0kG00kHE0kHU0kHk0kH00lEE0lEU0lEk0lE00lFE0lFU0lFk0lF00lGE0lGU0lGk0lG00lHE0lHU0lHk0lH00mEE0mEU0mEk0mE00mFE0mFU0mFk0mF0sgHUwuEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhHEooEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEE0gEEsgEEwgEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEkhHEosEE0nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH00nH0shH0wsEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`;
        
        function loadEmbeddedSysEx() {
            try {
                // Decode base64 to binary
                const binaryString = atob(EMBEDDED_SYSEX_BASE64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                sysexTemplate = bytes;
                sysexInfo = {
                    filename: 'Factory Defaults (embedded)',
                    size: bytes.length,
                    valid: validateFaderfoxDevice(bytes)
                };
                
                updateSysExStatus();
                
                if (sysexInfo.valid) {
                    parseTemplateIntoConfig();
                    const sections = findAllSections(sysexTemplate);
                    console.log(`‚úì Auto-loaded embedded UC4 SysEx - ${sections.length} sections found`);
                }
            } catch (err) {
                console.error('Failed to load embedded SysEx:', err);
            }
        }
        
        function updateSysExStatus() {
            const indicator = document.getElementById('sysexIndicator');
            const info = document.getElementById('sysexInfo');
            
            if (sysexTemplate && sysexInfo.valid) {
                indicator.classList.add('loaded');
                const sections = findAllSections(sysexTemplate);
                const setupCount = sysexTemplate.length > 50000 ? '18 setups' : '1 setup';
                info.innerHTML = `
                    <strong>‚úì UC4 backup loaded: ${sysexInfo.filename}</strong><br>
                    <span class="details">${sysexInfo.size.toLocaleString()} bytes | ${setupCount} | ${sections.length} sections detected | Ready for editing</span>
                `;
            } else if (sysexTemplate) {
                indicator.classList.remove('loaded');
                info.innerHTML = `
                    <strong>‚ö†Ô∏è File loaded - format unrecognized</strong><br>
                    <span class="details">${sysexInfo.filename} (${sysexInfo.size.toLocaleString()} bytes) - May not be a UC4 backup</span>
                `;
            } else {
                indicator.classList.remove('loaded');
                info.innerHTML = `
                    <strong>No SysEx template loaded</strong><br>
                    <span class="details">Load your UC4 backup .syx file to enable editing</span>
                `;
            }
        }
        
        async function importSysExTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.syx';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const buffer = await file.arrayBuffer();
                    sysexTemplate = new Uint8Array(buffer);
                    sysexInfo = {
                        filename: file.name,
                        size: sysexTemplate.length,
                        valid: validateFaderfoxDevice(sysexTemplate)
                    };
                    
                    updateSysExStatus();
                    
                    if (sysexInfo.valid) {
                        parseTemplateIntoConfig();
                        const sections = findAllSections(sysexTemplate);
                        showStatus(`‚úì Loaded ${file.name} - ${sections.length} sections found, ready to edit`);
                    } else {
                        showStatus(`‚ö†Ô∏è Loaded ${file.name} - format not recognized as UC4 backup`, true);
                    }
                } catch (err) {
                    showStatus('Error loading SysEx: ' + err.message, true);
                }
            };
            
            input.click();
        }

        // ============================================
        // SYSEX PARSING (Template ‚Üí Config)
        // ============================================
        
        function findAllSections(template) {
            const sections = [];
            
            for (let i = 0; i < template.length - 20; i++) {
                // Look for section marker: 4A XX 10
                if (template[i] === 0x4A && template[i + 2] === 0x10) {
                    const sectionType = template[i + 1];
                    const sectionName = {
                        [FADERFOX.SECTIONS.ENCODERS]: 'encoders',
                        [FADERFOX.SECTIONS.FADERS]: 'faders',
                        [FADERFOX.SECTIONS.BUTTONS]: 'buttons',
                        [FADERFOX.SECTIONS.PUSHBUTTONS]: 'pushbuttons'
                    }[sectionType];
                    
                    if (sectionName) {
                        sections.push({
                            type: sectionName,
                            marker: sectionType,
                            offset: i
                        });
                    }
                }
            }
            
            return sections;
        }
        
        function parseTemplateIntoConfig() {
            if (!sysexTemplate) return;
            
            const sections = findAllSections(sysexTemplate);
            
            // Count sections per type to determine group mapping
            const counts = { encoders: 0, faders: 0, buttons: 0, pushbuttons: 0 };
            
            sections.forEach(section => {
                const groupNum = counts[section.type] + 1;
                counts[section.type]++;
                
                if (groupNum > 8) return;
                
                // Parse controls from this section
                const dataStart = section.offset + 3; // After 4A XX 10
                
                // Each control = 4 triplets (12 bytes), CC is in triplet 3 (offset 9)
                // First 8 entries = controls 1-8, next 8 = duplicate (half 2)
                const controlCount = section.type === 'faders' ? 9 : 8;
                
                for (let ctrl = 0; ctrl < controlCount; ctrl++) {
                    const tripletBase = dataStart + (ctrl * 4 * 3);
                    const ccTripletOffset = tripletBase + 9; // Triplet 3
                    
                    if (ccTripletOffset + 2 < sysexTemplate.length && sysexTemplate[ccTripletOffset] === 0x4D) {
                        const xx = sysexTemplate[ccTripletOffset + 1];
                        const yy = sysexTemplate[ccTripletOffset + 2];
                        const { cc, channel } = decodeCC(xx, yy);
                        
                        if (config[section.type][groupNum] && config[section.type][groupNum][ctrl + 1]) {
                            config[section.type][groupNum][ctrl + 1].cc = cc;
                            config[section.type][groupNum][ctrl + 1].channel = channel;
                        }
                    }
                }
            });
            
            renderGrid();
            renderCards();
            updateValidationBar();
        }

        // ============================================
        // SYSEX GENERATION (Config ‚Üí Template)
        // CRITICAL: Must update BOTH halves!
        // ============================================
        
        function generateSysEx() {
            if (!sysexTemplate) {
                showStatus('‚ö†Ô∏è Load a UC4 backup first!', true);
                return null;
            }
            
            // Clone template
            const sysex = new Uint8Array(sysexTemplate);
            const sections = findAllSections(sysex);
            const counts = { encoders: 0, faders: 0, buttons: 0, pushbuttons: 0 };
            
            let patchCount = 0;
            
            sections.forEach(section => {
                const groupNum = counts[section.type] + 1;
                counts[section.type]++;
                
                if (groupNum > 8) return;
                
                const dataStart = section.offset + 3;
                const controlCount = section.type === 'faders' ? 9 : 8;
                
                for (let ctrl = 0; ctrl < controlCount; ctrl++) {
                    const ctrlConfig = config[section.type][groupNum]?.[ctrl + 1];
                    if (!ctrlConfig) continue;
                    
                    const { xx, yy } = encodeCC(ctrlConfig.cc || 0, ctrlConfig.channel || 1);
                    
                    // CRITICAL: Update BOTH halves (first 8 entries AND duplicate 8)
                    // Half 1: controls 0-7 (or 0-8 for faders)
                    const half1Offset = dataStart + (ctrl * 4 * 3) + 9;
                    if (half1Offset + 2 < sysex.length && sysex[half1Offset] === 0x4D) {
                        sysex[half1Offset + 1] = xx;
                        sysex[half1Offset + 2] = yy;
                        patchCount++;
                    }
                    
                    // Half 2: controls 8-15 (duplicate)
                    const half2Offset = dataStart + ((ctrl + 8) * 4 * 3) + 9;
                    if (half2Offset + 2 < sysex.length && sysex[half2Offset] === 0x4D) {
                        sysex[half2Offset + 1] = xx;
                        sysex[half2Offset + 2] = yy;
                        patchCount++;
                    }
                }
            });
            
            console.log(`Patched ${patchCount} bytes in SysEx`);
            return sysex;
        }
        
        function downloadSysEx() {
            if (!sysexTemplate) {
                if (confirm('No SysEx template loaded.\n\nYou need to load your UC4 backup first.\n\nLoad one now?')) {
                    importSysExTemplate();
                }
                return;
            }
            
            const { conflicts } = runValidation();
            if (conflicts.length > 0) {
                if (!confirm(`‚ö†Ô∏è ${conflicts.length} CC conflict(s) detected.\n\nDownload anyway?`)) {
                    return;
                }
            }
            
            const sysex = generateSysEx();
            if (!sysex) return;
            
            const blob = new Blob([sysex], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `UC4_Setup${config.setup}_patched.syx`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus(`‚úì Downloaded UC4_Setup${config.setup}_patched.syx (${sysex.length.toLocaleString()} bytes)`);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        function initConfig() {
            for (let g = 1; g <= 8; g++) {
                config.faders[g] = {};
                config.encoders[g] = {};
                config.buttons[g] = {};
                config.pushbuttons[g] = {};
                
                for (let i = 1; i <= 9; i++) {
                    config.faders[g][i] = {
                        cc: FACTORY_FADERS[g-1][i-1],
                        channel: config.setup,
                        type: 'ccabs',
                        mode: 'jump',
                        lower: 0,
                        upper: 127
                    };
                }
                
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = {
                        cc: FACTORY_ENCODERS[g-1][i-1],
                        channel: config.setup,
                        type: 'ccabs',
                        accel: 'acc3',
                        display: 'std',
                        lower: 0,
                        upper: 127
                    };
                    config.buttons[g][i] = {
                        cc: FACTORY_BUTTONS[g-1][i-1],
                        channel: config.setup,
                        type: 'note',
                        mode: 'momentary',
                        lower: 0,
                        upper: 127
                    };
                    config.pushbuttons[g][i] = {
                        cc: FACTORY_PUSHBUTTONS[g-1][i-1],
                        channel: config.setup,
                        type: 'note',
                        mode: 'momentary',
                        lower: 0,
                        upper: 127
                    };
                }
            }
        }

        // ============================================
        // CONFLICT DETECTION
        // ============================================
        
        function detectConflicts() {
            const conflicts = [];
            const ccMap = new Map();
            
            for (let g = 1; g <= 8; g++) {
                for (let i = 1; i <= 9; i++) {
                    const f = config.faders[g][i];
                    const key = `${f.cc}:${f.channel}`;
                    if (!ccMap.has(key)) ccMap.set(key, []);
                    ccMap.get(key).push({ type: 'fader', group: g, num: i, cc: f.cc, channel: f.channel });
                }
                
                for (let i = 1; i <= 8; i++) {
                    const e = config.encoders[g][i];
                    const key = `${e.cc}:${e.channel}`;
                    if (!ccMap.has(key)) ccMap.set(key, []);
                    ccMap.get(key).push({ type: 'encoder', group: g, num: i, cc: e.cc, channel: e.channel });
                }
            }
            
            for (const [key, locations] of ccMap) {
                if (locations.length > 1) {
                    conflicts.push({ cc: locations[0].cc, channel: locations[0].channel, locations });
                }
            }
            
            return conflicts;
        }
        
        function getConflictSet() {
            const conflicts = detectConflicts();
            const conflictSet = new Set();
            
            for (const c of conflicts) {
                for (const loc of c.locations) {
                    conflictSet.add(`${loc.type}:${loc.group}:${loc.num}`);
                }
            }
            
            return conflictSet;
        }

        // ============================================
        // VALIDATION
        // ============================================
        
        function runValidation() {
            const results = [];
            const conflicts = detectConflicts();
            
            if (conflicts.length === 0) {
                results.push({ status: 'ok', message: 'No CC conflicts' });
            } else {
                results.push({ status: 'error', message: `${conflicts.length} CC conflict${conflicts.length > 1 ? 's' : ''}` });
            }
            
            const faderGroups5to8Same = 
                JSON.stringify(config.faders[5]) === JSON.stringify(config.faders[6]) &&
                JSON.stringify(config.faders[6]) === JSON.stringify(config.faders[7]) &&
                JSON.stringify(config.faders[7]) === JSON.stringify(config.faders[8]);
            
            if (faderGroups5to8Same) {
                results.push({ status: 'warning', message: 'Fader groups 5-8 identical' });
            }
            
            if (sysexTemplate && sysexInfo.valid) {
                results.push({ status: 'ok', message: 'SysEx template ready' });
            } else if (sysexTemplate) {
                results.push({ status: 'warning', message: 'SysEx unverified' });
            } else {
                results.push({ status: 'warning', message: 'No SysEx loaded' });
            }
            
            return { results, conflicts };
        }
        
        function updateValidationBar() {
            const { results, conflicts } = runValidation();
            const bar = document.getElementById('validationBar');
            
            bar.innerHTML = results.map(r => `
                <div class="validation-item ${r.status}">
                    ${r.status === 'ok' ? '‚úì' : r.status === 'warning' ? '‚ö†' : '‚úó'} ${r.message}
                </div>
            `).join('');
            
            const detailsPanel = document.getElementById('conflictDetails');
            const conflictList = document.getElementById('conflictList');
            
            if (conflicts.length > 0) {
                detailsPanel.classList.remove('hidden');
                conflictList.innerHTML = conflicts.map(c => {
                    const locs = c.locations.map(l => 
                        `${l.type.charAt(0).toUpperCase() + l.type.slice(1)} ${l.num} (G${l.group})`
                    ).join(', ');
                    return `<li>CC ${c.cc} Ch ${c.channel}: ${locs}</li>`;
                }).join('');
            } else {
                detailsPanel.classList.add('hidden');
            }
        }

        // ============================================
        // GRID RENDERING
        // ============================================
        
        function renderGrid() {
            const grid = document.getElementById('mainGrid');
            const viewMode = document.getElementById('viewMode').value;
            const conflictSet = getConflictSet();
            
            let html = '<thead><tr>';
            html += '<th class="group-header">Grp</th>';
            html += '<th>Ch</th>';
            
            if (viewMode === 'grid' || viewMode === 'faders') {
                for (let i = 1; i <= 9; i++) html += `<th>F${i}</th>`;
            }
            if (viewMode === 'grid' || viewMode === 'encoders') {
                for (let i = 1; i <= 8; i++) html += `<th>E${i}</th>`;
            }
            if (viewMode === 'grid' || viewMode === 'buttons') {
                for (let i = 1; i <= 8; i++) html += `<th>B${i}</th>`;
                for (let i = 1; i <= 8; i++) html += `<th>P${i}</th>`;
            }
            
            html += '</tr></thead><tbody>';
            
            for (let g = 1; g <= 8; g++) {
                html += '<tr>';
                html += `<td class="group-cell">${g}</td>`;
                
                const ch = config.faders[g][1].channel;
                html += `<td class="channel-cell">
                    <input type="number" min="1" max="16" value="${ch}" 
                           onchange="updateGroupChannel(${g}, this.value)">
                </td>`;
                
                if (viewMode === 'grid' || viewMode === 'faders') {
                    for (let i = 1; i <= 9; i++) {
                        const f = config.faders[g][i];
                        const isConflict = conflictSet.has(`fader:${g}:${i}`);
                        html += `<td${isConflict ? ' class="conflict"' : ''}>
                            <input type="number" min="0" max="127" value="${f.cc}" 
                                   onchange="updateCC('faders', ${g}, ${i}, this.value)">
                        </td>`;
                    }
                }
                
                if (viewMode === 'grid' || viewMode === 'encoders') {
                    for (let i = 1; i <= 8; i++) {
                        const e = config.encoders[g][i];
                        const isConflict = conflictSet.has(`encoder:${g}:${i}`);
                        html += `<td${isConflict ? ' class="conflict"' : ''}>
                            <input type="number" min="0" max="127" value="${e.cc}" 
                                   onchange="updateCC('encoders', ${g}, ${i}, this.value)">
                        </td>`;
                    }
                }
                
                if (viewMode === 'grid' || viewMode === 'buttons') {
                    for (let i = 1; i <= 8; i++) {
                        const b = config.buttons[g][i];
                        html += `<td><input type="number" min="0" max="127" value="${b.cc}" 
                                   onchange="updateCC('buttons', ${g}, ${i}, this.value)"></td>`;
                    }
                    for (let i = 1; i <= 8; i++) {
                        const p = config.pushbuttons[g][i];
                        html += `<td><input type="number" min="0" max="127" value="${p.cc}" 
                                   onchange="updateCC('pushbuttons', ${g}, ${i}, this.value)"></td>`;
                    }
                }
                
                html += '</tr>';
            }
            
            html += '</tbody>';
            grid.innerHTML = html;
            updateValidationBar();
        }
        
        function updateCC(type, group, num, value) {
            config[type][group][num].cc = parseInt(value) || 0;
            renderGrid();
            renderCards();
        }
        
        function updateGroupChannel(group, value) {
            const ch = parseInt(value) || 1;
            for (let i = 1; i <= 9; i++) config.faders[group][i].channel = ch;
            for (let i = 1; i <= 8; i++) {
                config.encoders[group][i].channel = ch;
                config.buttons[group][i].channel = ch;
                config.pushbuttons[group][i].channel = ch;
            }
            renderGrid();
            renderCards();
        }

        // ============================================
        // CARD VIEW RENDERING
        // ============================================
        
        function switchCardSection(section) {
            config.cardSection = section;
            document.querySelectorAll('.card-tab').forEach((tab, i) => {
                const sections = ['encoders', 'faders', 'buttons', 'pushbuttons'];
                tab.classList.toggle('active', sections[i] === section);
            });
            renderCards();
        }
        
        function switchCardGroup(group) {
            config.cardGroup = group;
            document.querySelectorAll('.group-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === group);
            });
            renderCards();
        }
        
        function renderCards() {
            const grid = document.getElementById('cardsGrid');
            const section = config.cardSection;
            const group = config.cardGroup;
            const conflictSet = getConflictSet();
            
            let html = '';
            const count = section === 'faders' ? 9 : 8;
            
            for (let i = 1; i <= count; i++) {
                const ctrl = config[section][group][i];
                const isConflict = conflictSet.has(`${section === 'faders' ? 'fader' : section.slice(0, -1)}:${group}:${i}`);
                
                html += `
                    <div class="control-card${isConflict ? ' conflict' : ''}">
                        <div class="control-card-header">
                            <span class="control-card-name">${section.charAt(0).toUpperCase() + section.slice(1, -1)} ${i}</span>
                            <span class="control-card-badge">${ctrl.type || 'ccabs'}</span>
                        </div>
                        <div class="control-card-row">
                            <div class="control-card-field">
                                <label>CC/Note</label>
                                <input type="number" min="0" max="127" value="${ctrl.cc}" 
                                       onchange="updateCardControl('${section}', ${i}, 'cc', this.value)">
                            </div>
                            <div class="control-card-field">
                                <label>Channel</label>
                                <input type="number" min="1" max="16" value="${ctrl.channel}" 
                                       onchange="updateCardControl('${section}', ${i}, 'channel', this.value)">
                            </div>
                        </div>
                        <div class="control-card-row">
                            <div class="control-card-field">
                                <label>Lower</label>
                                <input type="number" min="0" max="127" value="${ctrl.lower}" 
                                       onchange="updateCardControl('${section}', ${i}, 'lower', this.value)">
                            </div>
                            <div class="control-card-field">
                                <label>Upper</label>
                                <input type="number" min="0" max="127" value="${ctrl.upper}" 
                                       onchange="updateCardControl('${section}', ${i}, 'upper', this.value)">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            updateValidationBar();
        }
        
        function updateCardControl(section, num, prop, value) {
            const group = config.cardGroup;
            config[section][group][num][prop] = value === '' ? '' : parseInt(value);
            renderCards();
            renderGrid();
        }

        // ============================================
        // TEMPLATES
        // ============================================
        
        function loadTemplate(name) {
            switch(name) {
                case 'factory':
                    loadFactoryDefaults();
                    break;
                case 'channelPerGroup':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 9; i++) {
                            config.faders[g][i] = { cc: i - 1, channel: g, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: 10 + i - 1, channel: g, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: 20 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: 30 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
                case 'dawMixer':
                    for (let g = 1; g <= 8; g++) {
                        const offset = (g - 1) * 17;
                        for (let i = 1; i <= 9; i++) {
                            config.faders[g][i] = { cc: offset + i - 1, channel: 1, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: offset + 9 + i - 1, channel: 1, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: offset + i - 1, channel: 2, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: offset + 9 + i - 1, channel: 2, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
                case 'multiSynth':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 9; i++) {
                            config.faders[g][i] = { cc: i - 1, channel: g, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: 10 + i - 1, channel: g, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: 20 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: 30 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
                case 'noiseEngineering':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 8; i++) {
                            config.faders[g][i] = { cc: i, channel: g, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        config.faders[g][9] = { cc: 7, channel: g, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: 70 + i - 1, channel: g, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: 80 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: 90 + i - 1, channel: g, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
                case 'blank':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 9; i++) {
                            config.faders[g][i] = { cc: 0, channel: 1, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                        }
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { cc: 0, channel: 1, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                            config.buttons[g][i] = { cc: 0, channel: 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.pushbuttons[g][i] = { cc: 0, channel: 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                    }
                    break;
            }
            
            closeModal('templatesModal');
            renderGrid();
            renderCards();
            showStatus(`‚úì Loaded template: ${name}`);
        }
        
        function loadNoiseEngine() {
            // Your custom 8-slot texture synth configuration
            const encoderDef = [
                { cc: 10 }, { cc: 72 }, { cc: 75 }, { cc: 80 },
                { cc: 20 }, { cc: 21 }, { cc: 22 }, { cc: 23 }
            ];
            const faderDef = [
                { cc: 7 }, { cc: 71 }, { cc: 73 }, { cc: 74 },
                { cc: 76 }, { cc: 77 }, { cc: 78 }, { cc: 79 }, { cc: 11 }
            ];
            const buttonDef = [
                { cc: 32 }, { cc: 33 }, { cc: 34 }, { cc: 35 },
                { cc: 36 }, { cc: 37 }, { cc: 38 }, { cc: 39 }
            ];
            const pushDef = [
                { cc: 24 }, { cc: 25 }, { cc: 26 }, { cc: 27 },
                { cc: 28 }, { cc: 29 }, { cc: 30 }, { cc: 31 }
            ];
            
            for (let g = 1; g <= 8; g++) {
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = { 
                        cc: encoderDef[i-1].cc, channel: g, type: 'ccabs',
                        accel: 'acc2', display: 'std', lower: 0, upper: 127 
                    };
                }
                for (let i = 1; i <= 9; i++) {
                    config.faders[g][i] = { 
                        cc: faderDef[i-1].cc, channel: g, type: 'ccabs',
                        mode: 'snap', lower: 0, upper: 127 
                    };
                }
                for (let i = 1; i <= 8; i++) {
                    config.buttons[g][i] = { 
                        cc: buttonDef[i-1].cc, channel: g, type: 'cc',
                        mode: 'toggle', lower: 0, upper: 127 
                    };
                    config.pushbuttons[g][i] = { 
                        cc: pushDef[i-1].cc, channel: g, type: 'cc',
                        mode: 'momentary', lower: 0, upper: 127 
                    };
                }
            }
            
            closeModal('templatesModal');
            renderGrid();
            renderCards();
            showStatus('üéõÔ∏è Noise Engine template loaded');
        }
        
        function loadFactoryDefaults() {
            for (let g = 1; g <= 8; g++) {
                for (let i = 1; i <= 9; i++) {
                    config.faders[g][i] = {
                        cc: FACTORY_FADERS[g-1][i-1], channel: config.setup,
                        type: 'ccabs', mode: 'jump', lower: 0, upper: 127
                    };
                }
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = {
                        cc: FACTORY_ENCODERS[g-1][i-1], channel: config.setup,
                        type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127
                    };
                    config.buttons[g][i] = {
                        cc: FACTORY_BUTTONS[g-1][i-1], channel: config.setup,
                        type: 'note', mode: 'momentary', lower: 0, upper: 127
                    };
                    config.pushbuttons[g][i] = {
                        cc: FACTORY_PUSHBUTTONS[g-1][i-1], channel: config.setup,
                        type: 'note', mode: 'momentary', lower: 0, upper: 127
                    };
                }
            }
            renderGrid();
            renderCards();
            showStatus('Factory defaults loaded');
        }
        
        function clearAll() {
            if (!confirm('Clear all CC assignments?')) return;
            
            for (let g = 1; g <= 8; g++) {
                for (let i = 1; i <= 9; i++) {
                    config.faders[g][i] = { cc: 0, channel: 1, type: 'ccabs', mode: 'jump', lower: 0, upper: 127 };
                }
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = { cc: 0, channel: 1, type: 'ccabs', accel: 'acc3', display: 'std', lower: 0, upper: 127 };
                    config.buttons[g][i] = { cc: 0, channel: 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                    config.pushbuttons[g][i] = { cc: 0, channel: 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                }
            }
            renderGrid();
            renderCards();
            showStatus('All CCs cleared');
        }

        // ============================================
        // JSON IMPORT/EXPORT
        // ============================================
        
        function exportJSON() {
            const data = {
                version: 4,
                setup: config.setup,
                exported: new Date().toISOString(),
                protocol: 'Faderfox UC4 (verified)',
                faders: config.faders,
                encoders: config.encoders,
                buttons: config.buttons,
                pushbuttons: config.pushbuttons
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `UC4_Setup${config.setup}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('JSON exported');
        }
        
        function importJSON() {
            const textarea = document.getElementById('importTextarea');
            
            try {
                const data = JSON.parse(textarea.value);
                
                if (data.faders) config.faders = data.faders;
                if (data.encoders) config.encoders = data.encoders;
                if (data.buttons) config.buttons = data.buttons;
                if (data.pushbuttons) config.pushbuttons = data.pushbuttons;
                if (data.setup) {
                    config.setup = data.setup;
                    document.getElementById('setupSelect').value = data.setup;
                }
                
                closeModal('importModal');
                renderGrid();
                renderCards();
                showStatus('‚úì JSON imported');
            } catch (e) {
                showStatus('Invalid JSON: ' + e.message, true);
            }
        }

        // ============================================
        // COPY FUNCTIONALITY
        // ============================================
        
        function updateCopyPreview() {
            const fromGroup = parseInt(document.getElementById('copyFromGroup').value);
            const what = document.getElementById('copyWhat').value;
            const target = document.getElementById('copyTarget').value;
            
            let html = '<table class="protocol-table" style="width:100%"><thead><tr><th>Grp</th>';
            
            if (target === 'faders' || target === 'all') {
                for (let i = 1; i <= 9; i++) html += `<th>F${i}</th>`;
            }
            if (target === 'encoders' || target === 'all') {
                for (let i = 1; i <= 8; i++) html += `<th>E${i}</th>`;
            }
            
            html += '</tr></thead><tbody>';
            
            for (let g = 1; g <= 8; g++) {
                html += `<tr><td>${g}</td>`;
                
                if (target === 'faders' || target === 'all') {
                    for (let i = 1; i <= 9; i++) {
                        const current = config.faders[g][i].cc;
                        const source = config.faders[fromGroup][i].cc;
                        const willChange = g !== fromGroup && (what === 'cc' || what === 'both');
                        const newVal = willChange ? source : current;
                        html += `<td style="${willChange && current !== newVal ? 'color:var(--accent-orange)' : ''}">${newVal}</td>`;
                    }
                }
                
                if (target === 'encoders' || target === 'all') {
                    for (let i = 1; i <= 8; i++) {
                        const current = config.encoders[g][i].cc;
                        const source = config.encoders[fromGroup][i].cc;
                        const willChange = g !== fromGroup && (what === 'cc' || what === 'both');
                        const newVal = willChange ? source : current;
                        html += `<td style="${willChange && current !== newVal ? 'color:var(--accent-orange)' : ''}">${newVal}</td>`;
                    }
                }
                
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            document.getElementById('copyPreviewContent').innerHTML = html;
        }
        
        function applyCopy() {
            const fromGroup = parseInt(document.getElementById('copyFromGroup').value);
            const what = document.getElementById('copyWhat').value;
            const target = document.getElementById('copyTarget').value;
            
            for (let g = 1; g <= 8; g++) {
                if (g === fromGroup) continue;
                
                ['faders', 'encoders', 'buttons', 'pushbuttons'].forEach(type => {
                    if (target !== type && target !== 'all') return;
                    const count = type === 'faders' ? 9 : 8;
                    for (let i = 1; i <= count; i++) {
                        if (what === 'cc' || what === 'both') {
                            config[type][g][i].cc = config[type][fromGroup][i].cc;
                        }
                        if (what === 'channel' || what === 'both') {
                            config[type][g][i].channel = config[type][fromGroup][i].channel;
                        }
                    }
                });
            }
            
            closeModal('copyModal');
            renderGrid();
            renderCards();
            showStatus('Settings copied');
        }

        // ============================================
        // UI HELPERS
        // ============================================
        
        function toggleProtocol() {
            const content = document.getElementById('protocolContent');
            const toggle = document.getElementById('protocolToggle');
            content.classList.toggle('show');
            toggle.textContent = content.classList.contains('show') ? '‚ñº Hide' : '‚ñ∂ Show';
        }
        
        function showTemplates() {
            document.getElementById('templatesModal').classList.add('show');
        }
        
        function showCopyPreview() {
            updateCopyPreview();
            document.getElementById('copyModal').classList.add('show');
        }
        
        function showImportJSON() {
            document.getElementById('importTextarea').value = '';
            document.getElementById('importModal').classList.add('show');
        }
        
        function showValidation() {
            const { results, conflicts } = runValidation();
            
            let html = '<div>';
            results.forEach(r => {
                const icon = r.status === 'ok' ? '‚úÖ' : r.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
                const color = r.status === 'ok' ? 'var(--accent-primary)' : 
                              r.status === 'warning' ? 'var(--accent-orange)' : 'var(--accent-red)';
                html += `<div style="padding: 0.5rem; color: ${color}; display: flex; align-items: center; gap: 0.5rem;">
                    ${icon} ${r.message}
                </div>`;
            });
            
            if (conflicts.length > 0) {
                html += '<hr style="border-color: var(--border-color); margin: 1rem 0;">';
                html += '<h4 style="color: var(--accent-red); margin-bottom: 0.5rem;">Conflict Details:</h4>';
                html += '<ul style="font-size: 0.8rem; color: var(--text-secondary); padding-left: 1.5rem;">';
                conflicts.forEach(c => {
                    const locs = c.locations.map(l => `${l.type} ${l.num} (G${l.group})`).join(', ');
                    html += `<li style="margin: 0.3rem 0;">CC ${c.cc} Ch ${c.channel}: ${locs}</li>`;
                });
                html += '</ul>';
            }
            
            html += '</div>';
            
            document.getElementById('validationReport').innerHTML = html;
            document.getElementById('validationModal').classList.add('show');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        function changeSetup() {
            config.setup = parseInt(document.getElementById('setupSelect').value);
            showStatus(`Setup ${config.setup} selected`);
        }
        
        function changeView() {
            const viewMode = document.getElementById('viewMode').value;
            const gridContainer = document.getElementById('gridContainer');
            const cardContainer = document.getElementById('cardViewContainer');
            
            if (viewMode === 'cards') {
                gridContainer.classList.add('hidden');
                cardContainer.classList.remove('hidden');
                renderCards();
            } else {
                gridContainer.classList.remove('hidden');
                cardContainer.classList.add('hidden');
                renderGrid();
            }
        }
        
        function showStatus(message, isError = false) {
            const toast = document.getElementById('statusToast');
            toast.textContent = message;
            toast.className = 'status-toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('show');
            });
        });
        
        // Secret key: type 'ne' to load Noise Engine
        let keyBuffer = '';
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            keyBuffer += e.key.toLowerCase();
            keyBuffer = keyBuffer.slice(-10);
            if (keyBuffer.endsWith('ne')) {
                loadNoiseEngine();
                keyBuffer = '';
            }
        });

        // ============================================
        // INIT
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initConfig();
            renderCards();
            updateValidationBar();
            updateSysExStatus();
        });
    </script>
</body>
</html>
