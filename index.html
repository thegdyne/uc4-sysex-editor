<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faderfox UC4 SysEx Editor v5</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #13161c;
            --bg-tertiary: #1c2028;
            --bg-card: #171b22;
            --accent-primary: #00d4aa;
            --accent-blue: #4dabf7;
            --accent-orange: #ff922b;
            --accent-red: #ff6b6b;
            --accent-purple: #9775fa;
            --accent-yellow: #ffd43b;
            --text-primary: #e9ecef;
            --text-secondary: #868e96;
            --text-muted: #495057;
            --border-color: #2c3038;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.85rem;
            color: #000;
        }

        .logo h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .logo .version {
            font-size: 0.65rem;
            color: var(--accent-primary);
            background: rgba(0, 212, 170, 0.15);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.5rem 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn:hover {
            background: var(--border-color);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #000;
        }

        .btn-primary:hover {
            background: #00c49a;
        }

        .btn-danger {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .btn-danger:hover {
            background: var(--accent-red);
            color: #fff;
        }

        /* Main */
        .main {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .toolbar-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-right: 0.5rem;
            border-right: 1px solid var(--border-color);
            margin-right: 0.25rem;
        }

        select, input[type="text"], input[type="number"] {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .view-toggle button {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .view-toggle button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .view-toggle button.active {
            background: var(--accent-primary);
            color: #000;
        }

        /* Validation Bar */
        .validation-bar {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .validation-item.ok { color: var(--accent-primary); }
        .validation-item.warning { color: var(--accent-orange); }
        .validation-item.error { color: var(--accent-red); }

        /* Three Panel Layout */
        .panels-container {
            display: grid;
            grid-template-columns: 1fr 1fr 280px;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 1200px) {
            .panels-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 800px) {
            .panels-container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .panel-header {
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .panel-body {
            padding: 1rem;
        }

        /* Group Selector */
        .group-selector {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .group-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .group-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .group-btn.active {
            background: var(--accent-purple);
            color: #fff;
            border-color: var(--accent-purple);
        }

        /* Control Card */
        .control-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.15s;
        }

        .control-card:hover {
            border-color: var(--text-muted);
        }

        .control-card.conflict {
            border-color: var(--accent-red);
            background: rgba(255, 107, 107, 0.05);
        }

        .control-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .control-card-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .control-card-row {
            display: flex;
            gap: 0.5rem;
        }

        .control-field {
            flex: 1;
        }

        .control-field label {
            display: block;
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-bottom: 0.2rem;
            text-transform: uppercase;
        }

        .control-field input,
        .control-field select {
            width: 100%;
            padding: 0.35rem 0.4rem;
            font-size: 0.75rem;
        }

        /* All View Grid */
        .all-view-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            display: none;
        }

        .all-view-container.active {
            display: block;
        }

        .all-view-section {
            margin-bottom: 1.5rem;
        }

        .all-view-section h4 {
            font-size: 0.85rem;
            color: var(--accent-blue);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .all-view-grid {
            display: grid;
            grid-template-columns: auto repeat(8, 1fr);
            gap: 2px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
        }

        .all-view-grid .header {
            background: var(--bg-tertiary);
            padding: 0.4rem;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .all-view-grid .row-header {
            background: var(--bg-tertiary);
            padding: 0.4rem;
            text-align: center;
            color: var(--accent-purple);
            font-weight: 600;
        }

        .all-view-grid .cell {
            background: var(--bg-card);
            padding: 0.4rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .all-view-grid .cell:hover {
            background: var(--bg-tertiary);
        }

        .all-view-grid .cell.conflict {
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent-red);
        }

        /* Fader 9 Panel */
        .fader9-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .fader9-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            text-align: center;
        }

        .fader9-item .grp {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .fader9-item input {
            width: 100%;
            text-align: center;
        }

        /* Status Toast */
        .status-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .status-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .status-toast.error {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
        }

        .json-textarea {
            width: 100%;
            height: 300px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 0.75rem;
            resize: vertical;
        }

        /* Protocol Panel */
        .protocol-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .protocol-header {
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .protocol-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .protocol-toggle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .protocol-content {
            padding: 1rem;
            display: none;
        }

        .protocol-content.show {
            display: block;
        }

        .protocol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .protocol-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .protocol-card h4 {
            font-size: 0.75rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .protocol-card code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            background: var(--bg-primary);
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
            color: var(--accent-orange);
        }

        .protocol-card p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
        }

        .protocol-table {
            width: 100%;
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        .protocol-table th, .protocol-table td {
            padding: 0.2rem 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .protocol-table th {
            color: var(--text-muted);
            font-weight: 500;
        }

        /* SysEx Status */
        .sysex-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .sysex-status .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-muted);
            flex-shrink: 0;
        }

        .sysex-status .indicator.loaded {
            background: var(--accent-primary);
            box-shadow: 0 0 8px var(--accent-primary);
        }

        .sysex-status .info {
            flex: 1;
            font-size: 0.8rem;
        }

        .sysex-status .info strong {
            color: var(--accent-primary);
        }

        .sysex-status .details {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Control Type Badge */
        .control-badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Hidden file input */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">UC4</div>
                <h1>Faderfox UC4 Editor <span class="version">v5.0</span></h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="downloadSysEx()">üíæ Download SysEx</button>
                <button class="btn" onclick="showImportJSON()">üìã Import JSON</button>
                <button class="btn" onclick="exportJSON()">üì§ Export JSON</button>
                <button class="btn" onclick="showValidation()">‚úì Validate</button>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Protocol Reference Panel -->
        <div class="protocol-panel">
            <div class="protocol-header" onclick="toggleProtocol()">
                <h3>üîß UC4 SysEx Protocol Reference</h3>
                <span class="protocol-toggle" id="protocolToggle">‚ñ∂ Show</span>
            </div>
            <div class="protocol-content" id="protocolContent">
                <div class="protocol-grid">
                    <div class="protocol-card">
                        <h4>Section/Bank Structure (VERIFIED)</h4>
                        <table class="protocol-table">
                            <tr><th>Control</th><th>Ch Sec/Bank</th><th>CC Sec/Bank</th></tr>
                            <tr><td>Encoders</td><td><code>0x1C/0x00</code></td><td><code>0x1C/0x40</code></td></tr>
                            <tr><td>Push Btns</td><td><code>0x1D/0x40</code></td><td><code>0x1D/0x80</code></td></tr>
                            <tr><td>Buttons</td><td><code>0x1E/0x80</code></td><td><code>0x1E/0xC0</code></td></tr>
                            <tr><td>Faders 1-8</td><td><code>0x1F/0xC0</code></td><td><code>0x20/0x00</code></td></tr>
                            <tr><td>Fader 9</td><td colspan="2"><code>0x17/0x00</code> (5 bytes/grp)</td></tr>
                        </table>
                    </div>
                    <div class="protocol-card">
                        <h4>Channel Encoding</h4>
                        <p>Encoders/Faders: <code>0-indexed</code> (0=Ch1)</p>
                        <p>Buttons CC mode: <code>0x20 + channel</code></p>
                        <p>Buttons Note mode: <code>0x10 + channel</code></p>
                    </div>
                    <div class="protocol-card">
                        <h4>Checksum (16-bit sum)</h4>
                        <p>Format: <code>4B [hi] 4C [lo]</code></p>
                        <p>Sum all decoded values in bank</p>
                        <p>‚ö†Ô∏è Must recalculate after any edit!</p>
                    </div>
                    <div class="protocol-card">
                        <h4>Encoder Types</h4>
                        <table class="protocol-table">
                            <tr><td>0</td><td>CCr1 (Relative 1)</td></tr>
                            <tr><td>1</td><td>CCr2 (Relative 2)</td></tr>
                            <tr><td>2</td><td>CCAb (Absolute) ‚úì</td></tr>
                            <tr><td>3</td><td>PrGC (Program Change)</td></tr>
                            <tr><td>4</td><td>CCAh (14-bit)</td></tr>
                            <tr><td>5</td><td>Pbnd (Pitch Bend)</td></tr>
                            <tr><td>6</td><td>AFtt (Aftertouch)</td></tr>
                        </table>
                    </div>
                    <div class="protocol-card">
                        <h4>Button Types</h4>
                        <table class="protocol-table">
                            <tr><td>0</td><td>OFF</td></tr>
                            <tr><td>1</td><td>Note ‚úì</td></tr>
                            <tr><td>2</td><td>CC</td></tr>
                            <tr><td>3</td><td>Program Change</td></tr>
                            <tr><td>4</td><td>Aftertouch</td></tr>
                        </table>
                    </div>
                    <div class="protocol-card">
                        <h4>Send to UC4</h4>
                        <p>1. Hold Shift + Encoder 7</p>
                        <p>2. Wait for <code>rc00</code> on display</p>
                        <p>3. Send within 2-3 seconds</p>
                        <p>4. Must send full 98KB dump!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <span class="toolbar-label">Setup</span>
                <select id="setupSelect" onchange="changeSetup()">
                    <script>
                        for (let i = 1; i <= 18; i++) {
                            document.write(`<option value="${i}">${i}${i >= 17 ? ' (Ableton)' : ''}</option>`);
                        }
                    </script>
                </select>
            </div>

            <div class="view-toggle">
                <button class="active" onclick="setView('focused')">Focused</button>
                <button onclick="setView('all')">All View</button>
            </div>

            <div class="toolbar-group">
                <span class="toolbar-label">Copy</span>
                <button class="btn" onclick="showCopyModal()">Copy Settings</button>
                <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
            </div>
        </div>

        <!-- Validation Bar -->
        <div class="validation-bar" id="validationBar">
            <div class="validation-item ok">‚úî Ready</div>
        </div>

        <!-- Focused View: Three Panels -->
        <div class="panels-container" id="focusedView">
            <!-- Encoder Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3>üéõÔ∏è ENCODERS / PUSH BUTTONS</h3>
                    <input type="text" id="groupName" maxlength="4" style="width:60px;text-align:center;" 
                           placeholder="Name" onchange="updateGroupName()">
                </div>
                <div class="panel-body">
                    <div class="group-selector" id="encoderGroupSelector"></div>
                    <div id="encoderCards"></div>
                    <h4 style="margin: 1rem 0 0.5rem; color: var(--accent-orange); font-size: 0.8rem;">Push Buttons</h4>
                    <div id="pushButtonCards"></div>
                </div>
            </div>

            <!-- Fader/Button Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3>üéöÔ∏è FADERS / BUTTONS</h3>
                </div>
                <div class="panel-body">
                    <div class="group-selector" id="faderGroupSelector"></div>
                    <div id="faderCards"></div>
                    <h4 style="margin: 1rem 0 0.5rem; color: var(--accent-orange); font-size: 0.8rem;">Green Buttons</h4>
                    <div id="buttonCards"></div>
                </div>
            </div>

            <!-- Fader 9 Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3>üéöÔ∏è FADER 9</h3>
                </div>
                <div class="panel-body">
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        Fader 9 has independent settings per fader/button group.
                    </p>
                    <div class="fader9-grid" id="fader9Grid"></div>
                </div>
            </div>
        </div>

        <!-- All View -->
        <div class="all-view-container" id="allView">
            <div class="all-view-section">
                <h4>Encoders (Ch/CC)</h4>
                <div class="all-view-grid" id="allEncoders"></div>
            </div>
            <div class="all-view-section">
                <h4>Push Buttons (Ch/CC)</h4>
                <div class="all-view-grid" id="allPushButtons"></div>
            </div>
            <div class="all-view-section">
                <h4>Faders 1-8 (Ch/CC)</h4>
                <div class="all-view-grid" id="allFaders"></div>
            </div>
            <div class="all-view-section">
                <h4>Green Buttons (Ch/CC)</h4>
                <div class="all-view-grid" id="allButtons"></div>
            </div>
            <div class="all-view-section">
                <h4>Fader 9 (Ch/CC)</h4>
                <div class="all-view-grid" id="allFader9"></div>
            </div>
        </div>
    </main>

    <!-- Templates Modal -->
    <div class="modal-overlay" id="templatesModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Load Template</h2>
                <button class="modal-close" onclick="closeModal('templatesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 0.75rem;">
                    <button class="btn" style="justify-content: flex-start; padding: 1rem;" onclick="loadTemplate('noiseEngine')">
                        <span style="font-size: 1.2rem;">üéπ</span>
                        <div style="text-align: left;">
                            <strong>Noise Engine</strong><br>
                            <span style="color: var(--text-secondary); font-size: 0.7rem;">8-slot texture synth. Ch per group, standardized CCs.</span>
                        </div>
                    </button>
                    <button class="btn" style="justify-content: flex-start; padding: 1rem;" onclick="loadTemplate('channelPerGroup')">
                        <span style="font-size: 1.2rem;">üìä</span>
                        <div style="text-align: left;">
                            <strong>Channel Per Group</strong><br>
                            <span style="color: var(--text-secondary); font-size: 0.7rem;">Each group on separate MIDI channel. No conflicts.</span>
                        </div>
                    </button>
                    <button class="btn" style="justify-content: flex-start; padding: 1rem;" onclick="loadTemplate('dawMixer')">
                        <span style="font-size: 1.2rem;">üéöÔ∏è</span>
                        <div style="text-align: left;">
                            <strong>DAW Mixer</strong><br>
                            <span style="color: var(--text-secondary); font-size: 0.7rem;">All Ch 1, sequential CCs. Great for DAW control.</span>
                        </div>
                    </button>
                    <button class="btn" style="justify-content: flex-start; padding: 1rem;" onclick="loadTemplate('multiSynth')">
                        <span style="font-size: 1.2rem;">üéõÔ∏è</span>
                        <div style="text-align: left;">
                            <strong>Multi-Synth</strong><br>
                            <span style="color: var(--text-secondary); font-size: 0.7rem;">8 synths on channels 1-8. Same CCs, different channels.</span>
                        </div>
                    </button>
                    <button class="btn" style="justify-content: flex-start; padding: 1rem;" onclick="loadTemplate('factory')">
                        <span style="font-size: 1.2rem;">üè≠</span>
                        <div style="text-align: left;">
                            <strong>Factory Defaults</strong><br>
                            <span style="color: var(--text-secondary); font-size: 0.7rem;">Original UC4 settings from manual.</span>
                        </div>
                    </button>
                    <button class="btn" style="justify-content: flex-start; padding: 1rem;" onclick="loadTemplate('blank')">
                        <span style="font-size: 1.2rem;">üìÑ</span>
                        <div style="text-align: left;">
                            <strong>Blank</strong><br>
                            <span style="color: var(--text-secondary); font-size: 0.7rem;">All CC 0, Channel 1. Start from scratch.</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import JSON Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Import JSON</h2>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div class="modal-body">
                <textarea class="json-textarea" id="importTextarea" placeholder="Paste JSON here..."></textarea>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn" onclick="closeModal('importModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="importJSON()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Modal -->
    <div class="modal-overlay" id="copyModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Copy Settings</h2>
                <button class="modal-close" onclick="closeModal('copyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">From Group:</label>
                        <select id="copyFrom" style="width: 100%;">
                            <script>for(let i=1;i<=8;i++)document.write(`<option value="${i}">Group ${i}</option>`);</script>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Copy What:</label>
                        <select id="copyWhat" style="width: 100%;">
                            <option value="cc">CC Numbers Only</option>
                            <option value="channel">Channels Only</option>
                            <option value="both">Both CC and Channel</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Apply To:</label>
                        <select id="copyTarget" style="width: 100%;">
                            <option value="encoders">Encoders</option>
                            <option value="pushbuttons">Push Buttons</option>
                            <option value="faders">Faders</option>
                            <option value="buttons">Green Buttons</option>
                            <option value="all">All Controls</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn" onclick="closeModal('copyModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="applyCopy()">Apply to All Groups</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Validation Modal -->
    <div class="modal-overlay" id="validationModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Validation Report</h2>
                <button class="modal-close" onclick="closeModal('validationModal')">&times;</button>
            </div>
            <div class="modal-body" id="validationReport"></div>
        </div>
    </div>

    <div class="status-toast" id="statusToast"></div>

    <script>
        // ============================================
        // UC4 SYSEX PROTOCOL - VERIFIED MAPPINGS
        // ============================================
        
        const UC4 = {
            // Section IDs for Setup 1 (add 0x24 per setup)
            SECTIONS: {
                FADER9: 0x17,           // 5 bytes per group: [ch, cc, min, max, mode]
                ENCODER_CH: 0x1c,       // Bank 0x00
                ENCODER_CC: 0x1c,       // Bank 0x40
                PUSHBTN_CH: 0x1d,       // Bank 0x40 (value = 0x20 + channel for CC mode)
                PUSHBTN_CC: 0x1d,       // Bank 0x80
                BUTTON_CH: 0x1e,        // Bank 0x80 (value = 0x20 + channel for CC mode)
                BUTTON_CC: 0x1e,        // Bank 0xC0
                FADER_CH: 0x1f,         // Bank 0xC0
                FADER_CC: 0x20          // Bank 0x00
            },
            BANKS: {
                ENCODER_CH: 0x00,
                ENCODER_CC: 0x40,
                PUSHBTN_CH: 0x40,
                PUSHBTN_CC: 0x80,
                BUTTON_CH: 0x80,
                BUTTON_CC: 0xC0,
                FADER_CH: 0xC0,
                FADER_CC: 0x00,
                FADER9: 0x00
            }
        };

        // ============================================
        // STATE
        // ============================================
        
        let sysexData = null;
        let currentSetup = 1;
        let encoderGroup = 1;
        let faderGroup = 1;
        
        // Config structure
        let config = {
            setup: 1,
            groupNames: ['Grp1', 'Grp2', 'Grp3', 'Grp4', 'Grp5', 'Grp6', 'Grp7', 'Grp8'],
            encoders: {},    // [group][1-8] = {channel, cc, min, max, type, mode}
            pushbuttons: {}, // [group][1-8] = {channel, cc, type, mode}
            faders: {},      // [group][1-8] = {channel, cc, min, max, mode}
            buttons: {},     // [group][1-8] = {channel, cc, type, mode}
            fader9: {}       // [group] = {channel, cc, min, max, mode}
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        
        function initConfig() {
            for (let g = 1; g <= 8; g++) {
                config.encoders[g] = {};
                config.pushbuttons[g] = {};
                config.faders[g] = {};
                config.buttons[g] = {};
                
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = { channel: g, cc: 8 + (i-1) + (g-1)*8, min: 0, max: 127 };
                    config.pushbuttons[g][i] = { channel: g, cc: (i-1) + (g-1)*8, type: 'note', mode: 'momentary' };
                    config.faders[g][i] = { channel: g, cc: 32 + (i-1) + (g-1)*8, min: 0, max: 127 };
                    config.buttons[g][i] = { channel: g, cc: 64 + (i-1), type: 'note', mode: 'momentary' };
                }
                
                config.fader9[g] = { channel: g, cc: 112, min: 0, max: 127, mode: 'jump' };
            }
        }

        // ============================================
        // SYSEX PARSING
        // ============================================
        
        function findSectionBank(buf, secId, bank) {
            for (let i = 0; i < buf.length - 200; i++) {
                if (buf[i] === 0x49 && (i === 0 || buf[i-1] !== 0x4D)) {
                    const sec = ((buf[i+1] & 0x0F) << 4) | (buf[i+2] & 0x0F);
                    if (sec === secId && buf[i+3] === 0x4A) {
                        const bnk = ((buf[i+4] & 0x0F) << 4) | (buf[i+5] & 0x0F);
                        if (bnk === bank) return i + 6;
                    }
                }
            }
            return -1;
        }

        function decodeValue(buf, offset, idx) {
            const pos = offset + idx * 3;
            if (buf[pos] !== 0x4D) return 0;
            return ((buf[pos+1] & 0x0F) << 4) | (buf[pos+2] & 0x0F);
        }

        function encodeValue(buf, offset, idx, value) {
            const pos = offset + idx * 3;
            buf[pos + 1] = 0x20 | ((value >> 4) & 0x0F);
            buf[pos + 2] = 0x10 | (value & 0x0F);
        }

        function recalcBankChecksum(buf, dataStart) {
            let sum = 0;
            let pos = dataStart;
            while (buf[pos] === 0x4D) {
                sum += ((buf[pos+1] & 0x0F) << 4) | (buf[pos+2] & 0x0F);
                pos += 3;
            }
            if (buf[pos] === 0x4B && buf[pos+3] === 0x4C) {
                buf[pos + 1] = 0x20 | ((sum >> 12) & 0x0F);
                buf[pos + 2] = 0x10 | ((sum >> 8) & 0x0F);
                buf[pos + 4] = 0x20 | ((sum >> 4) & 0x0F);
                buf[pos + 5] = 0x10 | (sum & 0x0F);
            }
        }

        function parseSysExToConfig() {
            if (!sysexData) return;
            
            // Parse Encoder channels
            let offset = findSectionBank(sysexData, UC4.SECTIONS.ENCODER_CH, UC4.BANKS.ENCODER_CH);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        config.encoders[g][i].channel = decodeValue(sysexData, offset, (g-1)*8 + (i-1)) + 1;
                    }
                }
            }
            
            // Parse Encoder CCs
            offset = findSectionBank(sysexData, UC4.SECTIONS.ENCODER_CC, UC4.BANKS.ENCODER_CC);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        config.encoders[g][i].cc = decodeValue(sysexData, offset, (g-1)*8 + (i-1));
                    }
                }
            }
            
            // Parse Push Button channels
            offset = findSectionBank(sysexData, UC4.SECTIONS.PUSHBTN_CH, UC4.BANKS.PUSHBTN_CH);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        const val = decodeValue(sysexData, offset, (g-1)*8 + (i-1));
                        config.pushbuttons[g][i].channel = (val & 0x0F) + 1;
                        config.pushbuttons[g][i].type = (val & 0x20) ? 'cc' : 'note';
                    }
                }
            }
            
            // Parse Push Button CCs
            offset = findSectionBank(sysexData, UC4.SECTIONS.PUSHBTN_CC, UC4.BANKS.PUSHBTN_CC);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        config.pushbuttons[g][i].cc = decodeValue(sysexData, offset, (g-1)*8 + (i-1));
                    }
                }
            }
            
            // Parse Button channels
            offset = findSectionBank(sysexData, UC4.SECTIONS.BUTTON_CH, UC4.BANKS.BUTTON_CH);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        const val = decodeValue(sysexData, offset, (g-1)*8 + (i-1));
                        config.buttons[g][i].channel = (val & 0x0F) + 1;
                        config.buttons[g][i].type = (val & 0x20) ? 'cc' : 'note';
                    }
                }
            }
            
            // Parse Button CCs
            offset = findSectionBank(sysexData, UC4.SECTIONS.BUTTON_CC, UC4.BANKS.BUTTON_CC);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        config.buttons[g][i].cc = decodeValue(sysexData, offset, (g-1)*8 + (i-1));
                    }
                }
            }
            
            // Parse Fader channels
            offset = findSectionBank(sysexData, UC4.SECTIONS.FADER_CH, UC4.BANKS.FADER_CH);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        config.faders[g][i].channel = decodeValue(sysexData, offset, (g-1)*8 + (i-1)) + 1;
                    }
                }
            }
            
            // Parse Fader CCs
            offset = findSectionBank(sysexData, UC4.SECTIONS.FADER_CC, UC4.BANKS.FADER_CC);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        config.faders[g][i].cc = decodeValue(sysexData, offset, (g-1)*8 + (i-1));
                    }
                }
            }
            
            // Parse Fader 9
            offset = findSectionBank(sysexData, UC4.SECTIONS.FADER9, UC4.BANKS.FADER9);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    const baseIdx = (g-1) * 5;
                    config.fader9[g].channel = decodeValue(sysexData, offset, baseIdx) + 1;
                    config.fader9[g].cc = decodeValue(sysexData, offset, baseIdx + 1);
                    config.fader9[g].min = decodeValue(sysexData, offset, baseIdx + 2);
                    config.fader9[g].max = decodeValue(sysexData, offset, baseIdx + 3);
                }
            }
        }

        function configToSysEx() {
            if (!sysexData) {
                showStatus('Load a SysEx file first!', true);
                return null;
            }
            
            const buf = new Uint8Array(sysexData);
            
            // Write Encoder channels
            let offset = findSectionBank(buf, UC4.SECTIONS.ENCODER_CH, UC4.BANKS.ENCODER_CH);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        encodeValue(buf, offset, (g-1)*8 + (i-1), config.encoders[g][i].channel - 1);
                    }
                }
                recalcBankChecksum(buf, offset);
            }
            
            // Write Encoder CCs
            offset = findSectionBank(buf, UC4.SECTIONS.ENCODER_CC, UC4.BANKS.ENCODER_CC);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        encodeValue(buf, offset, (g-1)*8 + (i-1), config.encoders[g][i].cc);
                    }
                }
                recalcBankChecksum(buf, offset);
            }
            
            // Write Push Button channels
            offset = findSectionBank(buf, UC4.SECTIONS.PUSHBTN_CH, UC4.BANKS.PUSHBTN_CH);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        const pb = config.pushbuttons[g][i];
                        const val = (pb.type === 'cc' ? 0x20 : 0x10) + (pb.channel - 1);
                        encodeValue(buf, offset, (g-1)*8 + (i-1), val);
                    }
                }
                recalcBankChecksum(buf, offset);
            }
            
            // Write Push Button CCs
            offset = findSectionBank(buf, UC4.SECTIONS.PUSHBTN_CC, UC4.BANKS.PUSHBTN_CC);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        encodeValue(buf, offset, (g-1)*8 + (i-1), config.pushbuttons[g][i].cc);
                    }
                }
                recalcBankChecksum(buf, offset);
            }
            
            // Write Button channels
            offset = findSectionBank(buf, UC4.SECTIONS.BUTTON_CH, UC4.BANKS.BUTTON_CH);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        const btn = config.buttons[g][i];
                        const val = (btn.type === 'cc' ? 0x20 : 0x10) + (btn.channel - 1);
                        encodeValue(buf, offset, (g-1)*8 + (i-1), val);
                    }
                }
                recalcBankChecksum(buf, offset);
            }
            
            // Write Button CCs
            offset = findSectionBank(buf, UC4.SECTIONS.BUTTON_CC, UC4.BANKS.BUTTON_CC);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        encodeValue(buf, offset, (g-1)*8 + (i-1), config.buttons[g][i].cc);
                    }
                }
                recalcBankChecksum(buf, offset);
            }
            
            // Write Fader channels
            offset = findSectionBank(buf, UC4.SECTIONS.FADER_CH, UC4.BANKS.FADER_CH);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        encodeValue(buf, offset, (g-1)*8 + (i-1), config.faders[g][i].channel - 1);
                    }
                }
                recalcBankChecksum(buf, offset);
            }
            
            // Write Fader CCs
            offset = findSectionBank(buf, UC4.SECTIONS.FADER_CC, UC4.BANKS.FADER_CC);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    for (let i = 1; i <= 8; i++) {
                        encodeValue(buf, offset, (g-1)*8 + (i-1), config.faders[g][i].cc);
                    }
                }
                recalcBankChecksum(buf, offset);
            }
            
            // Write Fader 9
            offset = findSectionBank(buf, UC4.SECTIONS.FADER9, UC4.BANKS.FADER9);
            if (offset > 0) {
                for (let g = 1; g <= 8; g++) {
                    const baseIdx = (g-1) * 5;
                    encodeValue(buf, offset, baseIdx, config.fader9[g].channel - 1);
                    encodeValue(buf, offset, baseIdx + 1, config.fader9[g].cc);
                    encodeValue(buf, offset, baseIdx + 2, config.fader9[g].min);
                    encodeValue(buf, offset, baseIdx + 3, config.fader9[g].max);
                }
                recalcBankChecksum(buf, offset);
            }
            
            return buf;
        }

        // ============================================
        // FILE I/O
        // ============================================
        
        function importSysEx() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.syx';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const buffer = await file.arrayBuffer();
                sysexData = new Uint8Array(buffer);
                parseSysExToConfig();
                renderAll();
                updateSysExStatus();
                showStatus(`‚úî Loaded ${file.name} (${sysexData.length.toLocaleString()} bytes)`);
            };
            input.click();
        }

        function downloadSysEx() {
            const buf = configToSysEx();
            if (!buf) return;
            
            const blob = new Blob([buf], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UC4_Setup${config.setup}_patched.syx`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus(`‚úî Downloaded UC4_Setup${config.setup}_patched.syx`);
        }

        function exportJSON() {
            const data = {
                version: 5,
                protocol: 'Faderfox UC4 (verified)',
                exported: new Date().toISOString(),
                setup: config.setup,
                groupNames: config.groupNames,
                encoders: config.encoders,
                pushbuttons: config.pushbuttons,
                faders: config.faders,
                buttons: config.buttons,
                fader9: config.fader9
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UC4_Setup${config.setup}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus('‚úî JSON exported');
        }

        function showImportJSON() {
            document.getElementById('importTextarea').value = '';
            document.getElementById('importModal').classList.add('show');
        }

        function importJSON() {
            try {
                const data = JSON.parse(document.getElementById('importTextarea').value);
                if (data.encoders) config.encoders = data.encoders;
                if (data.pushbuttons) config.pushbuttons = data.pushbuttons;
                if (data.faders) config.faders = data.faders;
                if (data.buttons) config.buttons = data.buttons;
                if (data.fader9) config.fader9 = data.fader9;
                if (data.groupNames) config.groupNames = data.groupNames;
                closeModal('importModal');
                renderAll();
                showStatus('‚úî JSON imported');
            } catch (e) {
                showStatus('Invalid JSON: ' + e.message, true);
            }
        }

        // ============================================
        // TEMPLATES
        // ============================================
        
        // Factory defaults from UC4 manual
        const FACTORY_ENCODERS = [
            [8,9,10,11,12,13,14,15], [16,17,18,19,20,21,22,23],
            [24,25,26,27,28,29,30,31], [32,33,34,35,36,37,38,39],
            [72,73,74,75,76,77,78,79], [80,81,82,83,84,85,86,87],
            [88,89,90,91,92,93,94,95], [96,97,98,99,100,101,102,103]
        ];
        const FACTORY_FADERS = [
            [32,33,34,35,36,37,38,39,112], [40,41,42,43,44,45,46,47,112],
            [48,49,50,51,52,53,54,55,112], [56,57,58,59,60,61,62,63,112],
            [104,105,106,107,108,109,110,111,112], [104,105,106,107,108,109,110,111,112],
            [104,105,106,107,108,109,110,111,112], [104,105,106,107,108,109,110,111,112]
        ];
        const FACTORY_BUTTONS = [
            [64,65,66,67,68,69,70,71], [72,73,74,75,76,77,78,79],
            [80,81,82,83,84,85,86,87], [88,89,90,91,92,93,94,95],
            [96,97,98,99,100,101,102,103], [104,105,106,107,108,109,110,111],
            [112,113,114,115,116,117,118,119], [120,121,122,123,124,125,126,127]
        ];
        const FACTORY_PUSHBUTTONS = [
            [0,1,2,3,4,5,6,7], [8,9,10,11,12,13,14,15],
            [16,17,18,19,20,21,22,23], [24,25,26,27,28,29,30,31],
            [32,33,34,35,36,37,38,39], [40,41,42,43,44,45,46,47],
            [48,49,50,51,52,53,54,55], [56,57,58,59,60,61,62,63]
        ];

        function showTemplates() {
            document.getElementById('templatesModal').classList.add('show');
        }

        function loadTemplate(name) {
            closeModal('templatesModal');
            
            switch(name) {
                case 'noiseEngine':
                    const encoderCCs = [10, 72, 75, 80, 20, 21, 22, 23];
                    const faderCCs = [7, 71, 73, 74, 76, 77, 78, 79];
                    const pushBtnCCs = [64, 65, 66, 67, 68, 69, 70, 71];
                    const buttonCCs = [80, 81, 82, 83, 84, 85, 86, 87];
                    
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { channel: g, cc: encoderCCs[i-1], min: 0, max: 127, type: 'ccabs', mode: 'acc2' };
                            config.pushbuttons[g][i] = { channel: g, cc: pushBtnCCs[i-1], type: 'cc', mode: 'momentary', lower: 0, upper: 127 };
                            config.faders[g][i] = { channel: g, cc: faderCCs[i-1], min: 0, max: 127, mode: 'snap' };
                            config.buttons[g][i] = { channel: g, cc: buttonCCs[i-1], type: 'cc', mode: 'toggle', lower: 0, upper: 127 };
                        }
                        config.fader9[g] = { channel: g, cc: 11, min: 0, max: 127, mode: 'snap' };
                    }
                    config.groupNames = ['Ch1', 'Ch2', 'Ch3', 'Ch4', 'Ch5', 'Ch6', 'Ch7', 'Ch8'];
                    break;
                    
                case 'channelPerGroup':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { channel: g, cc: 10 + i - 1, min: 0, max: 127, type: 'ccabs', mode: 'acc3' };
                            config.pushbuttons[g][i] = { channel: g, cc: 30 + i - 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.faders[g][i] = { channel: g, cc: i - 1, min: 0, max: 127, mode: 'jump' };
                            config.buttons[g][i] = { channel: g, cc: 20 + i - 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                        config.fader9[g] = { channel: g, cc: 7, min: 0, max: 127, mode: 'jump' };
                    }
                    break;
                    
                case 'dawMixer':
                    for (let g = 1; g <= 8; g++) {
                        const offset = (g - 1) * 17;
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { channel: 1, cc: offset + 9 + i - 1, min: 0, max: 127, type: 'ccabs', mode: 'acc3' };
                            config.pushbuttons[g][i] = { channel: 2, cc: offset + 9 + i - 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.faders[g][i] = { channel: 1, cc: offset + i - 1, min: 0, max: 127, mode: 'jump' };
                            config.buttons[g][i] = { channel: 2, cc: offset + i - 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                        config.fader9[g] = { channel: 1, cc: offset + 8, min: 0, max: 127, mode: 'jump' };
                    }
                    break;
                    
                case 'multiSynth':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { channel: g, cc: 70 + i - 1, min: 0, max: 127, type: 'ccabs', mode: 'acc3' };
                            config.pushbuttons[g][i] = { channel: g, cc: 90 + i - 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.faders[g][i] = { channel: g, cc: i - 1, min: 0, max: 127, mode: 'jump' };
                            config.buttons[g][i] = { channel: g, cc: 80 + i - 1, type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                        config.fader9[g] = { channel: g, cc: 7, min: 0, max: 127, mode: 'jump' };
                    }
                    break;
                    
                case 'factory':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { channel: config.setup, cc: FACTORY_ENCODERS[g-1][i-1], min: 0, max: 127, type: 'ccabs', mode: 'acc3' };
                            config.pushbuttons[g][i] = { channel: config.setup, cc: FACTORY_PUSHBUTTONS[g-1][i-1], type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                            config.faders[g][i] = { channel: config.setup, cc: FACTORY_FADERS[g-1][i-1], min: 0, max: 127, mode: 'jump' };
                            config.buttons[g][i] = { channel: config.setup, cc: FACTORY_BUTTONS[g-1][i-1], type: 'note', mode: 'momentary', lower: 0, upper: 127 };
                        }
                        config.fader9[g] = { channel: config.setup, cc: 112, min: 0, max: 127, mode: 'jump' };
                    }
                    config.groupNames = ['Grp1', 'Grp2', 'Grp3', 'Grp4', 'Grp5', 'Grp6', 'Grp7', 'Grp8'];
                    break;
                    
                case 'blank':
                    for (let g = 1; g <= 8; g++) {
                        for (let i = 1; i <= 8; i++) {
                            config.encoders[g][i] = { channel: 1, cc: 0, min: 0, max: 127, type: 'ccabs', mode: 'acc3' };
                            config.pushbuttons[g][i] = { channel: 1, cc: 0, type: 'cc', mode: 'momentary', lower: 0, upper: 127 };
                            config.faders[g][i] = { channel: 1, cc: 0, min: 0, max: 127, mode: 'jump' };
                            config.buttons[g][i] = { channel: 1, cc: 0, type: 'cc', mode: 'momentary', lower: 0, upper: 127 };
                        }
                        config.fader9[g] = { channel: 1, cc: 0, min: 0, max: 127, mode: 'jump' };
                    }
                    break;
            }
            
            renderAll();
            showStatus(`‚úî Loaded ${name} template`);
        }

        // ============================================
        // VALIDATION
        // ============================================
        
        function detectConflicts() {
            const conflicts = [];
            const ccMap = new Map();
            
            // Check within each group type separately
            for (let g = 1; g <= 8; g++) {
                // Encoders + Push buttons (same group system)
                for (let i = 1; i <= 8; i++) {
                    const e = config.encoders[g][i];
                    const key = `enc-${g}-${e.channel}-${e.cc}`;
                    if (!ccMap.has(key)) ccMap.set(key, []);
                    ccMap.get(key).push({ type: 'Encoder', group: g, num: i });
                    
                    const p = config.pushbuttons[g][i];
                    if (p.type === 'cc') {
                        const pkey = `enc-${g}-${p.channel}-${p.cc}`;
                        if (!ccMap.has(pkey)) ccMap.set(pkey, []);
                        ccMap.get(pkey).push({ type: 'PushBtn', group: g, num: i });
                    }
                }
                
                // Faders + Buttons (same group system)
                for (let i = 1; i <= 8; i++) {
                    const f = config.faders[g][i];
                    const fkey = `fad-${g}-${f.channel}-${f.cc}`;
                    if (!ccMap.has(fkey)) ccMap.set(fkey, []);
                    ccMap.get(fkey).push({ type: 'Fader', group: g, num: i });
                    
                    const b = config.buttons[g][i];
                    if (b.type === 'cc') {
                        const bkey = `fad-${g}-${b.channel}-${b.cc}`;
                        if (!ccMap.has(bkey)) ccMap.set(bkey, []);
                        ccMap.get(bkey).push({ type: 'Button', group: g, num: i });
                    }
                }
                
                // Fader 9
                const f9 = config.fader9[g];
                const f9key = `fad-${g}-${f9.channel}-${f9.cc}`;
                if (!ccMap.has(f9key)) ccMap.set(f9key, []);
                ccMap.get(f9key).push({ type: 'Fader9', group: g, num: 9 });
            }
            
            for (const [key, locations] of ccMap) {
                if (locations.length > 1) {
                    const parts = key.split('-');
                    conflicts.push({ 
                        groupType: parts[0],
                        group: parseInt(parts[1]),
                        channel: parseInt(parts[2]), 
                        cc: parseInt(parts[3]), 
                        locations 
                    });
                }
            }
            
            return conflicts;
        }

        function showValidation() {
            const conflicts = detectConflicts();
            let html = '';
            
            if (conflicts.length === 0) {
                html = '<div style="color: var(--accent-primary); padding: 1rem; text-align: center;">‚úî No conflicts detected</div>';
            } else {
                html = `<div style="color: var(--accent-red); margin-bottom: 1rem;">‚õî ${conflicts.length} conflict(s) found</div>`;
                html += '<div style="font-size: 0.8rem;">';
                for (const c of conflicts) {
                    const locs = c.locations.map(l => `${l.type} ${l.num}`).join(', ');
                    html += `<div style="padding: 0.5rem; background: var(--bg-card); margin-bottom: 0.5rem; border-radius: 4px;">
                        <strong>Ch${c.channel} CC${c.cc}</strong> (${c.groupType === 'enc' ? 'Encoder' : 'Fader'} Group ${c.group})<br>
                        <span style="color: var(--text-secondary);">${locs}</span>
                    </div>`;
                }
                html += '</div>';
            }
            
            document.getElementById('validationReport').innerHTML = html;
            document.getElementById('validationModal').classList.add('show');
        }

        function updateValidationBar() {
            const conflicts = detectConflicts();
            const bar = document.getElementById('validationBar');
            
            if (conflicts.length === 0) {
                bar.innerHTML = '<div class="validation-item ok">‚úî No conflicts</div>';
                if (sysexData) {
                    bar.innerHTML += `<div class="validation-item ok">‚úî SysEx loaded (${sysexData.length.toLocaleString()} bytes)</div>`;
                } else {
                    bar.innerHTML += '<div class="validation-item warning">‚ö† No SysEx loaded</div>';
                }
            } else {
                bar.innerHTML = `<div class="validation-item error">‚õî ${conflicts.length} conflict(s)</div>`;
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        
        function renderGroupSelector(containerId, currentGroup, callback) {
            const container = document.getElementById(containerId);
            let html = '';
            for (let g = 1; g <= 8; g++) {
                html += `<button class="group-btn ${g === currentGroup ? 'active' : ''}" 
                         onclick="${callback}(${g})">${g}</button>`;
            }
            container.innerHTML = html;
        }

        function renderEncoderCards() {
            renderGroupSelector('encoderGroupSelector', encoderGroup, 'setEncoderGroup');
            document.getElementById('groupName').value = config.groupNames[encoderGroup - 1] || '';
            
            let html = '';
            for (let i = 1; i <= 8; i++) {
                const e = config.encoders[encoderGroup][i];
                html += `
                <div class="control-card">
                    <div class="control-card-header">
                        <span class="control-card-name">Encoder ${i}</span>
                    </div>
                    <div class="control-card-row">
                        <div class="control-field">
                            <label>Channel</label>
                            <input type="number" min="1" max="16" value="${e.channel}" 
                                   onchange="updateControl('encoders', ${encoderGroup}, ${i}, 'channel', this.value)">
                        </div>
                        <div class="control-field">
                            <label>CC</label>
                            <input type="number" min="0" max="127" value="${e.cc}"
                                   onchange="updateControl('encoders', ${encoderGroup}, ${i}, 'cc', this.value)">
                        </div>
                    </div>
                </div>`;
            }
            document.getElementById('encoderCards').innerHTML = html;
            
            // Push buttons
            html = '';
            for (let i = 1; i <= 8; i++) {
                const p = config.pushbuttons[encoderGroup][i];
                html += `
                <div class="control-card">
                    <div class="control-card-header">
                        <span class="control-card-name">Push ${i}</span>
                    </div>
                    <div class="control-card-row">
                        <div class="control-field">
                            <label>Channel</label>
                            <input type="number" min="1" max="16" value="${p.channel}"
                                   onchange="updateControl('pushbuttons', ${encoderGroup}, ${i}, 'channel', this.value)">
                        </div>
                        <div class="control-field">
                            <label>CC/Note</label>
                            <input type="number" min="0" max="127" value="${p.cc}"
                                   onchange="updateControl('pushbuttons', ${encoderGroup}, ${i}, 'cc', this.value)">
                        </div>
                        <div class="control-field">
                            <label>Type</label>
                            <select onchange="updateControl('pushbuttons', ${encoderGroup}, ${i}, 'type', this.value)">
                                <option value="cc" ${p.type === 'cc' ? 'selected' : ''}>CC</option>
                                <option value="note" ${p.type === 'note' ? 'selected' : ''}>Note</option>
                            </select>
                        </div>
                    </div>
                </div>`;
            }
            document.getElementById('pushButtonCards').innerHTML = html;
        }

        function renderFaderCards() {
            renderGroupSelector('faderGroupSelector', faderGroup, 'setFaderGroup');
            
            let html = '';
            for (let i = 1; i <= 8; i++) {
                const f = config.faders[faderGroup][i];
                html += `
                <div class="control-card">
                    <div class="control-card-header">
                        <span class="control-card-name">Fader ${i}</span>
                    </div>
                    <div class="control-card-row">
                        <div class="control-field">
                            <label>Channel</label>
                            <input type="number" min="1" max="16" value="${f.channel}"
                                   onchange="updateControl('faders', ${faderGroup}, ${i}, 'channel', this.value)">
                        </div>
                        <div class="control-field">
                            <label>CC</label>
                            <input type="number" min="0" max="127" value="${f.cc}"
                                   onchange="updateControl('faders', ${faderGroup}, ${i}, 'cc', this.value)">
                        </div>
                    </div>
                </div>`;
            }
            document.getElementById('faderCards').innerHTML = html;
            
            // Buttons
            html = '';
            for (let i = 1; i <= 8; i++) {
                const b = config.buttons[faderGroup][i];
                html += `
                <div class="control-card">
                    <div class="control-card-header">
                        <span class="control-card-name">Button ${i}</span>
                    </div>
                    <div class="control-card-row">
                        <div class="control-field">
                            <label>Channel</label>
                            <input type="number" min="1" max="16" value="${b.channel}"
                                   onchange="updateControl('buttons', ${faderGroup}, ${i}, 'channel', this.value)">
                        </div>
                        <div class="control-field">
                            <label>CC/Note</label>
                            <input type="number" min="0" max="127" value="${b.cc}"
                                   onchange="updateControl('buttons', ${faderGroup}, ${i}, 'cc', this.value)">
                        </div>
                        <div class="control-field">
                            <label>Type</label>
                            <select onchange="updateControl('buttons', ${faderGroup}, ${i}, 'type', this.value)">
                                <option value="cc" ${b.type === 'cc' ? 'selected' : ''}>CC</option>
                                <option value="note" ${b.type === 'note' ? 'selected' : ''}>Note</option>
                            </select>
                        </div>
                    </div>
                </div>`;
            }
            document.getElementById('buttonCards').innerHTML = html;
        }

        function renderFader9() {
            let html = '';
            for (let g = 1; g <= 8; g++) {
                const f9 = config.fader9[g];
                html += `
                <div class="fader9-item">
                    <div class="grp">Group ${g}</div>
                    <div class="control-field" style="margin-bottom: 0.25rem;">
                        <label>Ch</label>
                        <input type="number" min="1" max="16" value="${f9.channel}"
                               onchange="updateFader9(${g}, 'channel', this.value)">
                    </div>
                    <div class="control-field">
                        <label>CC</label>
                        <input type="number" min="0" max="127" value="${f9.cc}"
                               onchange="updateFader9(${g}, 'cc', this.value)">
                    </div>
                </div>`;
            }
            document.getElementById('fader9Grid').innerHTML = html;
        }

        function renderAllView() {
            const conflicts = detectConflicts();
            const conflictSet = new Set();
            for (const c of conflicts) {
                for (const l of c.locations) {
                    conflictSet.add(`${l.type}-${c.group}-${l.num}`);
                }
            }
            
            // Encoders
            let html = '<div class="header"></div>';
            for (let i = 1; i <= 8; i++) html += `<div class="header">E${i}</div>`;
            for (let g = 1; g <= 8; g++) {
                html += `<div class="row-header">G${g}</div>`;
                for (let i = 1; i <= 8; i++) {
                    const e = config.encoders[g][i];
                    const isConflict = conflictSet.has(`Encoder-${g}-${i}`);
                    html += `<div class="cell${isConflict ? ' conflict' : ''}" 
                             onclick="setEncoderGroup(${g})">${e.channel}/${e.cc}</div>`;
                }
            }
            document.getElementById('allEncoders').innerHTML = html;
            
            // Push Buttons
            html = '<div class="header"></div>';
            for (let i = 1; i <= 8; i++) html += `<div class="header">P${i}</div>`;
            for (let g = 1; g <= 8; g++) {
                html += `<div class="row-header">G${g}</div>`;
                for (let i = 1; i <= 8; i++) {
                    const p = config.pushbuttons[g][i];
                    const isConflict = conflictSet.has(`PushBtn-${g}-${i}`);
                    html += `<div class="cell${isConflict ? ' conflict' : ''}"
                             onclick="setEncoderGroup(${g})">${p.channel}/${p.cc}</div>`;
                }
            }
            document.getElementById('allPushButtons').innerHTML = html;
            
            // Faders
            html = '<div class="header"></div>';
            for (let i = 1; i <= 8; i++) html += `<div class="header">F${i}</div>`;
            for (let g = 1; g <= 8; g++) {
                html += `<div class="row-header">G${g}</div>`;
                for (let i = 1; i <= 8; i++) {
                    const f = config.faders[g][i];
                    const isConflict = conflictSet.has(`Fader-${g}-${i}`);
                    html += `<div class="cell${isConflict ? ' conflict' : ''}"
                             onclick="setFaderGroup(${g})">${f.channel}/${f.cc}</div>`;
                }
            }
            document.getElementById('allFaders').innerHTML = html;
            
            // Buttons
            html = '<div class="header"></div>';
            for (let i = 1; i <= 8; i++) html += `<div class="header">B${i}</div>`;
            for (let g = 1; g <= 8; g++) {
                html += `<div class="row-header">G${g}</div>`;
                for (let i = 1; i <= 8; i++) {
                    const b = config.buttons[g][i];
                    const isConflict = conflictSet.has(`Button-${g}-${i}`);
                    html += `<div class="cell${isConflict ? ' conflict' : ''}"
                             onclick="setFaderGroup(${g})">${b.channel}/${b.cc}</div>`;
                }
            }
            document.getElementById('allButtons').innerHTML = html;
            
            // Fader 9
            html = '<div class="header"></div>';
            for (let g = 1; g <= 8; g++) html += `<div class="header">G${g}</div>`;
            html += '<div class="row-header">F9</div>';
            for (let g = 1; g <= 8; g++) {
                const f9 = config.fader9[g];
                const isConflict = conflictSet.has(`Fader9-${g}-9`);
                html += `<div class="cell${isConflict ? ' conflict' : ''}">${f9.channel}/${f9.cc}</div>`;
            }
            document.getElementById('allFader9').innerHTML = html;
        }

        function renderAll() {
            renderEncoderCards();
            renderFaderCards();
            renderFader9();
            renderAllView();
            updateValidationBar();
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        
        function setView(view) {
            document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'all') {
                document.getElementById('focusedView').classList.add('hidden');
                document.getElementById('allView').classList.add('active');
            } else {
                document.getElementById('focusedView').classList.remove('hidden');
                document.getElementById('allView').classList.remove('active');
            }
        }

        function setEncoderGroup(g) {
            encoderGroup = g;
            renderEncoderCards();
            setView('focused');
        }

        function setFaderGroup(g) {
            faderGroup = g;
            renderFaderCards();
            setView('focused');
        }

        function updateControl(type, group, num, prop, value) {
            if (prop === 'channel' || prop === 'cc' || prop === 'min' || prop === 'max') {
                value = parseInt(value) || 0;
            }
            config[type][group][num][prop] = value;
            renderAllView();
            updateValidationBar();
        }

        function updateFader9(group, prop, value) {
            if (prop === 'channel' || prop === 'cc') {
                value = parseInt(value) || 0;
            }
            config.fader9[group][prop] = value;
            renderAllView();
            updateValidationBar();
        }

        function updateGroupName() {
            config.groupNames[encoderGroup - 1] = document.getElementById('groupName').value;
        }

        function changeSetup() {
            config.setup = parseInt(document.getElementById('setupSelect').value);
            showStatus(`Setup ${config.setup} selected`);
        }

        function showCopyModal() {
            document.getElementById('copyModal').classList.add('show');
        }

        function applyCopy() {
            const fromGroup = parseInt(document.getElementById('copyFrom').value);
            const what = document.getElementById('copyWhat').value;
            const target = document.getElementById('copyTarget').value;
            
            const types = target === 'all' ? ['encoders', 'pushbuttons', 'faders', 'buttons'] : [target];
            
            for (let g = 1; g <= 8; g++) {
                if (g === fromGroup) continue;
                
                for (const type of types) {
                    for (let i = 1; i <= 8; i++) {
                        if (what === 'cc' || what === 'both') {
                            config[type][g][i].cc = config[type][fromGroup][i].cc;
                        }
                        if (what === 'channel' || what === 'both') {
                            config[type][g][i].channel = config[type][fromGroup][i].channel;
                        }
                    }
                }
            }
            
            closeModal('copyModal');
            renderAll();
            showStatus('Settings copied');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function showStatus(msg, isError = false) {
            const toast = document.getElementById('statusToast');
            toast.textContent = msg;
            toast.className = 'status-toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleProtocol() {
            const content = document.getElementById('protocolContent');
            const toggle = document.getElementById('protocolToggle');
            content.classList.toggle('show');
            toggle.textContent = content.classList.contains('show') ? '‚ùå Hide' : '‚ñ∂ Show';
        }

        function updateSysExStatus() {
            const indicator = document.getElementById('sysexIndicator');
            const info = document.getElementById('sysexInfo');
            
            if (sysexData) {
                indicator.classList.add('loaded');
                const setupCount = sysexData.length > 50000 ? '18 setups' : '1 setup';
                info.innerHTML = `
                    <strong>‚úî UC4 backup loaded</strong><br>
                    <span class="details">${sysexData.length.toLocaleString()} bytes | ${setupCount} | Ready for editing</span>
                `;
            } else {
                indicator.classList.remove('loaded');
                info.innerHTML = `
                    <strong>No SysEx template loaded</strong><br>
                    <span class="details">Load your UC4 backup .syx file to enable editing</span>
                `;
            }
        }

        function clearAll() {
            if (!confirm('Clear all CC assignments to 0?')) return;
            
            for (let g = 1; g <= 8; g++) {
                for (let i = 1; i <= 8; i++) {
                    config.encoders[g][i] = { channel: 1, cc: 0, min: 0, max: 127, type: 'ccabs', mode: 'acc3' };
                    config.pushbuttons[g][i] = { channel: 1, cc: 0, type: 'cc', mode: 'momentary', lower: 0, upper: 127 };
                    config.faders[g][i] = { channel: 1, cc: 0, min: 0, max: 127, mode: 'jump' };
                    config.buttons[g][i] = { channel: 1, cc: 0, type: 'cc', mode: 'momentary', lower: 0, upper: 127 };
                }
                config.fader9[g] = { channel: 1, cc: 0, min: 0, max: 127, mode: 'jump' };
            }
            renderAll();
            showStatus('All CCs cleared');
        }

        function updateGroupChannel(group, channel) {
            const ch = parseInt(channel) || 1;
            for (let i = 1; i <= 8; i++) {
                config.encoders[group][i].channel = ch;
                config.pushbuttons[group][i].channel = ch;
                config.faders[group][i].channel = ch;
                config.buttons[group][i].channel = ch;
            }
            config.fader9[group].channel = ch;
            renderAll();
            showStatus(`Group ${group} set to Ch ${ch}`);
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('show');
            });
        });

        // ============================================
        // INIT
        // ============================================
        
        const FACTORY_SYSEX_URL = 'https://raw.githubusercontent.com/thegdyne/uc4-sysex-editor/main/factory_default.syx';
        
        async function loadFactorySysEx() {
            try {
                const response = await fetch(FACTORY_SYSEX_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const buffer = await response.arrayBuffer();
                sysexData = new Uint8Array(buffer);
                parseSysExToConfig();
                renderAll();
                console.log(`‚úî Loaded factory default (${sysexData.length.toLocaleString()} bytes)`);
            } catch (err) {
                console.error('Failed to load factory SysEx:', err);
                showStatus('‚ö† Could not load factory default', true);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initConfig();
            renderAll();
            loadFactorySysEx();
        });
    </script>
</body>
</html>
